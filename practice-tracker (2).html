<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Practice Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* SOFT, PROFESSIONAL FONT */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

  :root {
    --bg: #f8fafc; --surface: #ffffff; --surface2: #f1f5f9;
    --border: #e2e8f0; --text: #1e293b; --text-muted: #64748b;
    --accent: #6366f1; --green: #10b981; --amber: #f59e0b;
    --radius: 12px;
  }

  [data-theme="dark"] {
    --bg: #0f172a; --surface: #1e293b; --surface2: #334155;
    --border: #475569; --text: #f8fafc; --text-muted: #94a3b8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; -webkit-font-smoothing: antialiased; }

  .app-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
  .nav-tabs { display: flex; gap: 0.25rem; overflow-x: auto; }
  .nav-btn { padding: 0.5rem 0.75rem; border: none; background: none; cursor: pointer; border-radius: 8px; font-weight: 500; color: var(--text-muted); white-space: nowrap; font-size: 0.85rem; }
  .nav-btn.active { background: var(--surface2); color: var(--accent); font-weight: 700; }

  .main { padding: 1rem; max-width: 800px; margin: 0 auto; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
  
  /* TRAJECTORY STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
  .stat-card { padding: 1rem; border-radius: var(--radius); background: var(--surface); border: 1px solid var(--border); }
  .stat-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.02em; margin-bottom: 0.25rem; }
  .stat-val { font-size: 1.25rem; font-weight: 700; color: var(--text); }

  /* STATUS BADGES */
  .badge { padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; }
  .badge-scheduled { background: #e0e7ff; color: #4338ca; }
  .badge-happened { background: #fef3c7; color: #b45309; }
  .badge-paid { background: #d1fae5; color: #065f46; }

  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; padding: 0.75rem; border-bottom: 1px solid var(--border); }
  td { padding: 0.85rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }

  .btn { padding: 0.6rem 1rem; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.15s; font-size: 0.85rem; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
  
  input, select { padding: 0.65rem; border-radius: 10px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); width: 100%; font-family: inherit; outline: none; }

  .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 0.75rem 1.5rem; border-radius: 50px; display: none; z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); cursor: pointer; font-weight: 600; }
  .toast.show { display: block; animation: slideUp 0.3s ease; }

  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn 0.2s ease; }

  @keyframes slideUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div id="app">
  <header class="app-header">
    <div class="nav-tabs">
      <button class="nav-btn active" onclick="switchTab('home')">Home</button>
      <button class="nav-btn" onclick="switchTab('sessions')">Sessions</button>
      <button class="nav-btn" onclick="switchTab('clients')">Clients</button>
      <button class="nav-btn" onclick="switchTab('cash')">Cash</button>
      <button class="nav-btn" onclick="switchTab('bank')">Bank</button>
      <button class="nav-btn" onclick="switchTab('records')">History</button>
    </div>
    <button onclick="toggleTheme()" style="background:none; border:none; cursor:pointer; font-size:1.1rem; opacity:0.7">üåì</button>
  </header>

  <main class="main">
    <div id="tab-home" class="tab-content active">
      <h2 style="margin-bottom:1rem; font-size:1.1rem; font-weight:700">Month Trajectory (85%)</h2>
      <div class="stats-grid" id="dash-stats"></div>
      <div class="card">
        <h3 style="font-size:0.8rem; text-transform:uppercase; color:var(--text-muted); margin-bottom:0.75rem">Projected Month End</h3>
        <div id="dash-summary" style="font-size:1rem; font-weight:700"></div>
      </div>
    </div>

    <div id="tab-sessions" class="tab-content">
      <div class="card">
        <h3 style="margin-bottom:1rem; font-size:1rem">New Session</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem; margin-bottom:0.5rem">
          <select id="s-client"></select>
          <input type="date" id="s-date">
        </div>
        <select id="s-status" style="margin-bottom:0.75rem">
          <option value="scheduled">Scheduled (Potential)</option>
          <option value="happened">Happened (Confirm)</option>
        </select>
        <button class="btn btn-primary" style="width:100%" onclick="addSession()">Log Session</button>
      </div>
      <div class="card" style="padding:0">
        <div id="sessions-list"></div>
      </div>
    </div>

    <div id="tab-clients" class="tab-content"><div class="card" id="clients-list"></div></div>
    <div id="tab-cash" class="tab-content"><div class="card" id="cash-list"></div></div>
    <div id="tab-bank" class="tab-content"><div class="card" id="bank-list"></div></div>
    <div id="tab-records" class="tab-content"><div class="card" id="records-list"></div></div>
  </main>
</div>

<div id="toast" class="toast" onclick="undoDelete()"></div>

<script>
let sb, clients=[], sessions=[], lastDeleted=null, undoTimer=null;
const VV_CUT = 0.15;
const NET = (gross) => Number(gross || 0) * (1 - VV_CUT);

async function initApp() {
    const url = localStorage.getItem('sb_url');
    const key = localStorage.getItem('sb_key');
    if(!url || !key) return;
    sb = supabase.createClient(url, key);
    loadData();
}

async function loadData() {
    const {data: c} = await sb.from('clients').select('*').order('name');
    clients = c || [];
    const {data: s} = await sb.from('sessions').select('*').order('date', {ascending:false});
    sessions = s || [];
    renderAll();
}

function renderAll() {
    renderDashboard();
    renderSessions();
    populateClientSelect();
}

function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    event.currentTarget.classList.add('active');
}

function toggleTheme() {
    const cur = document.documentElement.getAttribute('data-theme');
    document.documentElement.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
}

function renderDashboard() {
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const monthSessions = sessions.filter(s => s.date >= startOfMonth);
    
    let received = 0, outstanding = 0, projected = 0;

    monthSessions.forEach(s => {
        const c = clients.find(cl => cl.id === s.client_id);
        if(!c) return;
        const netVal = NET(c.rate);

        if(s.status === 'paid' || s.paid) received += netVal;
        else if(s.status === 'happened') outstanding += netVal;
        else if(s.status === 'scheduled') projected += netVal;
    });

    document.getElementById('dash-stats').innerHTML = `
        <div class="stat-card">
            <div class="stat-label">Received</div>
            <div class="stat-val" style="color:var(--green)">‚Ç™${Math.round(received)}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Outstanding</div>
            <div class="stat-val" style="color:var(--amber)">‚Ç™${Math.round(outstanding)}</div>
        </div>
        <div class="stat-card" style="background:var(--surface2)">
            <div class="stat-label">Projected</div>
            <div class="stat-val">‚Ç™${Math.round(projected)}</div>
        </div>
    `;
    
    document.getElementById('dash-summary').innerHTML = `
        ‚Ç™${Math.round(received + outstanding + projected)}
    `;
}

function renderSessions() {
    let html = `<table><thead><tr><th>Date</th><th>Client</th><th>Status</th><th></th></tr></thead><tbody>`;
    sessions.slice(0, 20).forEach(s => {
        const c = clients.find(cl => cl.id === s.client_id);
        const status = s.status || (s.paid ? 'paid' : 'happened');
        const statusClass = 'badge-' + status;
        
        html += `<tr>
            <td style="color:var(--text-muted); font-size:0.8rem">${s.date.split('-').reverse().slice(0,2).join('/')}</td>
            <td><strong>${c?c.name:'?'}</strong></td>
            <td><span class="badge ${statusClass}">${status}</span></td>
            <td style="text-align:right">
                ${status === 'scheduled' ? `<button class="btn btn-ghost" style="padding:0.25rem 0.5rem" onclick="confirmSession('${s.id}')">‚úì</button>` : ''}
                <button class="btn btn-ghost" style="padding:0.25rem 0.5rem; color:var(--text-dim)" onclick="softDelete('${s.id}')">üóëÔ∏è</button>
            </td>
        </tr>`;
    });
    document.getElementById('sessions-list').innerHTML = html + `</tbody></table>`;
}

async function confirmSession(id) {
    await sb.from('sessions').update({ status: 'happened' }).eq('id', id);
    loadData();
}

async function addSession() {
    const client_id = document.getElementById('s-client').value;
    const date = document.getElementById('s-date').value;
    const status = document.getElementById('s-status').value;
    if(!client_id || !date) return;
    await sb.from('sessions').insert({ client_id, date, status });
    loadData();
}

function softDelete(id) {
    const s = sessions.find(x => x.id === id);
    lastDeleted = s;
    sessions = sessions.filter(x => x.id !== id);
    renderSessions();
    const t = document.getElementById('toast');
    t.innerHTML = `Deleted ‚Äî <b>Undo</b>`;
    t.classList.add('show');
    clearTimeout(undoTimer);
    undoTimer = setTimeout(async () => {
        t.classList.remove('show');
        if(lastDeleted) await sb.from('sessions').delete().eq('id', id);
        lastDeleted = null;
    }, 4500);
}

function undoDelete() {
    if(!lastDeleted) return;
    clearTimeout(undoTimer);
    sessions.push(lastDeleted);
    sessions.sort((a,b) => b.date.localeCompare(a.date));
    lastDeleted = null;
    document.getElementById('toast').classList.remove('show');
    renderSessions();
}

function populateClientSelect() {
    const el = document.getElementById('s-client');
    if(el) el.innerHTML = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

window.onload = initApp;
</script>
</body>
</html>
