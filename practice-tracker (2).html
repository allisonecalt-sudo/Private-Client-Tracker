<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Practice Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  :root {
    --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --text: #1e293b;
    --text-muted: #64748b; --accent: #6366f1; --green: #10b981; --amber: #f59e0b;
    --radius: 12px;
  }
  [data-theme="dark"] {
    --bg: #0f172a; --surface: #1e293b; --border: #475569; --text: #f8fafc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
  .app-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.8rem 1rem; display: flex; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .nav-tabs { display: flex; gap: 0.3rem; overflow-x: auto; }
  .nav-btn { padding: 0.5rem 0.8rem; border: none; background: none; cursor: pointer; border-radius: 8px; font-weight: 500; color: var(--text-muted); font-size: 0.85rem; }
  .nav-btn.active { background: #f1f5f9; color: var(--accent); font-weight: 700; }
  .main { padding: 1rem; max-width: 900px; margin: 0 auto; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1rem; }
  .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
  .stat-card { padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border); background: var(--surface); text-align: center; }
  .stat-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 0.3rem; }
  .stat-val { font-size: 1.3rem; font-weight: 700; }
  .month-nav { display: flex; align-items: center; justify-content: center; gap: 1.5rem; margin-bottom: 1.5rem; }
  .month-nav button { background: none; border: 1px solid var(--border); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; color: var(--text); font-weight: bold; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; padding: 0.8rem; border-bottom: 1px solid var(--border); }
  td { padding: 0.8rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
  .btn { padding: 0.6rem 1rem; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
  .btn-primary { background: var(--accent); color: white; }
  input, select { padding: 0.65rem; border-radius: 10px; border: 1px solid var(--border); background: #f1f5f9; width: 100%; outline: none; }
</style>
</head>
<body>
<div id="app">
  <header class="app-header">
    <div class="nav-tabs">
      <button class="nav-btn active" onclick="switchTab('home')">Home</button>
      <button class="nav-btn" onclick="switchTab('sessions')">Sessions</button>
      <button class="nav-btn" onclick="switchTab('clients')">Clients</button>
      <button class="nav-btn" onclick="switchTab('money')">Money</button>
      <button class="nav-btn" onclick="switchTab('history')">History</button>
    </div>
    <button onclick="toggleTheme()" style="background:none; border:none; cursor:pointer; font-size:1.1rem">üåì</button>
  </header>
  <main class="main">
    <div id="tab-home" class="tab-content active">
      <div class="month-nav">
        <button onclick="changeMonth(-1)">‚Üê</button>
        <h2 id="current-month-display" style="font-size: 1.2rem; min-width: 150px; text-align: center;"></h2>
        <button onclick="changeMonth(1)">‚Üí</button>
      </div>
      <div class="stats-grid" id="dash-stats"></div>
      <div class="card">
        <h3 style="font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem;">To-Do: Waiting for Payment</h3>
        <div id="dash-actions" style="font-size: 0.9rem;"></div>
      </div>
    </div>
    <div id="tab-sessions" class="tab-content" style="display:none">
      <div class="card">
        <h3>Log Session</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem; margin:0.8rem 0">
          <select id="s-client"></select>
          <input type="date" id="s-date">
        </div>
        <select id="s-status" style="margin-bottom:0.8rem">
          <option value="scheduled">Scheduled (Potential)</option>
          <option value="happened">Happened (Real)</option>
        </select>
        <button class="btn btn-primary" style="width:100%" onclick="addSession()">Log Session</button>
      </div>
      <div class="card" id="sessions-table"></div>
    </div>
  </main>
</div>
<script>
let sb, clients=[], sessions=[], viewDate = new Date();
const VV_CUT = 0.15;
const NET = (gross) => Number(gross || 0) * (1 - VV_CUT);

async function initApp() {
    const url = localStorage.getItem('sb_url'), key = localStorage.getItem('sb_key');
    if(!url || !key) return;
    sb = supabase.createClient(url, key);
    loadData();
}

async function loadData() {
    const {data: c} = await sb.from('clients').select('*');
    clients = c || [];
    const {data: s} = await sb.from('sessions').select('*');
    sessions = s || [];
    renderAll();
}

function renderAll() {
    renderDashboard();
    renderSessions();
    populateClientSelect();
}

function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-'+t).style.display = 'block';
    event.currentTarget.classList.add('active');
}

function changeMonth(dir) {
    viewDate.setMonth(viewDate.getMonth() + dir);
    renderDashboard();
}

function renderDashboard() {
    const monthStr = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    document.getElementById('current-month-display').textContent = monthStr;
    
    const year = viewDate.getFullYear(), month = viewDate.getMonth();
    const monthSessions = sessions.filter(s => {
        const d = new Date(s.date);
        return d.getFullYear() === year && d.getMonth() === month;
    });

    let received = 0, outstanding = 0, projected = 0;
    monthSessions.forEach(s => {
        const c = clients.find(cl => cl.id === s.client_id);
        if(!c) return;
        const val = NET(c.rate);
        if(s.status === 'paid') received += val;
        else if(s.status === 'happened') outstanding += val;
        else if(s.status === 'scheduled') projected += val;
    });

    document.getElementById('dash-stats').innerHTML = `
        <div class="stat-card"><div class="stat-label">Received</div><div class="stat-val" style="color:var(--green)">‚Ç™${Math.round(received)}</div></div>
        <div class="stat-card"><div class="stat-label">Outstanding</div><div class="stat-val" style="color:var(--amber)">‚Ç™${Math.round(outstanding)}</div></div>
        <div class="stat-card"><div class="stat-label">Projected</div><div class="stat-val">‚Ç™${Math.round(projected)}</div></div>`;
    
    const unpaid = sessions.filter(s => s.status === 'happened');
    document.getElementById('dash-actions').innerHTML = unpaid.length 
        ? `You have <b>${unpaid.length}</b> sessions total waiting for payment collection.`
        : `‚úÖ You are all caught up on payments!`;
}

function renderSessions() {
    let html = `<table><thead><tr><th>Date</th><th>Client</th><th>Status</th></tr></thead><tbody>`;
    sessions.slice(0, 15).forEach(s => {
        const c = clients.find(cl => cl.id === s.client_id);
        html += `<tr><td>${s.date.split('-').reverse().slice(0,2).join('/')}</td><td><b>${c?c.name:'?'}</b></td><td>${s.status}</td></tr>`;
    });
    document.getElementById('sessions-table').innerHTML = html + `</tbody></table>`;
}

async function addSession() {
    const client_id = document.getElementById('s-client').value, date = document.getElementById('s-date').value, status = document.getElementById('s-status').value;
    if(!client_id || !date) return;
    await sb.from('sessions').insert({ client_id, date, status });
    loadData();
}

function populateClientSelect() {
    document.getElementById('s-client').innerHTML = clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

window.onload = initApp;
</script>
</body>
</html>
