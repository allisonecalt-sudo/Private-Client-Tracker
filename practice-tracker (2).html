<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Practice Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f5f4f0;--surface:#fff;--surface2:#f0efeb;--surface3:#e8e7e2;
  --border:#dddbd4;--text:#1a1915;--text-muted:#6b6960;--text-dim:#a09e96;
  --accent:#2d6a4f;--accent-bright:#40916c;--accent-soft:rgba(45,106,79,.10);--accent-glow:rgba(45,106,79,.18);
  --green:#2d6a4f;--green-soft:rgba(45,106,79,.12);
  --amber:#b5621a;--amber-soft:rgba(181,98,26,.12);
  --red:#c0392b;--red-soft:rgba(192,57,43,.12);
  --blue:#1d5c8a;--blue-soft:rgba(29,92,138,.12);
  --shadow:0 2px 8px rgba(26,25,21,.08);--shadow-lg:0 8px 32px rgba(26,25,21,.12);
  --radius:10px;--radius-lg:16px;
}
[data-theme="dark"]{
  --bg:#0f0f0d;--surface:#1a1916;--surface2:#222220;--surface3:#2a2a27;
  --border:#333330;--text:#f0ede6;--text-muted:#7a7870;--text-dim:#4a4845;
  --accent:#52b788;--accent-bright:#74c69d;--accent-soft:rgba(82,183,136,.12);--accent-glow:rgba(82,183,136,.22);
  --green:#52b788;--green-soft:rgba(82,183,136,.12);
  --amber:#f4a261;--amber-soft:rgba(244,162,97,.12);
  --red:#e76f51;--red-soft:rgba(231,111,81,.12);
  --blue:#74b3ce;--blue-soft:rgba(116,179,206,.12);
  --shadow:0 2px 8px rgba(0,0,0,.3);--shadow-lg:0 8px 32px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;-webkit-font-smoothing:antialiased;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* APP SHELL */
#app{display:none;padding-bottom:80px;}
.app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:.8rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.header-left{display:flex;align-items:center;gap:1.25rem;}
.app-header h1{font-size:1rem;font-weight:700;letter-spacing:-.01em;}
.header-tabs{display:flex;gap:.15rem;}
.htab{padding:.4rem .85rem;border:none;background:none;cursor:pointer;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;color:var(--text-muted);transition:all .15s;}
.htab:hover{background:var(--surface2);color:var(--text);}
.htab.active{background:var(--accent-soft);color:var(--accent);font-weight:600;}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:.4rem .25rem calc(.4rem + env(safe-area-inset-bottom));z-index:200;display:none;grid-template-columns:repeat(6,1fr);gap:.15rem;}
.bnav-btn{display:flex;flex-direction:column;align-items:center;gap:.2rem;padding:.45rem .15rem;border:none;background:none;cursor:pointer;border-radius:8px;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:.6rem;font-weight:500;transition:all .15s;-webkit-tap-highlight-color:transparent;}
.bnav-btn .ni{font-size:1.05rem;line-height:1;}
.bnav-btn.active{color:var(--accent);background:var(--accent-soft);}
.bnav-btn:active{transform:scale(.92);}
.main{padding:1.5rem;max-width:960px;margin:0 auto;}
.tab-content{display:none;}
.tab-content.active{display:block;animation:fadeIn .18s ease;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.5rem;margin-bottom:1rem;box-shadow:var(--shadow);}
.card-sm{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1rem 1.25rem;margin-bottom:.75rem;box-shadow:var(--shadow);}
.card-title{font-size:.72rem;font-weight:600;margin-bottom:1rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;}
.section-header h2{font-size:1.25rem;font-weight:700;letter-spacing:-.01em;}
.section-divider{display:flex;align-items:center;gap:.75rem;margin:1.5rem 0 .75rem;}
.section-divider span{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);white-space:nowrap;}
.section-divider::before,.section-divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* STAT CARDS */
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem 1.25rem 1rem;box-shadow:var(--shadow);border-top:3px solid var(--border);}
.stat-card.green{border-top-color:var(--green);}
.stat-card.amber{border-top-color:var(--amber);}
.stat-card.blue{border-top-color:var(--blue);}
.stat-label{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--text-muted);margin-bottom:.5rem;}
.stat-value{font-family:'DM Mono',monospace;font-size:1.6rem;font-weight:500;line-height:1;}
.stat-sub{font-size:.68rem;color:var(--text-dim);margin-top:.4rem;}

/* FORMS */
.form-row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end;}
.form-group{display:flex;flex-direction:column;gap:.35rem;flex:1;min-width:130px;}
.form-group label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);}
select,input[type="date"],input[type="text"],input[type="number"]{padding:.6rem .85rem;border:1px solid var(--border);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:.875rem;background:var(--surface2);color:var(--text);outline:none;transition:border-color .2s,box-shadow .2s;width:100%;-webkit-appearance:none;}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='none'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b6960' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .85rem center;padding-right:2.2rem;}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}

/* BUTTONS */
.btn{padding:.6rem 1.15rem;border:none;border-radius:var(--radius);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.84rem;transition:all .15s;white-space:nowrap;display:inline-flex;align-items:center;gap:.35rem;}
.btn:active{transform:scale(.96);}
.btn-primary{background:var(--accent);color:white;}
.btn-primary:hover{background:var(--accent-bright);box-shadow:0 3px 12px var(--accent-glow);}
.btn-sm{padding:.32rem .7rem;font-size:.74rem;border-radius:7px;}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text-muted);}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:var(--red-soft);color:var(--red);border:none;}
.btn-danger:hover{background:rgba(192,57,43,.2);}
.btn-ghost{background:var(--surface2);color:var(--text-muted);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface3);color:var(--text);}
.btn-icon{background:none;border:none;cursor:pointer;padding:.3rem .4rem;border-radius:6px;font-size:1rem;line-height:1;color:var(--text-muted);transition:all .15s;}
.btn-icon:hover{background:var(--red-soft);color:var(--red);}
.btn-edit{background:none;border:none;cursor:pointer;padding:.3rem .4rem;border-radius:6px;font-size:.9rem;line-height:1;color:var(--text-muted);transition:all .15s;}
.btn-edit:hover{background:var(--blue-soft);color:var(--blue);}

/* TABLES */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.84rem;}
th{text-align:left;padding:.55rem .85rem;font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);border-bottom:1px solid var(--border);background:var(--surface2);}
td{padding:.75rem .85rem;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tbody tr{transition:background .1s;}
tbody tr:hover td{background:var(--surface2);}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:.2rem;padding:.18rem .55rem;border-radius:20px;font-size:.68rem;font-weight:600;white-space:nowrap;}
.badge-green{background:var(--green-soft);color:var(--green);}
.badge-amber{background:var(--amber-soft);color:var(--amber);}
.badge-cash{background:var(--blue-soft);color:var(--blue);}
.badge-bank{background:var(--accent-soft);color:var(--accent);}
.badge-grey{background:var(--surface3);color:var(--text-muted);}

/* TOGGLE */
.toggle-wrap{display:flex;align-items:center;gap:.5rem;}
.toggle{position:relative;width:34px;height:18px;cursor:pointer;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:20px;transition:.2s;}
.toggle-slider::before{content:'';position:absolute;width:12px;height:12px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s;}
.toggle input:checked+.toggle-slider{background:var(--green);}
.toggle input:checked+.toggle-slider::before{transform:translateX(16px);}

/* SESSION PICKER */
.session-picker{display:flex;flex-direction:column;gap:.35rem;max-height:240px;overflow-y:auto;padding:.5rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.75rem;}
.session-check-item{display:flex;align-items:center;gap:.65rem;padding:.55rem .7rem;background:var(--surface);border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:border-color .15s,background .15s;}
.session-check-item:hover{border-color:var(--accent);}
.session-check-item.selected{border-color:var(--accent);background:var(--accent-soft);}
.session-check-item input[type="checkbox"]{accent-color:var(--accent);width:15px;height:15px;flex-shrink:0;min-width:unset;padding:0;border:none;background:none;}

/* SUMMARY BOX */
.summary-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.9rem 1.1rem;display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:1rem;}
.summary-box .item{display:flex;flex-direction:column;gap:.2rem;}
.summary-box .item span:first-child{font-size:.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.07em;font-weight:600;}
.summary-box .item strong{font-size:1.05rem;font-family:'DM Mono',monospace;}

/* FILTER */
.filter-row{display:flex;gap:.35rem;margin-bottom:1rem;flex-wrap:wrap;align-items:center;justify-content:space-between;}
.filter-pills{display:flex;gap:.35rem;flex-wrap:wrap;}
.filter-btn{padding:.3rem .8rem;border:1px solid var(--border);border-radius:20px;background:none;cursor:pointer;font-size:.76rem;font-family:'DM Sans',sans-serif;font-weight:500;color:var(--text-muted);transition:all .15s;}
.filter-btn.active{background:var(--accent-soft);color:var(--accent);border-color:var(--accent);}

/* BATCH CARDS */
.batch-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:.75rem;box-shadow:var(--shadow);overflow:hidden;}
.batch-header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;cursor:pointer;transition:background .15s;gap:1rem;user-select:none;}
.batch-header:hover{background:var(--surface2);}
.batch-header-left{display:flex;align-items:center;gap:.85rem;flex:1;flex-wrap:wrap;}
.batch-header-right{display:flex;align-items:center;gap:.65rem;flex-shrink:0;}
.batch-chevron{color:var(--text-dim);font-size:.65rem;transition:transform .2s;flex-shrink:0;}
.batch-card.open .batch-chevron{transform:rotate(180deg);}
.batch-sessions-list{display:none;border-top:1px solid var(--border);}
.batch-card.open .batch-sessions-list{display:block;}
.batch-session-row{display:flex;align-items:center;gap:.75rem;padding:.65rem 1.25rem;border-bottom:1px solid var(--border);font-size:.82rem;background:var(--surface2);}
.batch-session-row:last-child{border-bottom:none;}
.batch-totals{display:flex;gap:1.5rem;flex-wrap:wrap;padding:.75rem 1.25rem;border-top:1px solid var(--border);font-size:.78rem;color:var(--text-muted);background:var(--surface);}

/* PENDING ITEMS */
.pending-items{display:flex;flex-direction:column;gap:.5rem;}
.pending-item{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:var(--surface2);border-radius:var(--radius);font-size:.84rem;border:1px solid var(--border);transition:background .15s;}
.pending-item:hover{background:var(--surface3);}
.pi-left{display:flex;align-items:center;gap:.6rem;}
.pi-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}

/* CALENDAR */
.cal-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem;box-shadow:var(--shadow);margin-bottom:1rem;}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;}
.cal-title{font-weight:700;font-size:.95rem;}
.cal-nav{background:none;border:1px solid var(--border);border-radius:7px;padding:.25rem .6rem;cursor:pointer;font-size:.9rem;color:var(--text-muted);transition:all .15s;}
.cal-nav:hover{background:var(--surface2);color:var(--text);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day-label{text-align:center;font-size:.65rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;padding:.3rem 0;}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;position:relative;transition:background .15s;min-height:32px;}
.cal-day:hover{background:var(--surface2);}
.cal-day.today{background:var(--accent-soft);}
.cal-day.today .cal-num{color:var(--accent);font-weight:700;}
.cal-day.other-month .cal-num{color:var(--text-dim);}
.cal-num{font-size:.78rem;font-weight:500;line-height:1;}
.cal-dots{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap;justify-content:center;max-width:28px;}
.cal-dot{width:5px;height:5px;border-radius:50%;}
.cal-dot.happened{background:var(--green);}
.cal-dot.scheduled{background:var(--text-dim);}
.cal-dot.paid{background:var(--blue);}

/* OUTSTANDING LIST */
.outstanding-item{display:flex;align-items:center;justify-content:space-between;padding:.6rem 0;border-bottom:1px solid var(--border);}
.outstanding-item:last-child{border-bottom:none;}
.outstanding-name{font-weight:600;font-size:.88rem;}
.outstanding-detail{font-size:.72rem;color:var(--text-muted);margin-top:.1rem;}
.outstanding-amount{font-family:'DM Mono',monospace;font-size:.95rem;color:var(--amber);font-weight:500;}
.outstanding-days{font-size:.68rem;color:var(--red);margin-top:.1rem;text-align:right;}

/* EDIT MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:flex;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px);}
.modal{background:var(--surface);border-radius:var(--radius-lg);padding:1.75rem;max-width:420px;width:100%;box-shadow:var(--shadow-lg);border:1px solid var(--border);}
.modal h3{font-size:1.1rem;font-weight:700;margin-bottom:1.25rem;}
.modal-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.25rem;}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.6rem 1.1rem;border-radius:30px;font-size:.84rem;font-weight:500;box-shadow:var(--shadow-lg);z-index:9999;opacity:0;transition:all .22s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.success{border-color:rgba(45,106,79,.4);color:var(--green);}
.toast.error{border-color:rgba(192,57,43,.4);color:var(--red);}
.toast.clickable{pointer-events:auto;cursor:pointer;}

/* SKELETON */
.skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--surface3) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:var(--radius);}
.skeleton-row{height:44px;margin-bottom:.5rem;}

.empty-state{text-align:center;padding:2rem 1rem;color:var(--text-muted);font-size:.84rem;line-height:1.6;}
.empty-state .icon{font-size:1.8rem;margin-bottom:.6rem;opacity:.5;}
.empty-state a{color:var(--accent);cursor:pointer;font-weight:500;}

@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* CALENDAR TOOLTIP */
.cal-day{position:relative;}
.cal-tooltip{display:none;position:absolute;top:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:.5rem .75rem;min-width:160px;box-shadow:var(--shadow-lg);z-index:300;font-size:.76rem;line-height:1.5;white-space:nowrap;}
.cal-tooltip::before{content:'';position:absolute;top:-5px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:var(--surface);border-left:1px solid var(--border);border-top:1px solid var(--border);transform:translateX(-50%) rotate(45deg);}
.cal-day:hover .cal-tooltip{display:block;}
.cal-tooltip-row{display:flex;align-items:center;gap:.4rem;padding:.1rem 0;}
.cal-tooltip-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}

/* DRAGGABLE DASH SECTIONS */
.dash-section{margin-bottom:1rem;position:relative;}
.dash-section.arranging .drag-handle{display:flex;}
.dash-section.arranging{cursor:grab;}
.dash-section.dragging{opacity:.4;cursor:grabbing;}
.dash-section.drag-over{outline:2px dashed var(--accent);outline-offset:3px;border-radius:var(--radius-lg);}
.drag-handle{display:none;position:absolute;top:.75rem;right:.75rem;z-index:10;background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:.2rem .4rem;font-size:.75rem;color:var(--text-muted);cursor:grab;align-items:center;gap:.25rem;}
.arranging-banner{background:var(--accent-soft);border:1px dashed var(--accent);border-radius:var(--radius);padding:.5rem 1rem;font-size:.78rem;color:var(--accent);font-weight:600;margin-bottom:.75rem;display:none;text-align:center;}
.arranging-banner.show{display:block;}

@media(min-width:601px){.bottom-nav{display:none!important;}#app{padding-bottom:0;}}
@media(max-width:600px){
  .header-tabs{display:none;}
  .bottom-nav{display:grid!important;}
  .app-header{padding:.7rem 1rem;}
  .main{padding:1rem;}
  .form-row{flex-direction:column;}
  .form-group{min-width:100%;}
  .stats-row{grid-template-columns:repeat(2,1fr);}
  .stat-value{font-size:1.2rem;}
  .toast{bottom:85px;}
  .batch-header{flex-wrap:wrap;}
}
</style>
</head>
<body>
<div id="app">
  <div class="app-header">
    <div class="header-left">
      <h1>üìã Practice</h1>
      <div class="header-tabs">
        <button class="htab active" onclick="switchTab('home')">Home</button>
        <button class="htab" onclick="switchTab('sessions')">Sessions</button>
        <button class="htab" onclick="switchTab('clients')">Clients</button>
        <button class="htab" onclick="switchTab('cash')">Cash</button>
        <button class="htab" onclick="switchTab('bank')">Bank</button>
        <button class="htab" onclick="switchTab('records')">Records</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:.4rem">
      <button class="btn btn-ghost btn-sm" id="undo-btn" onclick="undoAction()" disabled title="Undo (Ctrl+Z)" style="font-size:.8rem;padding:.35rem .65rem;opacity:.4">‚Ü© Undo</button>
      <button class="btn btn-ghost btn-sm" id="redo-btn" onclick="redoAction()" disabled title="Redo (Ctrl+Y)" style="font-size:.8rem;padding:.35rem .65rem;opacity:.4">‚Ü™ Redo</button>
      <button class="btn btn-outline btn-sm" id="theme-toggle" onclick="toggleTheme()">üåô Dark</button>
    </div>
  </div>

  <div class="main">

    <!-- HOME -->
    <div id="tab-home" class="tab-content active">
      <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:1.25rem">
        <h2 style="font-size:1.25rem;font-weight:700;letter-spacing:-.01em" id="dash-title">Loading‚Ä¶</h2>
        <div style="display:flex;gap:.35rem;align-items:center">
          <button class="cal-nav" onclick="shiftDashMonth(-1)">‚Äπ</button>
          <button class="cal-nav" onclick="shiftDashMonth(1)">‚Ä∫</button>
          <button class="cal-nav" id="arrange-btn" onclick="toggleArrange()" style="margin-left:.35rem;font-size:.7rem;padding:.25rem .6rem">‚ú¶ Arrange</button>
        </div>
      </div>

      <!-- STATS always on top -->
      <div class="stats-row">
        <div class="stat-card green"><div class="stat-label">Earned</div><div class="stat-value" id="d-earned">‚Ç™‚Äî</div><div class="stat-sub">sessions happened</div></div>
        <div class="stat-card amber"><div class="stat-label">Still to collect</div><div class="stat-value" id="d-collect">‚Ç™‚Äî</div><div class="stat-sub">yours, not yet received</div></div>
        <div class="stat-card blue"><div class="stat-label">Scheduled</div><div class="stat-value" id="d-scheduled" style="color:var(--text-muted)">‚Äî</div><div class="stat-sub">if they all happen</div></div>
      </div>

      <!-- DRAGGABLE SECTIONS -->
      <div id="dash-sections"></div>
    </div>

    <!-- SESSIONS -->
    <div id="tab-sessions" class="tab-content">
      <div class="section-header"><h2>Sessions</h2></div>
      <div class="card">
        <div class="card-title">Log a Session</div>
        <div class="form-row">
          <div class="form-group"><label>Client</label><select id="session-client"></select></div>
          <div class="form-group"><label>Date</label><input type="date" id="session-date"></div>
          <div class="form-group" style="flex:0;min-width:150px"><label>Status</label>
            <select id="session-status">
              <option value="happened">‚úì Happened</option>
              <option value="scheduled">‚ó∑ Scheduled</option>
            </select>
          </div>
          <button class="btn btn-primary" id="add-session-btn" onclick="addSession()">+ Add</button>
        </div>
        <div style="font-size:.7rem;color:var(--text-dim);margin-top:.5rem">Press Enter to quickly add</div>
      </div>
      <div class="card" style="padding:1rem 1.25rem;margin-bottom:.75rem;">
        <div style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end;">
          <div class="form-group" style="flex:1;min-width:120px;margin:0">
            <label>Status</label>
            <select id="filter-status" onchange="applySessionFilters()">
              <option value="all">All statuses</option>
              <option value="happened">Happened</option>
              <option value="scheduled">Scheduled</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;min-width:120px;margin:0">
            <label>Client</label>
            <select id="filter-client" onchange="applySessionFilters()">
              <option value="all">All clients</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;min-width:120px;margin:0">
            <label>Type</label>
            <select id="filter-type" onchange="applySessionFilters()">
              <option value="all">Cash & Bank</option>
              <option value="cash">Cash only</option>
              <option value="bank">Bank only</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;min-width:120px;margin:0">
            <label>Month</label>
            <select id="filter-month" onchange="applySessionFilters()">
              <option value="all">All months</option>
            </select>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="clearSessionFilters()" style="margin-bottom:0;align-self:flex-end">‚úï Clear</button>
        </div>
        <div style="margin-top:.6rem;font-size:.7rem;color:var(--text-dim)">Click column headers to sort</div>
      </div>
      <div id="sessions-list" class="card"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div>
    </div>

    <!-- CLIENTS -->
    <div id="tab-clients" class="tab-content">
      <div class="section-header"><h2>Clients</h2></div>
      <div class="card">
        <div class="card-title">Add Client</div>
        <div class="form-row">
          <div class="form-group"><label>Name</label><input type="text" id="client-name" placeholder="e.g. Miki"></div>
          <div class="form-group"><label>Payment Type</label><select id="client-type"><option value="cash">Cash</option><option value="bank">Bank Transfer</option></select></div>
          <div class="form-group"><label>Rate (‚Ç™)</label><input type="number" id="client-rate" placeholder="420"></div>
          <button class="btn btn-primary" onclick="addClient()">+ Add</button>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-pills">
          <button class="filter-btn active" onclick="filterClients('all',this)">All</button>
          <button class="filter-btn" onclick="filterClients('cash',this)">Cash</button>
          <button class="filter-btn" onclick="filterClients('bank',this)">Bank</button>
        </div>
        <span style="font-size:.72rem;color:var(--text-dim)">Click headers to sort</span>
      </div>
      <div id="clients-list" class="card"><div class="skeleton skeleton-row"></div></div>
      <div id="archived-section" style="display:none">
        <div class="section-divider"><span>Archived clients</span></div>
        <div id="archived-list" class="card"></div>
      </div>
    </div>

    <!-- CASH -->
    <div id="tab-cash" class="tab-content">
      <div class="section-header"><h2>Cash Payments</h2></div>
      <div class="section-divider"><span>Waiting for payment</span></div>
      <div class="card">
        <div class="card-title">Record Cash Received</div>
        <p style="font-size:.81rem;color:var(--text-muted);margin-bottom:1rem;line-height:1.5">Select sessions where you collected cash. You keep 85% ‚Äî VV gets 15%.</p>
        <div id="cash-session-picker"><div class="skeleton skeleton-row"></div></div>
        <div class="summary-box" id="cash-summary" style="display:none">
          <div class="item"><span>Sessions</span><strong id="cash-count">0</strong></div>
          <div class="item"><span>You Keep (85%)</span><strong id="cash-total" style="color:var(--green)">‚Ç™0</strong></div>
          <div class="item"><span>VV's 15%</span><strong id="cash-vv-owed" style="color:var(--amber)">‚Ç™0</strong></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Date Received</label><input type="date" id="cash-payment-date"></div>
          <button class="btn btn-primary" onclick="recordCashPayment()">Record Payment</button>
        </div>
      </div>
      <div class="section-divider"><span>Needs attention ‚Äî VV payment due</span></div>
      <div class="card" style="padding:.75rem 1.25rem;margin-bottom:.75rem">
        <div style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end;">
          <div class="form-group" style="flex:1;min-width:120px;margin:0"><label>Status</label>
            <select id="cash-filter-status" onchange="applyCashFilters()">
              <option value="all">All</option>
              <option value="pending">Pending VV payment</option>
              <option value="paid">Paid to VV</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;min-width:120px;margin:0"><label>Month</label>
            <select id="cash-filter-month" onchange="applyCashFilters()"><option value="all">All months</option></select>
          </div>
          <div class="form-group" style="flex:1;min-width:100px;margin:0"><label>Sort by</label>
            <select id="cash-sort" onchange="applyCashFilters()">
              <option value="date-desc">Date ‚Üì</option>
              <option value="date-asc">Date ‚Üë</option>
              <option value="amount-desc">Amount ‚Üì</option>
              <option value="amount-asc">Amount ‚Üë</option>
            </select>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="clearCashFilters()">‚úï Clear</button>
        </div>
      </div>
      <div id="cash-needs-attention"><div class="skeleton skeleton-row"></div></div>
    </div>

    <!-- BANK -->
    <div id="tab-bank" class="tab-content">
      <div class="section-header"><h2>Bank Transfer</h2></div>
      <div class="section-divider"><span>Waiting for VV payment</span></div>
      <div class="card">
        <div class="card-title">Record Bank Transfer Received</div>
        <p style="font-size:.81rem;color:var(--text-muted);margin-bottom:1rem;line-height:1.5">Select sessions where VV sent payment. Multiple clients can come in one transfer.</p>
        <div id="vv-session-picker"><div class="skeleton skeleton-row"></div></div>
        <div class="summary-box" id="vv-summary" style="display:none">
          <div class="item"><span>Sessions</span><strong id="vv-count">0</strong></div>
          <div class="item"><span>Full Rate</span><strong id="vv-total">‚Ç™0</strong></div>
          <div class="item"><span>You Get (85%)</span><strong id="vv-you-get" style="color:var(--green)">‚Ç™0</strong></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Date Received</label><input type="date" id="vv-payment-date"></div>
          <button class="btn btn-primary" onclick="recordVVPayment()">Record Payment</button>
        </div>
      </div>
      <div class="section-divider"><span>All bank transfers</span></div>
      <div class="card" style="padding:.75rem 1.25rem;margin-bottom:.75rem">
        <div style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end;">
          <div class="form-group" style="flex:1;min-width:120px;margin:0"><label>Receipt</label>
            <select id="bank-filter-status" onchange="applyBankFilters()">
              <option value="all">All</option>
              <option value="pending">No receipt yet</option>
              <option value="sent">Receipt sent</option>
            </select>
          </div>
          <div class="form-group" style="flex:1;min-width:120px;margin:0"><label>Client</label>
            <select id="bank-filter-client" onchange="applyBankFilters()"><option value="all">All clients</option></select>
          </div>
          <div class="form-group" style="flex:1;min-width:120px;margin:0"><label>Month</label>
            <select id="bank-filter-month" onchange="applyBankFilters()"><option value="all">All months</option></select>
          </div>
          <div class="form-group" style="flex:1;min-width:100px;margin:0"><label>Sort by</label>
            <select id="bank-sort" onchange="applyBankFilters()">
              <option value="date-desc">Date ‚Üì</option>
              <option value="date-asc">Date ‚Üë</option>
              <option value="amount-desc">Amount ‚Üì</option>
              <option value="amount-asc">Amount ‚Üë</option>
            </select>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="clearBankFilters()">‚úï Clear</button>
        </div>
      </div>
      <div id="bank-needs-receipt"><div class="skeleton skeleton-row"></div></div>
    </div>

    <!-- RECORDS -->
    <div id="tab-records" class="tab-content">
      <div class="section-header">
        <h2>Records</h2>
        <select id="records-view" onchange="renderRecordsTab()" style="max-width:180px">
          <option value="month">By month</option>
          <option value="batch">By payment batch</option>
        </select>
      </div>
      <div id="records-content"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <button class="bnav-btn active" id="bnav-home" onclick="switchTab('home')"><span class="ni">üè†</span><span>Home</span></button>
  <button class="bnav-btn" id="bnav-sessions" onclick="switchTab('sessions')"><span class="ni">üìã</span><span>Sessions</span></button>
  <button class="bnav-btn" id="bnav-clients" onclick="switchTab('clients')"><span class="ni">üë§</span><span>Clients</span></button>
  <button class="bnav-btn" id="bnav-cash" onclick="switchTab('cash')"><span class="ni">üíµ</span><span>Cash</span></button>
  <button class="bnav-btn" id="bnav-bank" onclick="switchTab('bank')"><span class="ni">üè¶</span><span>Bank</span></button>
  <button class="bnav-btn" id="bnav-records" onclick="switchTab('records')"><span class="ni">üìÅ</span><span>Records</span></button>
</nav>

<div id="toast" class="toast"></div>

<!-- EDIT MODALS -->
<div id="modal-session" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal('session')">
  <div class="modal">
    <h3>Edit Session</h3>
    <div class="form-group" style="margin-bottom:.75rem"><label>Client</label><select id="edit-session-client"></select></div>
    <div class="form-group" style="margin-bottom:.75rem"><label>Date</label><input type="date" id="edit-session-date"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('session')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSessionEdit()">Save</button>
    </div>
  </div>
</div>

<div id="modal-client" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeModal('client')">
  <div class="modal">
    <h3>Edit Client</h3>
    <div class="form-group" style="margin-bottom:.75rem"><label>Name</label><input type="text" id="edit-client-name"></div>
    <div class="form-group" style="margin-bottom:.75rem"><label>Payment Type</label><select id="edit-client-type"><option value="cash">Cash</option><option value="bank">Bank Transfer</option></select></div>
    <div class="form-group" style="margin-bottom:.75rem"><label>Rate (‚Ç™)</label><input type="number" id="edit-client-rate"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('client')">Cancel</button>
      <button class="btn btn-primary" onclick="saveClientEdit()">Save</button>
    </div>
  </div>
</div>

<script>
const SB_URL = 'https://fxpaacqnsbnbzbcabpvi.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4cGFhY3Fuc2JuYnpiY2FicHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjM0MzgsImV4cCI6MjA4NzY5OTQzOH0.cLIEMR4ZpH3buhMjC8nwHu8h9p-WfHPfNZpHQXua3Oc';
const VV_CUT = 0.15;
const NET = g => Number(g||0)*(1-VV_CUT);

let sbClient, clients=[], sessions=[];
let sessionFilters={status:'all',client:'all',type:'all',month:'all'};
let sessionSortCol='date', sessionSortDir='desc';
let clientSortCol='name', clientSortDir='asc';
let recordsSortCol='date', recordsSortDir='desc';
// ‚îÄ‚îÄ‚îÄ UNDO/REDO SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const undoStack = [];
const redoStack = [];
const MAX_HISTORY = 50;

function pushUndo(action) {
  undoStack.push(action);
  if (undoStack.length > MAX_HISTORY) undoStack.shift();
  redoStack.length = 0;
  updateUndoRedoBtns();
}

function updateUndoRedoBtns() {
  const u = document.getElementById('undo-btn');
  const r = document.getElementById('redo-btn');
  if (u) { u.disabled = undoStack.length === 0; u.style.opacity = undoStack.length ? '1' : '.4'; u.title = undoStack.length ? 'Undo: ' + undoStack[undoStack.length-1].label : 'Nothing to undo'; }
  if (r) { r.disabled = redoStack.length === 0; r.style.opacity = redoStack.length ? '1' : '.4'; r.title = redoStack.length ? 'Redo: ' + redoStack[redoStack.length-1].label : 'Nothing to redo'; }
}

async function undoAction() {
  if (!undoStack.length) return;
  const action = undoStack.pop();
  redoStack.push(action);
  updateUndoRedoBtns();
  await action.undo();
  toast('Undone: ' + action.label, 'success');
}

async function redoAction() {
  if (!redoStack.length) return;
  const action = redoStack.pop();
  undoStack.push(action);
  updateUndoRedoBtns();
  await action.redo();
  toast('Redone: ' + action.label, 'success');
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undoAction(); }
  if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) { e.preventDefault(); redoAction(); }
});

let lastDeleted=null, undoTimer=null;
let calYear, calMonth, dashYear, dashMonth;
let editingSessionId=null, editingClientId=null;
let earningsChart=null;

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  applyTheme(localStorage.getItem('theme')||'light');
  sbClient = window.supabase.createClient(SB_URL, SB_KEY);
  const now = new Date();
  calYear=now.getFullYear(); calMonth=now.getMonth();
  dashYear=now.getFullYear(); dashMonth=now.getMonth();
  const t=todayStr();
  ['session-date','cash-payment-date','vv-payment-date'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=t;});
  document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('tab-sessions').classList.contains('active'))addSession();});
  initApp();
});

async function initApp() {
  document.getElementById('app').style.display = 'block';
  loadAll();
}

function applyTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t);const b=document.getElementById('theme-toggle');if(b)b.textContent=t==='dark'?'‚òÄÔ∏è Light':'üåô Dark';}
function toggleTheme(){applyTheme((document.documentElement.getAttribute('data-theme')||'light')==='dark'?'light':'dark');}

async function loadAll(){
  await loadClients(); await loadSessions();
  renderDashboard(); renderSessionsTab(); renderClientsTab();
  loadCashPayments(); loadVVPayments();
}
async function loadClients(){const{data}=await sbClient.from('clients').select('*').order('name');clients=data||[];populateClientSelects();}
async function loadSessions(){const{data}=await sbClient.from('sessions').select('*').order('date',{ascending:false});sessions=data||[];}

function populateClientSelects(){
  const active=clients.filter(c=>!c.archived).sort((a,b)=>a.name.localeCompare(b.name));
  ['session-client','edit-session-client'].forEach(id=>{
    const sel=document.getElementById(id);if(!sel)return;
    sel.innerHTML=active.length?active.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''):'<option value="">No clients yet</option>';
  });
}

function getSessionStatus(s){if(s.paid)return'paid';if(s.status)return s.status;return'happened';}
function clientName(id){const c=clients.find(c=>c.id===id);return c?c.name:'?';}
function clientRate(id){const c=clients.find(c=>c.id===id);return c?Number(c.rate):0;}
function todayStr(){return new Date().toISOString().split('T')[0];}
function fmtDate(s){if(!s)return'‚Äî';return new Date(s+'T12:00:00').toLocaleDateString('en-IL',{day:'numeric',month:'short',year:'numeric'});}
function fmtDateShort(s){if(!s)return'‚Äî';return new Date(s+'T12:00:00').toLocaleDateString('en-IL',{day:'numeric',month:'short'});}
function fmtMonth(y,m){return new Date(y,m,1).toLocaleDateString('en-IL',{month:'long',year:'numeric'});}
function daysSince(dateStr){if(!dateStr)return 0;return Math.floor((new Date()-new Date(dateStr+'T12:00:00'))/(1000*60*60*24));}

function switchTab(name){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.htab').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+name)?.classList.add('active');
  document.querySelectorAll('.htab').forEach(b=>{if(b.getAttribute('onclick')?.includes("'"+name+"'"))b.classList.add('active');});
  document.getElementById('bnav-'+name)?.classList.add('active');
  if(name==='cash'){renderCashSessionPicker();loadCashPayments();}
  if(name==='bank'){renderVVSessionPicker();loadVVPayments();}
  if(name==='home')renderDashboard();
  if(name==='records')renderRecordsTab();
}

// ‚îÄ‚îÄ‚îÄ DRAG & DROP DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_SECTION_ORDER = ['todo','chart','cal-outstanding','scheduled'];
const SECTION_LABELS = {
  'todo': 'To Do',
  'chart': 'Monthly Chart',
  'cal-outstanding': 'Calendar & Outstanding',
  'scheduled': 'Scheduled Sessions'
};
let sectionOrder = JSON.parse(localStorage.getItem('dash_order') || 'null') || [...DEFAULT_SECTION_ORDER];
let arranging = false;
let dragSrc = null;

function toggleArrange() {
  arranging = !arranging;
  const btn = document.getElementById('arrange-btn');
  const banner = document.getElementById('arrange-banner');
  btn.textContent = arranging ? '‚úì Done' : '‚ú¶ Arrange';
  btn.style.color = arranging ? 'var(--accent)' : '';
  if (banner) banner.classList.toggle('show', arranging);
  document.querySelectorAll('.dash-section').forEach(el => el.classList.toggle('arranging', arranging));
}

function saveSectionOrder() {
  localStorage.setItem('dash_order', JSON.stringify(sectionOrder));
}

function buildDashSections() {
  const container = document.getElementById('dash-sections');
  container.innerHTML = `<div id="arrange-banner" class="arranging-banner">Drag sections to reorder ‚Ä¢ tap ‚úì Done when finished</div>` +
    sectionOrder.map(id => `<div class="dash-section" id="dsec-${id}" draggable="true" data-sid="${id}">
      <div class="drag-handle">‚†ø drag</div>
      ${getSectionHTML(id)}
    </div>`).join('');

  // attach drag events
  container.querySelectorAll('.dash-section').forEach(el => {
    el.addEventListener('dragstart', e => {
      if (!arranging) { e.preventDefault(); return; }
      dragSrc = el;
      setTimeout(() => el.classList.add('dragging'), 0);
    });
    el.addEventListener('dragend', () => {
      el.classList.remove('dragging');
      container.querySelectorAll('.dash-section').forEach(x => x.classList.remove('drag-over'));
    });
    el.addEventListener('dragover', e => {
      if (!arranging || !dragSrc || dragSrc === el) return;
      e.preventDefault();
      container.querySelectorAll('.dash-section').forEach(x => x.classList.remove('drag-over'));
      el.classList.add('drag-over');
    });
    el.addEventListener('drop', e => {
      if (!arranging || !dragSrc || dragSrc === el) return;
      e.preventDefault();
      el.classList.remove('drag-over');
      const ids = [...container.querySelectorAll('.dash-section')].map(x => x.dataset.sid);
      const fromIdx = ids.indexOf(dragSrc.dataset.sid);
      const toIdx = ids.indexOf(el.dataset.sid);
      ids.splice(fromIdx, 1);
      ids.splice(toIdx, 0, dragSrc.dataset.sid);
      sectionOrder = ids;
      saveSectionOrder();
      buildDashSections();
      if (arranging) {
        document.querySelectorAll('.dash-section').forEach(x => x.classList.add('arranging'));
        document.getElementById('arrange-banner')?.classList.add('show');
      }
      renderDashboardSections();
    });
  });
}

function getSectionHTML(id) {
  switch(id) {
    case 'todo': return `<div class="card"><div class="card-title" style="margin-bottom:.75rem">To do</div><div id="pending-actions"><div class="skeleton skeleton-row"></div></div></div>`;
    case 'chart': return `<div class="card"><div class="card-title">Monthly earnings (net)</div><canvas id="earnings-chart" height="80"></canvas></div>`;
    case 'cal-outstanding': return `<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;" id="home-grid">
      <div class="cal-wrap">
        <div class="cal-header"><button class="cal-nav" onclick="shiftCal(-1)">‚Äπ</button><span class="cal-title" id="cal-title"></span><button class="cal-nav" onclick="shiftCal(1)">‚Ä∫</button></div>
        <div class="cal-grid" id="cal-grid"></div>
        <div style="display:flex;gap:1rem;margin-top:.85rem;flex-wrap:wrap;">
          <span style="display:flex;align-items:center;gap:.35rem;font-size:.7rem;color:var(--text-muted)"><span style="width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block"></span>Happened</span>
          <span style="display:flex;align-items:center;gap:.35rem;font-size:.7rem;color:var(--text-muted)"><span style="width:8px;height:8px;border-radius:50%;background:var(--blue);display:inline-block"></span>Paid</span>
          <span style="display:flex;align-items:center;gap:.35rem;font-size:.7rem;color:var(--text-muted)"><span style="width:8px;height:8px;border-radius:50%;background:var(--text-dim);display:inline-block"></span>Scheduled</span>
        </div>
      </div>
      <div><div class="card" style="margin-bottom:0"><div class="card-title">Outstanding per client</div><div id="outstanding-list"><div class="skeleton skeleton-row"></div></div></div></div>
    </div>`;
    case 'scheduled': return `<div class="card"><div class="card-title">Scheduled sessions</div><div id="scheduled-list"><div class="skeleton skeleton-row"></div></div></div>`;
    default: return '';
  }
}

function renderDashboardSections() {
  renderPendingActions();
  renderEarningsChart();
  renderCalendar();
  renderOutstandingList();
  renderScheduledList();
  // fix home-grid responsive
  const grid = document.getElementById('home-grid');
  if (grid) grid.style.gridTemplateColumns = window.innerWidth < 650 ? '1fr' : '1fr 1fr';
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shiftDashMonth(dir){
  dashMonth+=dir;
  if(dashMonth>11){dashMonth=0;dashYear++;}
  if(dashMonth<0){dashMonth=11;dashYear--;}
  renderDashboard();
}

async function renderDashboard(){
  const monthStart=new Date(dashYear,dashMonth,1).toISOString().split('T')[0];
  const monthEnd=new Date(dashYear,dashMonth+1,0).toISOString().split('T')[0];
  const thisMonth=sessions.filter(s=>s.date>=monthStart&&s.date<=monthEnd);

  let earned=0;
  thisMonth.filter(s=>['happened','paid'].includes(getSessionStatus(s))).forEach(s=>earned+=NET(clientRate(s.client_id)));
  let toCollect=0;
  sessions.filter(s=>getSessionStatus(s)==='happened').forEach(s=>toCollect+=NET(clientRate(s.client_id)));
  let scheduled=0;
  thisMonth.filter(s=>getSessionStatus(s)==='scheduled').forEach(s=>scheduled+=NET(clientRate(s.client_id)));

  document.getElementById('dash-title').textContent=fmtMonth(dashYear,dashMonth);
  document.getElementById('d-earned').textContent='‚Ç™'+Math.round(earned);
  document.getElementById('d-collect').textContent='‚Ç™'+Math.round(toCollect);
  document.getElementById('d-scheduled').textContent=scheduled>0?'‚Ç™'+Math.round(scheduled):'‚Äî';

  // Build sections if not yet built
  if(!document.getElementById('dsec-todo')) buildDashSections();
  renderDashboardSections();
}

// ‚îÄ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shiftCal(dir){
  calMonth+=dir;
  if(calMonth>11){calMonth=0;calYear++;}
  if(calMonth<0){calMonth=11;calYear--;}
  renderCalendar();
}

function renderCalendar(){
  document.getElementById('cal-title').textContent=fmtMonth(calYear,calMonth);
  const grid=document.getElementById('cal-grid');
  const days=['Su','Mo','Tu','We','Th','Fr','Sa'];
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const today=todayStr();

  let html=days.map(d=>`<div class="cal-day-label">${d}</div>`).join('');
  for(let i=0;i<firstDay;i++){
    const d=new Date(calYear,calMonth,-(firstDay-i-1));
    html+=`<div class="cal-day other-month"><span class="cal-num">${d.getDate()}</span></div>`;
  }
  for(let d=1;d<=daysInMonth;d++){
    const dateStr=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const daySessions=sessions.filter(s=>s.date===dateStr);
    const isToday=dateStr===today;
    const dots=daySessions.map(s=>`<span class="cal-dot ${getSessionStatus(s)}"></span>`).join('');
    const statusColor={happened:'var(--green)',paid:'var(--blue)',scheduled:'var(--text-dim)'};
    const tooltipRows=daySessions.map(s=>{
      const c=clients.find(c=>c.id===s.client_id);
      const st=getSessionStatus(s);
      return`<div class="cal-tooltip-row"><span class="cal-tooltip-dot" style="background:${statusColor[st]||'var(--text-dim)'}"></span><span style="font-weight:600">${c?c.name:'?'}</span><span style="color:var(--text-muted);margin-left:.25rem">${st}</span></div>`;
    }).join('');
    const tooltip=daySessions.length?`<div class="cal-tooltip">${tooltipRows}</div>`:'';
    html+=`<div class="cal-day${isToday?' today':''}">
      <span class="cal-num">${d}</span>
      ${daySessions.length?`<div class="cal-dots">${dots}</div>`:''}
      ${tooltip}
    </div>`;
  }
  grid.innerHTML=html;
}

// ‚îÄ‚îÄ‚îÄ OUTSTANDING LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOutstandingList(){
  const el=document.getElementById('outstanding-list');
  const unpaid=sessions.filter(s=>getSessionStatus(s)==='happened');
  const byClient={};
  unpaid.forEach(s=>{
    if(!byClient[s.client_id])byClient[s.client_id]={sessions:[],oldest:s.date};
    byClient[s.client_id].sessions.push(s);
    if(s.date<byClient[s.client_id].oldest)byClient[s.client_id].oldest=s.date;
  });
  const entries=Object.entries(byClient).map(([cid,data])=>({
    cid,name:clientName(cid),
    total:data.sessions.reduce((sum,s)=>sum+NET(clientRate(s.client_id)),0),
    count:data.sessions.length,oldest:data.oldest
  })).sort((a,b)=>b.total-a.total);

  if(!entries.length){el.innerHTML=`<div class="empty-state" style="padding:1rem 0"><div class="icon">‚úÖ</div>All collected!</div>`;return;}
  el.innerHTML=entries.map(e=>{
    const days=daysSince(e.oldest);
    return`<div class="outstanding-item">
      <div><div class="outstanding-name">${e.name}</div><div class="outstanding-detail">${e.count} session${e.count!==1?'s':''}</div></div>
      <div style="text-align:right"><div class="outstanding-amount">‚Ç™${Math.round(e.total)}</div><div class="outstanding-days">${days>14?days+' days ago':''}</div></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ SCHEDULED LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderScheduledList(){
  const el=document.getElementById('scheduled-list');
  const sched=sessions.filter(s=>getSessionStatus(s)==='scheduled').sort((a,b)=>a.date<b.date?-1:1);
  if(!sched.length){el.innerHTML=`<div class="empty-state" style="padding:.75rem 0"><div class="icon">üìÖ</div>No scheduled sessions</div>`;return;}
  el.innerHTML=`<div class="table-wrap"><table>
    <thead><tr><th>Date</th><th>Client</th><th>Type</th><th>You'd earn</th><th></th></tr></thead>
    <tbody>${sched.map(s=>{
      const c=clients.find(c=>c.id===s.client_id);
      return`<tr>
        <td style="font-family:'DM Mono',monospace;font-size:.77rem;color:var(--text-muted)">${fmtDate(s.date)}</td>
        <td><strong>${c?c.name:'‚Äî'}</strong></td>
        <td>${c?(c.type==='cash'?'<span class="badge badge-cash">Cash</span>':'<span class="badge badge-bank">Bank</span>'):''}</td>
        <td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(NET(c.rate)):'‚Äî'}</td>
        <td><button class="btn btn-sm btn-ghost" onclick="markHappened('${s.id}')">‚úì Happened</button></td>
      </tr>`;
    }).join('')}</tbody></table></div>`;
}

async function markHappened(id){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  s.status='happened';
  await sbClient.from('sessions').update({status:'happened'}).eq('id',id);
  toast('Marked as happened ‚úì','success');
  renderDashboard(); renderSessionsTab(); renderCashSessionPicker(); renderVVSessionPicker();
}

// ‚îÄ‚îÄ‚îÄ PENDING ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderPendingActions(){
  const happenedUnpaid=sessions.filter(s=>getSessionStatus(s)==='happened');
  const cashH=happenedUnpaid.filter(s=>clients.find(c=>c.id===s.client_id)?.type==='cash');
  const bankH=happenedUnpaid.filter(s=>clients.find(c=>c.id===s.client_id)?.type==='bank');
  const{data:cashPmts}=await sbClient.from('cash_payments').select('vv_owed,paid_to_vv').eq('paid_to_vv',false);
  const vvOwed=(cashPmts||[]).reduce((sum,p)=>sum+Number(p.vv_owed),0);
  const{data:vvPmts}=await sbClient.from('vv_payments').select('id,receipt_sent').eq('receipt_sent',false);
  const pendingReceipts=(vvPmts||[]).length;
  const items=[];
  if(cashH.length)items.push({dot:'var(--blue)',text:`${cashH.length} cash session${cashH.length>1?'s':''} to record`,tab:'cash',label:'Record ‚Üí'});
  if(bankH.length)items.push({dot:'var(--accent)',text:`${bankH.length} bank session${bankH.length>1?'s':''} waiting for VV`,tab:'bank',label:'Record ‚Üí'});
  if(vvOwed>0)items.push({dot:'var(--amber)',text:`‚Ç™${Math.round(vvOwed)} you owe VV`,tab:'cash',label:'View ‚Üí'});
  if(pendingReceipts>0)items.push({dot:'var(--red)',text:`${pendingReceipts} bank transfer${pendingReceipts>1?'s':''} need a receipt`,tab:'bank',label:'View ‚Üí'});
  const el=document.getElementById('pending-actions');
  el.innerHTML=!items.length
    ?`<div class="empty-state" style="padding:.75rem 0"><div class="icon">‚úÖ</div>All caught up!</div>`
    :`<div class="pending-items">${items.map(it=>`<div class="pending-item"><div class="pi-left"><div class="pi-dot" style="background:${it.dot}"></div><span>${it.text}</span></div><button class="btn btn-ghost btn-sm" onclick="switchTab('${it.tab}')">${it.label}</button></div>`).join('')}</div>`;
}

// ‚îÄ‚îÄ‚îÄ EARNINGS CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEarningsChart(){
  const months=[];
  for(let i=5;i>=0;i--){
    let y=dashYear,m=dashMonth-i;
    if(m<0){m+=12;y--;}
    const start=new Date(y,m,1).toISOString().split('T')[0];
    const end=new Date(y,m+1,0).toISOString().split('T')[0];
    const label=new Date(y,m,1).toLocaleDateString('en-IL',{month:'short'});
    const earned=sessions.filter(s=>s.date>=start&&s.date<=end&&['happened','paid'].includes(getSessionStatus(s)))
      .reduce((sum,s)=>sum+NET(clientRate(s.client_id)),0);
    months.push({label,earned:Math.round(earned)});
  }
  const ctx=document.getElementById('earnings-chart').getContext('2d');
  if(earningsChart)earningsChart.destroy();
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const green=isDark?'#52b788':'#2d6a4f';
  earningsChart=new Chart(ctx,{
    type:'bar',
    data:{
      labels:months.map(m=>m.label),
      datasets:[{data:months.map(m=>m.earned),backgroundColor:months.map((_,i)=>i===5?green:green+'55'),borderRadius:6,borderSkipped:false}]
    },
    options:{
      responsive:true,maintainAspectRatio:true,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>'‚Ç™'+ctx.raw}}},
      scales:{
        x:{grid:{display:false},ticks:{font:{family:'DM Sans',size:11},color:isDark?'#7a7870':'#6b6960'}},
        y:{grid:{color:isDark?'#333330':'#e8e7e2'},ticks:{font:{family:'DM Mono',size:10},color:isDark?'#7a7870':'#6b6960',callback:v=>'‚Ç™'+v}}
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ SESSIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addSession(){
  const client_id=document.getElementById('session-client').value;
  const date=document.getElementById('session-date').value;
  const status=document.getElementById('session-status').value;
  if(!client_id||!date){toast('Fill all fields','error');return;}
  const btn=document.getElementById('add-session-btn');
  btn.textContent='‚Ä¶';btn.disabled=true;
  const{error}=await sbClient.from('sessions').insert({client_id,date,status,paid:false});
  btn.textContent='+ Add';btn.disabled=false;
  if(error){toast('Error: '+error.message,'error');return;}
  toast(status==='scheduled'?'Session scheduled ‚ó∑':'Session logged ‚úì','success');
  await loadSessions();renderSessionsTab();renderDashboard();renderCashSessionPicker();renderVVSessionPicker();
}

async function softDeleteSession(id){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  const snap={...s};
  await sbClient.from('sessions').delete().eq('id',id);
  sessions=sessions.filter(x=>x.id!==id);
  pushUndo({
    label:'Delete session ('+clientName(snap.client_id)+' '+fmtDateShort(snap.date)+')',
    undo: async()=>{
      await sbClient.from('sessions').insert(snap);
      await loadSessions();renderSessionsTab();renderDashboard();renderCashSessionPicker();renderVVSessionPicker();
    },
    redo: async()=>{
      await sbClient.from('sessions').delete().eq('id',snap.id);
      await loadSessions();renderSessionsTab();renderDashboard();renderCashSessionPicker();renderVVSessionPicker();
    }
  });
  renderSessionsTab();renderDashboard();renderCashSessionPicker();renderVVSessionPicker();
  toast('Session deleted','success');
}

function openSessionEdit(id){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  editingSessionId=id;
  populateClientSelects();
  document.getElementById('edit-session-client').value=s.client_id;
  document.getElementById('edit-session-date').value=s.date;
  document.getElementById('modal-session').style.display='flex';
}
async function saveSessionEdit(){
  if(!editingSessionId)return;
  const client_id=document.getElementById('edit-session-client').value;
  const date=document.getElementById('edit-session-date').value;
  const{error}=await sbClient.from('sessions').update({client_id,date}).eq('id',editingSessionId);
  if(error){toast('Error: '+error.message,'error');return;}
  const s=sessions.find(x=>x.id===editingSessionId);
  if(s){s.client_id=client_id;s.date=date;}
  closeModal('session');toast('Session updated ‚úì','success');
  renderSessionsTab();renderDashboard();
}
function closeModal(name){document.getElementById('modal-'+name).style.display='none';}

function applySessionFilters(){
  sessionFilters.status=document.getElementById('filter-status')?.value||'all';
  sessionFilters.client=document.getElementById('filter-client')?.value||'all';
  sessionFilters.type=document.getElementById('filter-type')?.value||'all';
  sessionFilters.month=document.getElementById('filter-month')?.value||'all';
  renderSessionsTab();
}
function clearSessionFilters(){
  sessionFilters={status:'all',client:'all',type:'all',month:'all'};
  ['filter-status','filter-client','filter-type','filter-month'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='all';});
  renderSessionsTab();
}
function populateSessionFilterDropdowns(){
  // Clients
  const clientSel=document.getElementById('filter-client');
  if(clientSel){
    const active=clients.filter(c=>!c.archived).sort((a,b)=>a.name.localeCompare(b.name));
    clientSel.innerHTML='<option value="all">All clients</option>'+active.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    if(sessionFilters.client!=='all')clientSel.value=sessionFilters.client;
  }
  // Months from actual session data
  const monthSel=document.getElementById('filter-month');
  if(monthSel){
    const months=[...new Set(sessions.map(s=>s.date.substring(0,7)))].sort((a,b)=>b.localeCompare(a));
    monthSel.innerHTML='<option value="all">All months</option>'+months.map(m=>{
      const[y,mo]=m.split('-');
      const label=new Date(Number(y),Number(mo)-1,1).toLocaleDateString('en-IL',{month:'long',year:'numeric'});
      return`<option value="${m}">${label}</option>`;
    }).join('');
    if(sessionFilters.month!=='all')monthSel.value=sessionFilters.month;
  }
}
function sortSessionsBy(col){if(sessionSortCol===col)sessionSortDir=sessionSortDir==='asc'?'desc':'asc';else{sessionSortCol=col;sessionSortDir=col==='date'?'desc':'asc';}renderSessionsTab();}

function renderSessionsTab(){
  populateSessionFilterDropdowns();
  const el=document.getElementById('sessions-list');
  let list=[...sessions];
  if(sessionFilters.status!=='all')list=list.filter(s=>getSessionStatus(s)===sessionFilters.status);
  if(sessionFilters.client!=='all')list=list.filter(s=>s.client_id===sessionFilters.client);
  if(sessionFilters.type!=='all'){const ids=clients.filter(c=>c.type===sessionFilters.type).map(c=>c.id);list=list.filter(s=>ids.includes(s.client_id));}
  if(sessionFilters.month!=='all')list=list.filter(s=>s.date.startsWith(sessionFilters.month));
  const dir=sessionSortDir==='asc'?1:-1;
  if(sessionSortCol==='date')list.sort((a,b)=>(a.date>b.date?1:-1)*dir);
  else if(sessionSortCol==='client')list.sort((a,b)=>clientName(a.client_id).localeCompare(clientName(b.client_id))*dir);
  else if(sessionSortCol==='status'){const o={scheduled:0,happened:1,paid:2};list.sort((a,b)=>((o[getSessionStatus(a)]||0)-(o[getSessionStatus(b)]||0))*dir);}
  const arrow=col=>sessionSortCol===col?(sessionSortDir==='asc'?' ‚Üë':' ‚Üì'):'';
  const ts='cursor:pointer;user-select:none;';
  if(!list.length){el.innerHTML=`<div class="empty-state"><div class="icon">üìã</div>No sessions match your filters</div>`;return;}
  el.innerHTML=`<div class="table-wrap"><table>
    <thead><tr>
      <th style="${ts}" onclick="sortSessionsBy('date')">Date${arrow('date')}</th>
      <th style="${ts}" onclick="sortSessionsBy('client')">Client${arrow('client')}</th>
      <th>Type</th><th>You Keep</th>
      <th style="${ts}" onclick="sortSessionsBy('status')">Status${arrow('status')}</th>
      <th></th>
    </tr></thead>
    <tbody>${list.map(s=>{
      const c=clients.find(c=>c.id===s.client_id);
      const status=getSessionStatus(s);
      const statusBadge=status==='paid'?'<span class="badge badge-green">‚úì Paid</span>'
        :status==='happened'?'<span class="badge badge-amber">Happened</span>'
        :'<span class="badge badge-grey">‚ó∑ Scheduled</span>';
      return`<tr>
        <td style="font-family:'DM Mono',monospace;font-size:.77rem;color:var(--text-muted)">${fmtDate(s.date)}</td>
        <td><strong>${c?c.name:'‚Äî'}</strong></td>
        <td>${c?(c.type==='cash'?'<span class="badge badge-cash">Cash</span>':'<span class="badge badge-bank">Bank</span>'):''}</td>
        <td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(NET(c.rate)):'‚Äî'}</td>
        <td>${status!=='paid'?`<select onchange="changeSessionStatus('${s.id}',this.value)" style="font-size:.75rem;padding:.25rem .5rem;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);cursor:pointer">
          <option value="scheduled" ${status==='scheduled'?'selected':''}>‚ó∑ Scheduled</option>
          <option value="happened" ${status==='happened'?'selected':''}>‚úì Happened</option>
        </select>`:statusBadge}</td>
        <td style="text-align:right;display:flex;gap:.2rem;justify-content:flex-end">
          <button class="btn-edit" onclick="openSessionEdit('${s.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="btn-icon" onclick="softDeleteSession('${s.id}')" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('')}</tbody></table></div>`;
}

async function changeSessionStatus(id,newStatus){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  const oldStatus=s.status||'happened';
  s.status=newStatus;
  await sbClient.from('sessions').update({status:newStatus}).eq('id',id);
  pushUndo({
    label:'Status change '+clientName(s.client_id)+': '+oldStatus+' ‚Üí '+newStatus,
    undo:async()=>{ s.status=oldStatus; await sbClient.from('sessions').update({status:oldStatus}).eq('id',id); renderSessionsTab();renderDashboard();renderCashSessionPicker();renderVVSessionPicker(); },
    redo:async()=>{ s.status=newStatus; await sbClient.from('sessions').update({status:newStatus}).eq('id',id); renderSessionsTab();renderDashboard();renderCashSessionPicker();renderVVSessionPicker(); }
  });
  renderDashboard();renderCashSessionPicker();renderVVSessionPicker();renderSessionsTab();
  toast('Status updated ‚úì','success');
}

// ‚îÄ‚îÄ‚îÄ CLIENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addClient(){
  const name=document.getElementById('client-name').value.trim();
  const type=document.getElementById('client-type').value;
  const rate=parseFloat(document.getElementById('client-rate').value);
  if(!name||!rate){toast('Fill all fields','error');return;}
  const{error}=await sbClient.from('clients').insert({name,type,rate,archived:false});
  if(error){toast('Error: '+error.message,'error');return;}
  toast('Client added ‚úì','success');
  document.getElementById('client-name').value='';document.getElementById('client-rate').value='';
  await loadClients();renderClientsTab();
}

function openClientEdit(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  editingClientId=id;
  document.getElementById('edit-client-name').value=c.name;
  document.getElementById('edit-client-type').value=c.type;
  document.getElementById('edit-client-rate').value=c.rate;
  document.getElementById('modal-client').style.display='flex';
}
async function saveClientEdit(){
  if(!editingClientId)return;
  const name=document.getElementById('edit-client-name').value.trim();
  const type=document.getElementById('edit-client-type').value;
  const rate=parseFloat(document.getElementById('edit-client-rate').value);
  if(!name||!rate){toast('Fill all fields','error');return;}
  const{error}=await sbClient.from('clients').update({name,type,rate}).eq('id',editingClientId);
  if(error){toast('Error: '+error.message,'error');return;}
  const c=clients.find(x=>x.id===editingClientId);
  if(c){c.name=name;c.type=type;c.rate=rate;}
  closeModal('client');toast('Client updated ‚úì','success');
  populateClientSelects();renderClientsTab();renderSessionsTab();renderDashboard();
}

async function archiveClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  await sbClient.from('clients').update({archived:true}).eq('id',id);
  c.archived=true;
  toast('Client archived ‚Äî click Unarchive to restore','success');
  populateClientSelects();renderClientsTab();
}
async function unarchiveClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  await sbClient.from('clients').update({archived:false}).eq('id',id);
  c.archived=false;
  toast('Client restored ‚úì','success');
  populateClientSelects();renderClientsTab();
}
async function deleteClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  const sessionCount=sessions.filter(s=>s.client_id===id).length;
  const msg=sessionCount>0
    ?`Delete ${c.name}? This will also delete their ${sessionCount} session${sessionCount!==1?'s':''}. This cannot be undone.`
    :`Delete ${c.name}? This cannot be undone.`;
  if(!confirm(msg))return;
  if(sessionCount>0)await sbClient.from('sessions').delete().eq('client_id',id);
  await sbClient.from('clients').delete().eq('id',id);
  const deletedSessions=sessions.filter(s=>s.client_id===id);
  toast('Client deleted','success');
  pushUndo({
    label:'Delete client '+c.name,
    undo:async()=>{
      await sbClient.from('clients').insert(c);
      if(deletedSessions.length)await sbClient.from('sessions').insert(deletedSessions);
      await loadClients();await loadSessions();renderClientsTab();renderSessionsTab();renderDashboard();
    },
    redo:async()=>{
      if(deletedSessions.length)await sbClient.from('sessions').delete().eq('client_id',id);
      await sbClient.from('clients').delete().eq('id',id);
      await loadClients();await loadSessions();renderClientsTab();renderSessionsTab();renderDashboard();
    }
  });
  await loadClients();await loadSessions();renderClientsTab();renderSessionsTab();renderDashboard();
}

let currentClientFilter='all';
function filterClients(f,btn){currentClientFilter=f;document.querySelectorAll('#tab-clients .filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderClientsTab();}
function sortClientsBy(col){if(clientSortCol===col)clientSortDir=clientSortDir==='asc'?'desc':'asc';else{clientSortCol=col;clientSortDir='asc';}renderClientsTab();}

function renderClientsTab(){
  let active=clients.filter(c=>!c.archived);
  if(currentClientFilter==='cash')active=active.filter(c=>c.type==='cash');
  if(currentClientFilter==='bank')active=active.filter(c=>c.type==='bank');
  const archived=clients.filter(c=>c.archived);
  const dir=clientSortDir==='asc'?1:-1;
  if(clientSortCol==='name')active.sort((a,b)=>a.name.localeCompare(b.name)*dir);
  else if(clientSortCol==='rate')active.sort((a,b)=>(Number(a.rate)-Number(b.rate))*dir);
  else if(clientSortCol==='sessions')active.sort((a,b)=>(sessions.filter(s=>s.client_id===a.id).length-sessions.filter(s=>s.client_id===b.id).length)*dir);
  const arrow=col=>clientSortCol===col?(clientSortDir==='asc'?' ‚Üë':' ‚Üì'):'';
  const ts='cursor:pointer;user-select:none;';
  const el=document.getElementById('clients-list');
  if(!active.length){el.innerHTML=`<div class="empty-state"><div class="icon">üë§</div>No active clients</div>`;}
  else el.innerHTML=`<div class="table-wrap"><table>
    <thead><tr>
      <th style="${ts}" onclick="sortClientsBy('name')">Name${arrow('name')}</th>
      <th>Type</th>
      <th style="${ts}" onclick="sortClientsBy('rate')">Rate${arrow('rate')}</th>
      <th>You Keep</th>
      <th style="${ts}" onclick="sortClientsBy('sessions')">Sessions${arrow('sessions')}</th>
      <th></th>
    </tr></thead>
    <tbody>${active.map(c=>{
      const count=sessions.filter(s=>s.client_id===c.id).length;
      const unpaid=sessions.filter(s=>s.client_id===c.id&&!s.paid).length;
      return`<tr>
        <td><strong>${c.name}</strong></td>
        <td>${c.type==='cash'?'<span class="badge badge-cash">Cash</span>':'<span class="badge badge-bank">Bank</span>'}</td>
        <td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c.rate}</td>
        <td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${Math.round(NET(c.rate))}</td>
        <td><span style="font-weight:600">${count}</span>${unpaid>0?` <span style="font-size:.7rem;color:var(--amber)">${unpaid} unpaid</span>`:''}</td>
        <td style="display:flex;gap:.2rem;justify-content:flex-end">
          <button class="btn-edit" onclick="openClientEdit('${c.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-ghost" onclick="archiveClient('${c.id}')">Archive</button>
          <button class="btn-icon" onclick="deleteClient('${c.id}')" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('')}</tbody></table></div>`;

  const archSec=document.getElementById('archived-section');
  const archEl=document.getElementById('archived-list');
  if(!archived.length){archSec.style.display='none';return;}
  archSec.style.display='block';
  archEl.innerHTML=`<div class="table-wrap"><table>
    <thead><tr><th>Name</th><th>Type</th><th>Rate</th><th></th></tr></thead>
    <tbody>${archived.map(c=>`<tr>
      <td><strong style="color:var(--text-muted)">${c.name}</strong></td>
      <td>${c.type==='cash'?'<span class="badge badge-cash">Cash</span>':'<span class="badge badge-bank">Bank</span>'}</td>
      <td style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--text-muted)">‚Ç™${c.rate}</td>
      <td style="display:flex;gap:.2rem;justify-content:flex-end">
        <button class="btn btn-sm btn-ghost" onclick="unarchiveClient('${c.id}')">Unarchive</button>
        <button class="btn-icon" onclick="deleteClient('${c.id}')" title="Delete">üóëÔ∏è</button>
      </td>
    </tr>`).join('')}</tbody></table></div>`;
}

// ‚îÄ‚îÄ‚îÄ CASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCashSessionPicker(){
  const el=document.getElementById('cash-session-picker');
  const ids=clients.filter(c=>c.type==='cash'&&!c.archived).map(c=>c.id);
  const unpaid=sessions.filter(s=>!s.paid&&getSessionStatus(s)==='happened'&&ids.includes(s.client_id));
  if(!unpaid.length){el.innerHTML=`<div class="empty-state" style="padding:1.25rem"><div class="icon">‚úì</div>No unpaid cash sessions</div>`;document.getElementById('cash-summary').style.display='none';return;}
  el.innerHTML=`<div class="session-picker">${unpaid.map(s=>{
    const c=clients.find(c=>c.id===s.client_id);
    return`<label class="session-check-item"><input type="checkbox" value="${s.id}" data-rate="${c?c.rate:0}" onchange="updateCashSummary()"><span style="font-weight:600">${c?c.name:'?'}</span><span style="color:var(--text-muted);font-size:.77rem">${fmtDateShort(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(NET(c.rate)):'?'} net</span></label>`;
  }).join('')}</div>`;
  updateCashSummary();
}
function updateCashSummary(){
  const checked=document.querySelectorAll('#cash-session-picker input:checked');
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  document.querySelectorAll('#cash-session-picker .session-check-item').forEach(item=>item.classList.toggle('selected',item.querySelector('input').checked));
  document.getElementById('cash-summary').style.display=checked.length>0?'flex':'none';
  document.getElementById('cash-count').textContent=checked.length;
  document.getElementById('cash-total').textContent='‚Ç™'+Math.round(NET(gross));
  document.getElementById('cash-vv-owed').textContent='‚Ç™'+Math.round(gross*VV_CUT);
}
async function recordCashPayment(){
  const checked=[...document.querySelectorAll('#cash-session-picker input:checked')];
  if(!checked.length){toast('Select at least one session','error');return;}
  const date=document.getElementById('cash-payment-date').value;
  if(!date){toast('Select a date','error');return;}
  const session_ids=checked.map(cb=>cb.value);
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  const{error}=await sbClient.from('cash_payments').insert({date,session_ids,total:gross,vv_owed:gross*VV_CUT,paid_to_vv:false});
  if(error){toast('Error: '+error.message,'error');return;}
  await sbClient.from('sessions').update({paid:true}).in('id',session_ids);
  toast('Cash payment recorded ‚úì','success');
  const {data:newBatch}=await sbClient.from('cash_payments').select('*').eq('date',date).order('created_at',{ascending:false}).limit(1).single();
  pushUndo({
    label:'Record cash payment ('+session_ids.length+' sessions)',
    undo:async()=>{
      if(newBatch){await sbClient.from('sessions').update({paid:false}).in('id',session_ids);await sbClient.from('cash_payments').delete().eq('id',newBatch.id);}
      await loadSessions();renderSessionsTab();renderCashSessionPicker();loadCashPayments();renderDashboard();
    },
    redo:async()=>{
      const{error}=await sbClient.from('cash_payments').insert({date,session_ids,total:gross,vv_owed:gross*VV_CUT,paid_to_vv:false});
      if(!error)await sbClient.from('sessions').update({paid:true}).in('id',session_ids);
      await loadSessions();renderSessionsTab();renderCashSessionPicker();loadCashPayments();renderDashboard();
    }
  });
  await loadSessions();renderSessionsTab();renderCashSessionPicker();loadCashPayments();renderDashboard();
}
// ‚îÄ‚îÄ‚îÄ CASH FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cashFilters={status:'all',month:'all',sort:'date-desc'};
let bankFilters={status:'all',client:'all',month:'all',sort:'date-desc'};

function applyCashFilters(){
  cashFilters.status=document.getElementById('cash-filter-status')?.value||'all';
  cashFilters.month=document.getElementById('cash-filter-month')?.value||'all';
  cashFilters.sort=document.getElementById('cash-sort')?.value||'date-desc';
  loadCashPayments();
}
function clearCashFilters(){
  cashFilters={status:'all',month:'all',sort:'date-desc'};
  ['cash-filter-status','cash-filter-month','cash-sort'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=el.id==='cash-sort'?'date-desc':'all';});
  loadCashPayments();
}
function applyBankFilters(){
  bankFilters.status=document.getElementById('bank-filter-status')?.value||'all';
  bankFilters.client=document.getElementById('bank-filter-client')?.value||'all';
  bankFilters.month=document.getElementById('bank-filter-month')?.value||'all';
  bankFilters.sort=document.getElementById('bank-sort')?.value||'date-desc';
  loadVVPayments();
}
function clearBankFilters(){
  bankFilters={status:'all',client:'all',month:'all',sort:'date-desc'};
  ['bank-filter-status','bank-filter-client','bank-filter-month','bank-sort'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=el.id==='bank-sort'?'date-desc':'all';});
  loadVVPayments();
}
function populateBankFilterDropdowns(payments){
  const clientSel=document.getElementById('bank-filter-client');
  if(clientSel){
    const names=[...new Set(payments.flatMap(p=>(p.session_ids||[]).map(sid=>{const s=sessions.find(x=>x.id===sid);return s?clientName(s.client_id):null;}).filter(Boolean)))].sort();
    clientSel.innerHTML='<option value="all">All clients</option>'+names.map(n=>`<option value="${n}">${n}</option>`).join('');
    if(bankFilters.client!=='all')clientSel.value=bankFilters.client;
  }
  const monthSel=document.getElementById('bank-filter-month');
  if(monthSel){
    const months=[...new Set(payments.map(p=>p.date.substring(0,7)))].sort((a,b)=>b.localeCompare(a));
    monthSel.innerHTML='<option value="all">All months</option>'+months.map(m=>{const[y,mo]=m.split('-');return`<option value="${m}">${new Date(Number(y),Number(mo)-1,1).toLocaleDateString('en-IL',{month:'long',year:'numeric'})}</option>`;}).join('');
    if(bankFilters.month!=='all')monthSel.value=bankFilters.month;
  }
}
function populateCashFilterDropdowns(payments){
  const monthSel=document.getElementById('cash-filter-month');
  if(monthSel){
    const months=[...new Set(payments.map(p=>p.date.substring(0,7)))].sort((a,b)=>b.localeCompare(a));
    monthSel.innerHTML='<option value="all">All months</option>'+months.map(m=>{const[y,mo]=m.split('-');return`<option value="${m}">${new Date(Number(y),Number(mo)-1,1).toLocaleDateString('en-IL',{month:'long',year:'numeric'})}</option>`;}).join('');
    if(cashFilters.month!=='all')monthSel.value=cashFilters.month;
  }
}

async function loadCashPayments(){
  const{data}=await sbClient.from('cash_payments').select('*').order('date',{ascending:false});
  const all=data||[];
  populateCashFilterDropdowns(all);
  let filtered=[...all];
  if(cashFilters.status==='pending')filtered=filtered.filter(p=>!p.paid_to_vv);
  else if(cashFilters.status==='paid')filtered=filtered.filter(p=>p.paid_to_vv);
  if(cashFilters.month!=='all')filtered=filtered.filter(p=>p.date.startsWith(cashFilters.month));
  const[sc,sd]=cashFilters.sort.split('-');
  filtered.sort((a,b)=>{
    if(sc==='date')return sd==='asc'?(a.date>b.date?1:-1):(a.date<b.date?1:-1);
    if(sc==='amount')return sd==='asc'?Number(a.vv_owed)-Number(b.vv_owed):Number(b.vv_owed)-Number(a.vv_owed);
    return 0;
  });
  renderCashNeedsAttention(filtered);
}

function renderCashNeedsAttention(payments){
  const el=document.getElementById('cash-needs-attention');
  const pending=payments.filter(p=>!p.paid_to_vv);
  if(!pending.length){el.innerHTML=`<div class="card"><div class="empty-state" style="padding:1.25rem"><div class="icon">‚úÖ</div>No pending VV payments</div></div>`;return;}
  el.innerHTML=pending.map(p=>{
    const lines=(p.session_ids||[]).map(sid=>{
      const s=sessions.find(x=>x.id===sid);if(!s)return'';
      const c=clients.find(c=>c.id===s.client_id);
      return`<div class="batch-session-row"><span style="font-weight:600;min-width:90px">${c?c.name:'?'}</span><span style="color:var(--text-muted)">${fmtDateShort(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;color:var(--green)">‚Ç™${Math.round(NET(clientRate(s.client_id)))} net</span><button onclick="removeFromCashBatch('${p.id}','${sid}')" style="margin-left:.75rem;background:var(--red-soft);color:var(--red);border:none;padding:.18rem .55rem;font-size:.7rem;border-radius:5px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600">‚úï remove</button></div>`;
    }).join('');
    return`<div class="batch-card" id="cpb-${p.id}">
      <div class="batch-header" onclick="toggleBatch('cpb-${p.id}')">
        <div class="batch-header-left">
          <span style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--text-muted)">${fmtDate(p.date)}</span>
          <span style="font-size:.7rem;color:var(--text-dim)">${p.session_ids.length} session${p.session_ids.length!==1?'s':''} ¬∑ tap to expand</span>
          <span style="font-family:'DM Mono',monospace;font-size:.95rem;font-weight:500;color:var(--amber)">‚Ç™${Math.round(Number(p.vv_owed))} owed to VV</span>
        </div>
        <div class="batch-header-right">
          <label class="toggle-wrap" onclick="event.stopPropagation()">
            <label class="toggle"><input type="checkbox" ${p.paid_to_vv?'checked':''} onchange="toggleCashPaidVV('${p.id}',this.checked)"><span class="toggle-slider"></span></label>
            <span style="font-size:.73rem;color:var(--text-muted)">${p.paid_to_vv?'Paid VV':'Pending'}</span>
          </label>
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteCashPayment('${p.id}',JSON.parse(this.dataset.ids))" data-ids="${JSON.stringify(p.session_ids).replace(/"/g,'&quot;')}">üóëÔ∏è Delete</button>
          <span class="batch-chevron">‚ñº</span>
        </div>
      </div>
      <div class="batch-sessions-list">
        ${lines||'<div class="batch-session-row" style="color:var(--text-dim)">No session details found</div>'}
        <div class="batch-totals">
          <span>Gross: <strong style="color:var(--text);font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.total))}</strong></span>
          <span>You kept (85%): <strong style="color:var(--green);font-family:'DM Mono',monospace">‚Ç™${Math.round(NET(Number(p.total)))}</strong></span>
          <span>VV owed (15%): <strong style="color:var(--amber);font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.vv_owed))}</strong></span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleBatch(id){document.getElementById(id)?.classList.toggle('open');}

async function deleteCashPayment(id,sessionIds){
  if(!confirm('Delete this payment batch? Sessions will go back to unpaid.'))return;
  await sbClient.from('sessions').update({paid:false}).in('id',sessionIds);
  const{error}=await sbClient.from('cash_payments').delete().eq('id',id);
  if(error){toast('Error: '+error.message,'error');return;}
  toast('Batch deleted ‚úì','success');
  await loadSessions();renderSessionsTab();renderCashSessionPicker();loadCashPayments();renderDashboard();
}
async function toggleCashPaidVV(id,checked){
  await sbClient.from('cash_payments').update({paid_to_vv:checked}).eq('id',id);
  toast(checked?'Marked paid to VV ‚úì':'Marked pending','success');
  loadCashPayments();renderDashboard();
}
async function removeFromCashBatch(batchId,sessionId){
  const{data:batch}=await sbClient.from('cash_payments').select('*').eq('id',batchId).single();
  if(!batch){toast('Could not load batch','error');return;}
  const newIds=batch.session_ids.filter(id=>id!==sessionId);
  await sbClient.from('sessions').update({paid:false}).eq('id',sessionId);
  if(newIds.length===0){
    await sbClient.from('cash_payments').delete().eq('id',batchId);
    toast('Session removed ‚Äî empty batch deleted ‚úì','success');
  } else {
    const gross=sessions.filter(s=>newIds.includes(s.id)).reduce((sum,s)=>sum+clientRate(s.client_id),0);
    await sbClient.from('cash_payments').update({session_ids:newIds,total:gross,vv_owed:gross*VV_CUT}).eq('id',batchId);
    toast('Session removed from batch ‚úì','success');
  }
  await loadSessions();renderSessionsTab();renderCashSessionPicker();loadCashPayments();renderDashboard();
}

// ‚îÄ‚îÄ‚îÄ BANK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderVVSessionPicker(){
  const el=document.getElementById('vv-session-picker');
  const ids=clients.filter(c=>c.type==='bank'&&!c.archived).map(c=>c.id);
  const unpaid=sessions.filter(s=>!s.paid&&getSessionStatus(s)==='happened'&&ids.includes(s.client_id));
  if(!unpaid.length){el.innerHTML=`<div class="empty-state" style="padding:1.25rem"><div class="icon">‚úì</div>No pending bank sessions</div>`;document.getElementById('vv-summary').style.display='none';return;}
  el.innerHTML=`<div class="session-picker">${unpaid.map(s=>{
    const c=clients.find(c=>c.id===s.client_id);
    return`<label class="session-check-item"><input type="checkbox" value="${s.id}" data-rate="${c?c.rate:0}" onchange="updateVVSummary()"><span style="font-weight:600">${c?c.name:'?'}</span><span style="color:var(--text-muted);font-size:.77rem">${fmtDateShort(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(NET(c.rate)):'?'} net</span></label>`;
  }).join('')}</div>`;
  updateVVSummary();
}
function updateVVSummary(){
  const checked=document.querySelectorAll('#vv-session-picker input:checked');
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  document.querySelectorAll('#vv-session-picker .session-check-item').forEach(item=>item.classList.toggle('selected',item.querySelector('input').checked));
  document.getElementById('vv-summary').style.display=checked.length>0?'flex':'none';
  document.getElementById('vv-count').textContent=checked.length;
  document.getElementById('vv-total').textContent='‚Ç™'+Math.round(gross);
  document.getElementById('vv-you-get').textContent='‚Ç™'+Math.round(NET(gross));
}
async function recordVVPayment(){
  const checked=[...document.querySelectorAll('#vv-session-picker input:checked')];
  if(!checked.length){toast('Select at least one session','error');return;}
  const date=document.getElementById('vv-payment-date').value;
  if(!date){toast('Select a date','error');return;}
  const session_ids=checked.map(cb=>cb.value);
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  const{error}=await sbClient.from('vv_payments').insert({date,session_ids,total:gross,you_get:NET(gross),receipt_sent:false});
  if(error){toast('Error: '+error.message,'error');return;}
  await sbClient.from('sessions').update({paid:true}).in('id',session_ids);
  toast('Bank transfer recorded ‚úì','success');
  const {data:newVV}=await sbClient.from('vv_payments').select('*').eq('date',date).order('created_at',{ascending:false}).limit(1).single();
  pushUndo({
    label:'Record bank transfer ('+session_ids.length+' sessions)',
    undo:async()=>{
      if(newVV){await sbClient.from('sessions').update({paid:false}).in('id',session_ids);await sbClient.from('vv_payments').delete().eq('id',newVV.id);}
      await loadSessions();renderSessionsTab();renderVVSessionPicker();loadVVPayments();renderDashboard();
    },
    redo:async()=>{
      const{error}=await sbClient.from('vv_payments').insert({date,session_ids,total:gross,you_get:NET(gross),receipt_sent:false});
      if(!error)await sbClient.from('sessions').update({paid:true}).in('id',session_ids);
      await loadSessions();renderSessionsTab();renderVVSessionPicker();loadVVPayments();renderDashboard();
    }
  });
  await loadSessions();renderSessionsTab();renderVVSessionPicker();loadVVPayments();renderDashboard();
}
async function loadVVPayments(){
  const{data}=await sbClient.from('vv_payments').select('*').order('date',{ascending:false});
  const all=data||[];
  populateBankFilterDropdowns(all);
  let filtered=[...all];
  if(bankFilters.status==='pending')filtered=filtered.filter(p=>!p.receipt_sent);
  else if(bankFilters.status==='sent')filtered=filtered.filter(p=>p.receipt_sent);
  if(bankFilters.client!=='all')filtered=filtered.filter(p=>(p.session_ids||[]).some(sid=>{const s=sessions.find(x=>x.id===sid);return s&&clientName(s.client_id)===bankFilters.client;}));
  if(bankFilters.month!=='all')filtered=filtered.filter(p=>p.date.startsWith(bankFilters.month));
  const[sc,sd]=bankFilters.sort.split('-');
  filtered.sort((a,b)=>{
    if(sc==='date')return sd==='asc'?(a.date>b.date?1:-1):(a.date<b.date?1:-1);
    if(sc==='amount')return sd==='asc'?Number(a.you_get)-Number(b.you_get):Number(b.you_get)-Number(a.you_get);
    return 0;
  });
  renderBankNeedsReceipt(filtered);
}

function renderBankNeedsReceipt(payments){
  const el=document.getElementById('bank-needs-receipt');
  if(!payments.length){el.innerHTML=`<div class="card"><div class="empty-state" style="padding:1.25rem">No bank transfers recorded yet</div></div>`;return;}
  el.innerHTML=payments.map(p=>{
    const lines=(p.session_ids||[]).map(sid=>{
      const s=sessions.find(x=>x.id===sid);if(!s)return'';
      const c=clients.find(c=>c.id===s.client_id);
      return`<div class="batch-session-row"><span style="font-weight:600;min-width:110px">${c?c.name:'?'}</span><span style="color:var(--text-muted)">${fmtDateShort(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;color:var(--green)">‚Ç™${Math.round(NET(clientRate(s.client_id)))} net</span><button onclick="removeFromBankBatch('${p.id}','${sid}')" style="margin-left:.75rem;background:var(--red-soft);color:var(--red);border:none;padding:.18rem .55rem;font-size:.7rem;border-radius:5px;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600">‚úï remove</button></div>`;
    }).join('');
    const clientNames=[...new Set((p.session_ids||[]).map(sid=>{const s=sessions.find(x=>x.id===sid);return s?clientName(s.client_id):null;}).filter(Boolean))].join(', ');
    return`<div class="batch-card" id="bkb-${p.id}" style="${p.receipt_sent?'border-left:3px solid var(--green)':'border-left:3px solid var(--amber)'}">
      <div class="batch-header" onclick="toggleBatch('bkb-${p.id}')">
        <div class="batch-header-left">
          <span style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--text-muted)">${fmtDate(p.date)}</span>
          <span style="font-weight:600;font-size:.88rem">${clientNames||'‚Äî'}</span>
          <span style="font-size:.7rem;color:var(--text-dim)">${p.session_ids.length} session${p.session_ids.length!==1?'s':''} ¬∑ tap to expand</span>
        </div>
        <div class="batch-header-right">
          <span style="font-family:'DM Mono',monospace;font-size:.95rem;font-weight:500;color:var(--green)">‚Ç™${Math.round(Number(p.you_get))} net</span>
          <label class="toggle-wrap" onclick="event.stopPropagation()">
            <label class="toggle"><input type="checkbox" ${p.receipt_sent?'checked':''} onchange="toggleVVReceipt('${p.id}',this.checked)"><span class="toggle-slider"></span></label>
            <span style="font-size:.73rem;color:var(--text-muted)">${p.receipt_sent?'Receipt sent':'No receipt'}</span>
          </label>
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteVVPayment('${p.id}',JSON.parse(this.dataset.ids))" data-ids="${JSON.stringify(p.session_ids).replace(/"/g,'&quot;')}">üóëÔ∏è Delete</button>
          <span class="batch-chevron">‚ñº</span>
        </div>
      </div>
      <div class="batch-sessions-list">
        ${lines||'<div class="batch-session-row" style="color:var(--text-dim)">No session details found</div>'}
        <div class="batch-totals">
          <span>Full rate: <strong style="color:var(--text);font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.total))}</strong></span>
          <span>You get (85%): <strong style="color:var(--green);font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.you_get))}</strong></span>
        </div>
      </div>
    </div>`;
  }).join('');
}

async function deleteVVPayment(id,sessionIds){
  if(!confirm('Delete this payment batch? Sessions will go back to unpaid.'))return;
  await sbClient.from('sessions').update({paid:false}).in('id',sessionIds);
  const{error}=await sbClient.from('vv_payments').delete().eq('id',id);
  if(error){toast('Error: '+error.message,'error');return;}
  toast('Batch deleted ‚úì','success');
  await loadSessions();renderSessionsTab();renderVVSessionPicker();loadVVPayments();renderDashboard();
}
async function toggleVVReceipt(id,checked){
  await sbClient.from('vv_payments').update({receipt_sent:checked}).eq('id',id);
  toast(checked?'Receipt marked as sent ‚úì':'Marked as not sent','success');
  loadVVPayments();renderDashboard();
}
async function removeFromBankBatch(batchId,sessionId){
  const{data:batch}=await sbClient.from('vv_payments').select('*').eq('id',batchId).single();
  if(!batch){toast('Could not load batch','error');return;}
  const newIds=batch.session_ids.filter(id=>id!==sessionId);
  await sbClient.from('sessions').update({paid:false}).eq('id',sessionId);
  if(newIds.length===0){
    await sbClient.from('vv_payments').delete().eq('id',batchId);
    toast('Session removed ‚Äî empty batch deleted ‚úì','success');
  } else {
    const gross=sessions.filter(s=>newIds.includes(s.id)).reduce((sum,s)=>sum+clientRate(s.client_id),0);
    await sbClient.from('vv_payments').update({session_ids:newIds,total:gross,you_get:NET(gross)}).eq('id',batchId);
    toast('Session removed from batch ‚úì','success');
  }
  await loadSessions();renderSessionsTab();renderVVSessionPicker();loadVVPayments();renderDashboard();
}

// ‚îÄ‚îÄ‚îÄ RECORDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderRecordsTab(){
  const el=document.getElementById('records-content');
  el.innerHTML='<div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div>';
  const{data:cashAll}=await sbClient.from('cash_payments').select('*').eq('paid_to_vv',true).order('date',{ascending:false});
  const{data:vvAll}=await sbClient.from('vv_payments').select('*').eq('receipt_sent',true).order('date',{ascending:false});
  const viewMode=document.getElementById('records-view')?.value||'month';
  if(viewMode==='month')renderRecordsByMonth(el,cashAll||[],vvAll||[]);
  else renderRecordsByBatch(el,cashAll||[],vvAll||[]);
}
function renderRecordsByMonth(el,cash,bank){
  const months={};
  cash.forEach(p=>{const k=p.date.substring(0,7);if(!months[k])months[k]={cash:0,bank:0};months[k].cash+=Number(p.total);});
  bank.forEach(p=>{const k=p.date.substring(0,7);if(!months[k])months[k]={cash:0,bank:0};months[k].bank+=Number(p.total);});
  const keys=Object.keys(months).sort((a,b)=>a<b?1:-1);
  if(!keys.length){el.innerHTML=`<div class="empty-state"><div class="icon">üìÅ</div>No completed records yet</div>`;return;}
  el.innerHTML=keys.map(k=>{
    const m=months[k];
    const[y,mo]=k.split('-');
    return`<div class="card" style="margin-bottom:.75rem">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
        <div style="font-weight:700;font-size:1rem">${fmtMonth(Number(y),Number(mo)-1)}</div>
        <div style="font-family:'DM Mono',monospace;font-size:1rem;font-weight:500;color:var(--green)">‚Ç™${Math.round(NET(m.cash+m.bank))} <span style="font-size:.7rem;color:var(--text-muted);font-family:'DM Sans',sans-serif">net</span></div>
      </div>
      <div style="display:flex;gap:1.5rem;font-size:.8rem;color:var(--text-muted)">
        ${m.cash>0?`<span>üíµ Cash: ‚Ç™${Math.round(NET(m.cash))} net</span>`:''}
        ${m.bank>0?`<span>üè¶ Bank: ‚Ç™${Math.round(NET(m.bank))} net</span>`:''}
      </div>
    </div>`;
  }).join('');
}
function renderRecordsByBatch(el,cash,bank){
  const all=[...cash.map(p=>({...p,_t:'cash'})),...bank.map(p=>({...p,_t:'bank'}))].sort((a,b)=>a.date<b.date?1:-1);
  if(!all.length){el.innerHTML=`<div class="empty-state"><div class="icon">üìÅ</div>No completed records yet</div>`;return;}
  el.innerHTML=`<div class="table-wrap"><table>
    <thead><tr><th>Date</th><th>Type</th><th>Details</th><th>Gross</th><th>Net (85%)</th></tr></thead>
    <tbody>${all.map(p=>{
      let detail=`${p.session_ids.length} sessions`;
      if(p._t==='bank'){const names=[...new Set(p.session_ids.map(sid=>{const s=sessions.find(x=>x.id===sid);return s?clientName(s.client_id):null;}).filter(Boolean))].join(', ');if(names)detail=names+` (${p.session_ids.length})`;}
      return`<tr><td style="font-family:'DM Mono',monospace;font-size:.77rem;color:var(--text-muted)">${fmtDate(p.date)}</td><td>${p._t==='cash'?'<span class="badge badge-cash">Cash</span>':'<span class="badge badge-bank">Bank</span>'}</td><td style="font-size:.82rem">${detail}</td><td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${Math.round(Number(p.total))}</td><td style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--green)">‚Ç™${Math.round(NET(Number(p.total)))}</td></tr>`;
    }).join('')}</tbody></table></div>`;
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast'+(type?' '+type:'');
  el.classList.add('show');
  setTimeout(()=>{el.classList.remove('show');el.classList.remove('clickable');},3000);
}

// responsive home grid
window.addEventListener('resize',()=>{
  const grid=document.getElementById('home-grid');
  if(grid)grid.style.gridTemplateColumns=window.innerWidth<650?'1fr':'1fr 1fr';
});
window.dispatchEvent(new Event('resize'));
</script>
</body>
</html>
