<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Practice Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #f7f4ef;
    --surface: #ffffff;
    --surface2: #f0ece4;
    --border: #e2ddd5;
    --text: #1a1714;
    --text-muted: #8a8278;
    --accent: #c4531a;
    --accent-soft: #fdf0ea;
    --green: #2d6a4f;
    --green-soft: #e8f5ef;
    --amber: #b5830a;
    --amber-soft: #fdf6e3;
    --red: #c0392b;
    --red-soft: #fdf0ee;
    --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-lg: 0 4px 16px rgba(0,0,0,0.10);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 15px;
  }

  /* CONFIG SCREEN */
  #config-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
  }
  .config-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2.5rem;
    max-width: 480px;
    width: 100%;
    box-shadow: var(--shadow-lg);
  }
  .config-box h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    margin-bottom: 0.25rem;
    color: var(--accent);
  }
  .config-box p {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
  }
  .config-box label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 0.4rem;
  }
  .config-box input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    background: var(--bg);
    color: var(--text);
    margin-bottom: 1rem;
    outline: none;
    transition: border-color 0.15s;
  }
  .config-box input:focus { border-color: var(--accent); }

  /* LAYOUT */
  #app { display: none; }
  .app-header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    gap: 2rem;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow);
  }
  .app-header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    color: var(--accent);
    white-space: nowrap;
  }
  .tabs {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
  }
  .tab-btn {
    padding: 0.5rem 1rem;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 500;
    color: var(--text-muted);
    transition: all 0.15s;
  }
  .tab-btn:hover { background: var(--surface2); color: var(--text); }
  .tab-btn.active { background: var(--accent); color: white; }

  .main { padding: 2rem; max-width: 960px; margin: 0 auto; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow);
  }
  .card-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--text);
  }

  /* FORMS */
  .form-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }
  .form-group { display: flex; flex-direction: column; gap: 0.35rem; flex: 1; min-width: 140px; }
  .form-group label {
    font-size: 0.78rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
  }
  select, input[type="date"], input[type="text"], input[type="number"] {
    padding: 0.65rem 0.9rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    background: var(--bg);
    color: var(--text);
    outline: none;
    transition: border-color 0.15s;
    width: 100%;
  }
  select:focus, input:focus { border-color: var(--accent); }

  /* BUTTONS */
  .btn {
    padding: 0.65rem 1.25rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    font-size: 0.88rem;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #a8441400; filter: brightness(0.9); }
  .btn-primary:hover { filter: brightness(0.92); }
  .btn-sm { padding: 0.4rem 0.85rem; font-size: 0.82rem; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: var(--red-soft); color: var(--red); border: 1px solid #f5c6c3; }
  .btn-success { background: var(--green-soft); color: var(--green); border: 1px solid #b7dfcc; }

  /* TABLES */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
  th {
    text-align: left;
    padding: 0.6rem 0.9rem;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }
  td { padding: 0.7rem 0.9rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  /* BADGES */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.7rem;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 500;
    white-space: nowrap;
  }
  .badge-green { background: var(--green-soft); color: var(--green); }
  .badge-red { background: var(--red-soft); color: var(--red); }
  .badge-amber { background: var(--amber-soft); color: var(--amber); }
  .badge-cash { background: #e8f4fd; color: #1565c0; }
  .badge-vv { background: #f3e8fd; color: #6a1b9a; }

  /* TOGGLE */
  .toggle-wrap { display: flex; align-items: center; gap: 0.5rem; }
  .toggle {
    position: relative;
    width: 36px;
    height: 20px;
    cursor: pointer;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 20px;
    transition: 0.2s;
  }
  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 14px;
    height: 14px;
    left: 3px;
    top: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.2s;
  }
  .toggle input:checked + .toggle-slider { background: var(--green); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

  /* SESSIONS GRID */
  .client-section { margin-bottom: 1.5rem; }
  .client-section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border);
  }
  .client-section-header h3 {
    font-family: 'DM Serif Display', serif;
    font-size: 1rem;
  }

  /* PAYMENT BUILDER */
  .session-picker {
    display: grid;
    gap: 0.5rem;
    max-height: 260px;
    overflow-y: auto;
    padding: 0.5rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 0.75rem;
  }
  .session-check-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .session-check-item:hover { border-color: var(--accent); }
  .session-check-item.selected { border-color: var(--accent); background: var(--accent-soft); }
  .session-check-item input[type="checkbox"] { accent-color: var(--accent); }

  .summary-box {
    background: var(--surface2);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    font-size: 0.88rem;
  }
  .summary-box .item { display: flex; flex-direction: column; gap: 0.2rem; }
  .summary-box .item span:first-child { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .summary-box .item strong { font-size: 1.1rem; font-family: 'DM Mono', monospace; }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--text);
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 10px;
    font-size: 0.88rem;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.25s;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  .section-header h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
  }

  .filter-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  .filter-btn {
    padding: 0.4rem 0.9rem;
    border: 1px solid var(--border);
    border-radius: 20px;
    background: none;
    cursor: pointer;
    font-size: 0.82rem;
    font-family: 'DM Sans', sans-serif;
    color: var(--text-muted);
    transition: all 0.15s;
  }
  .filter-btn.active { background: var(--text); color: white; border-color: var(--text); }

  .loading { text-align: center; padding: 2rem; color: var(--text-muted); }

  @media (max-width: 600px) {
    .app-header { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.75rem; }
    .main { padding: 1rem; }
    .form-row { flex-direction: column; }
    .form-group { min-width: 100%; }
  }
</style>
</head>
<body>

<!-- CONFIG SCREEN -->
<div id="config-screen">
  <div class="config-box">
    <h1>Practice Tracker</h1>
    <p>Enter your Supabase credentials to get started. These are saved in your browser.</p>
    <label>Supabase URL</label>
    <input type="text" id="sb-url" placeholder="https://xxxx.supabase.co">
    <label>Supabase Anon Key</label>
    <input type="text" id="sb-key" placeholder="eyJ...">
    <button class="btn btn-primary" style="width:100%" onclick="initApp()">Connect</button>
    <p id="config-error" style="color:var(--red);margin-top:0.75rem;font-size:0.85rem;display:none"></p>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <div class="app-header">
    <h1>Practice Tracker</h1>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('sessions')">Sessions</button>
      <button class="tab-btn" onclick="switchTab('clients')">Clients</button>
      <button class="tab-btn" onclick="switchTab('cash-payments')">Cash Payments</button>
      <button class="tab-btn" onclick="switchTab('vv-payments')">VV Payments</button>
    </div>
  </div>

  <div class="main">

    <!-- SESSIONS TAB -->
    <div id="tab-sessions" class="tab-content active">
      <div class="section-header">
        <h2>Sessions</h2>
      </div>

      <div class="card">
        <div class="card-title">Log a Session</div>
        <div class="form-row">
          <div class="form-group">
            <label>Client</label>
            <select id="session-client"></select>
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="session-date">
          </div>
          <button class="btn btn-primary" onclick="addSession()" style="margin-bottom:0">Add Session</button>
        </div>
      </div>

      <div class="filter-row">
        <button class="filter-btn active" onclick="filterSessions('all',this)">All</button>
        <button class="filter-btn" onclick="filterSessions('unpaid',this)">Unpaid</button>
        <button class="filter-btn" onclick="filterSessions('paid',this)">Paid</button>
      </div>

      <div id="sessions-list" class="card">
        <div class="loading">Loading sessions...</div>
      </div>
    </div>

    <!-- CLIENTS TAB -->
    <div id="tab-clients" class="tab-content">
      <div class="section-header">
        <h2>Clients</h2>
      </div>

      <div class="card">
        <div class="card-title">Add Client</div>
        <div class="form-row">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="client-name" placeholder="e.g. Miki">
          </div>
          <div class="form-group">
            <label>Payment Type</label>
            <select id="client-type">
              <option value="cash">Cash</option>
              <option value="vv">VV (Bank Transfer)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Rate (â‚ª)</label>
            <input type="number" id="client-rate" placeholder="420">
          </div>
          <button class="btn btn-primary" onclick="addClient()">Add</button>
        </div>
      </div>

      <div id="clients-list" class="card">
        <div class="loading">Loading clients...</div>
      </div>
    </div>

    <!-- CASH PAYMENTS TAB -->
    <div id="tab-cash-payments" class="tab-content">
      <div class="section-header">
        <h2>Cash Payments</h2>
      </div>

      <div class="card">
        <div class="card-title">Record Cash Payment Received</div>
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem">Select unpaid sessions from cash clients. You'll receive the total and owe VV 15%.</p>

        <div id="cash-session-picker">
          <div class="loading">Loading sessions...</div>
        </div>

        <div class="summary-box" id="cash-summary" style="display:none">
          <div class="item"><span>Sessions</span><strong id="cash-count">0</strong></div>
          <div class="item"><span>Total You Receive</span><strong id="cash-total">â‚ª0</strong></div>
          <div class="item"><span>You Owe VV (15%)</span><strong id="cash-vv-owed" style="color:var(--accent)">â‚ª0</strong></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Date Received</label>
            <input type="date" id="cash-payment-date">
          </div>
          <button class="btn btn-primary" onclick="recordCashPayment()">Record Payment</button>
        </div>
      </div>

      <div id="cash-payments-list" class="card">
        <div class="loading">Loading payments...</div>
      </div>
    </div>

    <!-- VV PAYMENTS TAB -->
    <div id="tab-vv-payments" class="tab-content">
      <div class="section-header">
        <h2>VV Payments</h2>
      </div>

      <!-- Mark sessions as paid to VV -->
      <div class="card">
        <div class="card-title">Record VV Payment Received</div>
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem">Select sessions where clients have already paid VV. VV sends you 85% â€” record when you receive it.</p>

        <div id="vv-session-picker">
          <div class="loading">Loading sessions...</div>
        </div>

        <div class="summary-box" id="vv-summary" style="display:none">
          <div class="item"><span>Sessions</span><strong id="vv-count">0</strong></div>
          <div class="item"><span>Total Billed to VV</span><strong id="vv-total">â‚ª0</strong></div>
          <div class="item"><span>You Receive (85%)</span><strong id="vv-you-get" style="color:var(--green)">â‚ª0</strong></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Date Received from VV</label>
            <input type="date" id="vv-payment-date">
          </div>
          <button class="btn btn-primary" onclick="recordVVPayment()">Record Payment</button>
        </div>
      </div>

      <div id="vv-payments-list" class="card">
        <div class="loading">Loading payments...</div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<div id="toast" class="toast"></div>

<script>
let sbClient;
let clients = [];
let sessions = [];
let currentSessionFilter = 'all';

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initApp() {
  const url = document.getElementById('sb-url').value.trim();
  const key = document.getElementById('sb-key').value.trim();
  if (!url || !key) { showConfigError('Both fields required.'); return; }
  showConfigError('Connecting...');
  try {
    sbClient = window.supabase.createClient(url, key);
    // Test the connection
    const { data, error } = await sbClient.from('clients').select('count', { count: 'exact', head: true });
    if (error) { showConfigError('Connection failed: ' + error.message); return; }
    localStorage.setItem('sb_url', url);
    localStorage.setItem('sb_key', key);
    document.getElementById('config-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadAll();
  } catch(e) { showConfigError('Error: ' + e.message); }
}
function showConfigError(msg) {
  const el = document.getElementById('config-error');
  el.textContent = msg; el.style.display = 'block';
}

// Auto-connect from localStorage
window.addEventListener('load', () => {
  const url = localStorage.getItem('sb_url');
  const key = localStorage.getItem('sb_key');
  if (url && key) {
    document.getElementById('sb-url').value = url;
    document.getElementById('sb-key').value = key;
    initApp();
  }
  // Set today as default date
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('session-date').value = today;
  document.getElementById('cash-payment-date').value = today;
  document.getElementById('vv-payment-date').value = today;
});

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.target.classList.add('active');
  if (name === 'cash-payments') renderCashSessionPicker();
  if (name === 'vv-payments') renderVVSessionPicker();
}

// â”€â”€ LOAD ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
  await loadClients();
  await loadSessions();
  renderSessionsTab();
  renderClientsTab();
  loadCashPayments();
  loadVVPayments();
}

async function loadClients() {
  const { data } = await sbClient.from('clients').select('*').order('name');
  clients = data || [];
  populateClientSelects();
}

async function loadSessions() {
  const { data } = await sbClient.from('sessions').select('*').order('date', { ascending: false });
  sessions = data || [];
}

function populateClientSelects() {
  const sel = document.getElementById('session-client');
  sel.innerHTML = clients.length
    ? clients.map(c => `<option value="${c.id}">${c.name} (${c.type === 'cash' ? 'Cash' : 'VV'} Â· â‚ª${c.rate})</option>`).join('')
    : '<option value="">No clients yet</option>';
}

// â”€â”€ SESSIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addSession() {
  const client_id = document.getElementById('session-client').value;
  const date = document.getElementById('session-date').value;
  if (!client_id || !date) { toast('Fill all fields'); return; }

  const { error } = await sbClient.from('sessions').insert({ client_id, date, paid: false });
  if (error) { toast('Error: ' + error.message); return; }
  toast('Session logged âœ“');
  await loadSessions();
  renderSessionsTab();
  renderCashSessionPicker();
  renderVVSessionPicker();
}

function filterSessions(filter, btn) {
  currentSessionFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderSessionsTab();
}

function renderSessionsTab() {
  const el = document.getElementById('sessions-list');
  let list = sessions;
  if (currentSessionFilter === 'unpaid') list = sessions.filter(s => !s.paid);
  if (currentSessionFilter === 'paid') list = sessions.filter(s => s.paid);

  if (!list.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div>No sessions yet</div>';
    return;
  }

  el.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Date</th><th>Client</th><th>Type</th><th>Rate</th><th>Status</th><th></th>
    </tr></thead>
    <tbody>
      ${list.map(s => {
        const c = clients.find(c => c.id === s.client_id);
        return `<tr>
          <td style="font-family:'DM Mono',monospace;font-size:0.85rem">${s.date}</td>
          <td><strong>${c ? c.name : 'â€”'}</strong></td>
          <td>${c ? (c.type === 'cash' ? '<span class="badge badge-cash">Cash</span>' : '<span class="badge badge-vv">VV</span>') : ''}</td>
          <td style="font-family:'DM Mono',monospace">â‚ª${c ? c.rate : 'â€”'}</td>
          <td>${s.paid ? '<span class="badge badge-green">âœ“ Paid</span>' : '<span class="badge badge-amber">Pending</span>'}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteSession('${s.id}')">Delete</button></td>
        </tr>`;
      }).join('')}
    </tbody>
  </table></div>`;
}

async function deleteSession(id) {
  if (!confirm('Delete this session?')) return;
  const { error } = await sbClient.from('sessions').delete().eq('id', id);
  if (error) { toast('Error: ' + error.message); return; }
  toast('Session deleted');
  await loadSessions();
  renderSessionsTab();
  renderCashSessionPicker();
  renderVVSessionPicker();
}

// â”€â”€ CLIENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addClient() {
  const name = document.getElementById('client-name').value.trim();
  const type = document.getElementById('client-type').value;
  const rate = parseFloat(document.getElementById('client-rate').value);
  if (!name || !rate) { toast('Fill all fields'); return; }

  const { error } = await sbClient.from('clients').insert({ name, type, rate });
  if (error) { toast('Error: ' + error.message); return; }
  toast('Client added âœ“');
  document.getElementById('client-name').value = '';
  document.getElementById('client-rate').value = '';
  await loadClients();
  renderClientsTab();
}

function renderClientsTab() {
  const el = document.getElementById('clients-list');
  if (!clients.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¤</div>No clients yet</div>';
    return;
  }
  el.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Name</th><th>Type</th><th>Rate</th><th>Sessions</th></tr></thead>
    <tbody>
      ${clients.map(c => {
        const count = sessions.filter(s => s.client_id === c.id).length;
        return `<tr>
          <td><strong>${c.name}</strong></td>
          <td>${c.type === 'cash' ? '<span class="badge badge-cash">Cash</span>' : '<span class="badge badge-vv">VV</span>'}</td>
          <td style="font-family:'DM Mono',monospace">â‚ª${c.rate}</td>
          <td>${count}</td>
        </tr>`;
      }).join('')}
    </tbody>
  </table></div>`;
}

// â”€â”€ CASH SESSION PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCashSessionPicker() {
  const el = document.getElementById('cash-session-picker');
  const cashClientIds = clients.filter(c => c.type === 'cash').map(c => c.id);
  const unpaid = sessions.filter(s => !s.paid && cashClientIds.includes(s.client_id));

  if (!unpaid.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">âœ“</div>No unpaid cash sessions</div>';
    document.getElementById('cash-summary').style.display = 'none';
    return;
  }

  el.innerHTML = `<div class="session-picker">
    ${unpaid.map(s => {
      const c = clients.find(c => c.id === s.client_id);
      return `<label class="session-check-item" id="csi-${s.id}">
        <input type="checkbox" value="${s.id}" data-rate="${c ? c.rate : 0}" onchange="updateCashSummary()">
        <span><strong>${c ? c.name : '?'}</strong></span>
        <span style="color:var(--text-muted);font-size:0.85rem">${s.date}</span>
        <span style="margin-left:auto;font-family:'DM Mono',monospace">â‚ª${c ? c.rate : '?'}</span>
      </label>`;
    }).join('')}
  </div>`;
  updateCashSummary();
}

function updateCashSummary() {
  const checked = document.querySelectorAll('#cash-session-picker input:checked');
  let total = 0;
  checked.forEach(cb => { total += parseFloat(cb.dataset.rate || 0); });
  document.querySelectorAll('#cash-session-picker .session-check-item').forEach(item => {
    item.classList.toggle('selected', item.querySelector('input').checked);
  });
  const show = checked.length > 0;
  document.getElementById('cash-summary').style.display = show ? 'flex' : 'none';
  document.getElementById('cash-count').textContent = checked.length;
  document.getElementById('cash-total').textContent = 'â‚ª' + total.toFixed(0);
  document.getElementById('cash-vv-owed').textContent = 'â‚ª' + (total * 0.15).toFixed(0);
}

async function recordCashPayment() {
  const checked = [...document.querySelectorAll('#cash-session-picker input:checked')];
  if (!checked.length) { toast('Select at least one session'); return; }
  const date = document.getElementById('cash-payment-date').value;
  if (!date) { toast('Select a date'); return; }

  const session_ids = checked.map(cb => cb.value);
  let total = 0;
  checked.forEach(cb => total += parseFloat(cb.dataset.rate || 0));
  const vv_owed = total * 0.15;

  const { error } = await sbClient.from('cash_payments').insert({
    date, session_ids, total, vv_owed, paid_to_vv: false,
    client_id: null
  });
  if (error) { toast('Error: ' + error.message); return; }

  // Mark sessions as paid
  await sbClient.from('sessions').update({ paid: true }).in('id', session_ids);

  toast('Cash payment recorded âœ“');
  await loadSessions();
  renderSessionsTab();
  renderCashSessionPicker();
  loadCashPayments();
}

// â”€â”€ CASH PAYMENTS LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCashPayments() {
  const { data } = await sbClient.from('cash_payments').select('*').order('date', { ascending: false });
  renderCashPaymentsList(data || []);
}

function renderCashPaymentsList(payments) {
  const el = document.getElementById('cash-payments-list');
  if (!payments.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’µ</div>No cash payments recorded</div>';
    return;
  }
  el.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Date</th><th>Sessions</th><th>Total Received</th><th>VV Owed (15%)</th><th>Paid VV?</th>
    </tr></thead>
    <tbody>
      ${payments.map(p => `<tr>
        <td style="font-family:'DM Mono',monospace;font-size:0.85rem">${p.date}</td>
        <td>${p.session_ids.length} session${p.session_ids.length !== 1 ? 's' : ''}</td>
        <td style="font-family:'DM Mono',monospace">â‚ª${Number(p.total).toFixed(0)}</td>
        <td style="font-family:'DM Mono',monospace;color:var(--accent)">â‚ª${Number(p.vv_owed).toFixed(0)}</td>
        <td>
          <label class="toggle-wrap">
            <label class="toggle">
              <input type="checkbox" ${p.paid_to_vv ? 'checked' : ''} onchange="toggleCashPaidVV('${p.id}',this.checked)">
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:0.82rem;color:var(--text-muted)">${p.paid_to_vv ? 'Paid' : 'Pending'}</span>
          </label>
        </td>
      </tr>`).join('')}
    </tbody>
  </table></div>`;
}

async function toggleCashPaidVV(id, checked) {
  await sbClient.from('cash_payments').update({ paid_to_vv: checked }).eq('id', id);
  toast(checked ? 'Marked as paid to VV âœ“' : 'Marked as pending');
  loadCashPayments();
}

// â”€â”€ VV SESSION PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderVVSessionPicker() {
  const el = document.getElementById('vv-session-picker');
  const vvClientIds = clients.filter(c => c.type === 'vv').map(c => c.id);
  const unpaid = sessions.filter(s => !s.paid && vvClientIds.includes(s.client_id));

  if (!unpaid.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">âœ“</div>No pending VV sessions</div>';
    document.getElementById('vv-summary').style.display = 'none';
    return;
  }

  el.innerHTML = `<div class="session-picker">
    ${unpaid.map(s => {
      const c = clients.find(c => c.id === s.client_id);
      return `<label class="session-check-item">
        <input type="checkbox" value="${s.id}" data-rate="${c ? c.rate : 0}" onchange="updateVVSummary()">
        <span><strong>${c ? c.name : '?'}</strong></span>
        <span style="color:var(--text-muted);font-size:0.85rem">${s.date}</span>
        <span style="margin-left:auto;font-family:'DM Mono',monospace">â‚ª${c ? c.rate : '?'}</span>
      </label>`;
    }).join('')}
  </div>`;
  updateVVSummary();
}

function updateVVSummary() {
  const checked = document.querySelectorAll('#vv-session-picker input:checked');
  let total = 0;
  checked.forEach(cb => { total += parseFloat(cb.dataset.rate || 0); });
  document.querySelectorAll('#vv-session-picker .session-check-item').forEach(item => {
    item.classList.toggle('selected', item.querySelector('input').checked);
  });
  const show = checked.length > 0;
  document.getElementById('vv-summary').style.display = show ? 'flex' : 'none';
  document.getElementById('vv-count').textContent = checked.length;
  document.getElementById('vv-total').textContent = 'â‚ª' + total.toFixed(0);
  document.getElementById('vv-you-get').textContent = 'â‚ª' + (total * 0.85).toFixed(0);
}

async function recordVVPayment() {
  const checked = [...document.querySelectorAll('#vv-session-picker input:checked')];
  if (!checked.length) { toast('Select at least one session'); return; }
  const date = document.getElementById('vv-payment-date').value;
  if (!date) { toast('Select a date'); return; }

  const session_ids = checked.map(cb => cb.value);
  let total = 0;
  checked.forEach(cb => total += parseFloat(cb.dataset.rate || 0));
  const you_get = total * 0.85;

  const { error } = await sbClient.from('vv_payments').insert({
    date, session_ids, total, you_get
  });
  if (error) { toast('Error: ' + error.message); return; }

  await sbClient.from('sessions').update({ paid: true }).in('id', session_ids);

  toast('VV payment recorded âœ“');
  await loadSessions();
  renderSessionsTab();
  renderVVSessionPicker();
  loadVVPayments();
}

// â”€â”€ VV PAYMENTS LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVVPayments() {
  const { data } = await sbClient.from('vv_payments').select('*').order('date', { ascending: false });
  renderVVPaymentsList(data || []);
}

function renderVVPaymentsList(payments) {
  const el = document.getElementById('vv-payments-list');
  if (!payments.length) {
    el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ¦</div>No VV payments recorded</div>';
    return;
  }
  el.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Date</th><th>Sessions</th><th>Total (Full Rate)</th><th>You Received (85%)</th><th>Receipt Sent?</th>
    </tr></thead>
    <tbody>
      ${payments.map(p => `<tr>
        <td style="font-family:'DM Mono',monospace;font-size:0.85rem">${p.date}</td>
        <td>${p.session_ids.length} session${p.session_ids.length !== 1 ? 's' : ''}</td>
        <td style="font-family:'DM Mono',monospace">â‚ª${Number(p.total).toFixed(0)}</td>
        <td style="font-family:'DM Mono',monospace;color:var(--green)">â‚ª${Number(p.you_get).toFixed(0)}</td>
        <td>
          <label class="toggle-wrap">
            <label class="toggle">
              <input type="checkbox" ${p.receipt_sent ? 'checked' : ''} onchange="toggleVVReceipt('${p.id}',this.checked)">
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:0.82rem;color:var(--text-muted)">${p.receipt_sent ? 'Sent' : 'Not sent'}</span>
          </label>
        </td>
      </tr>`).join('')}
    </tbody>
  </table></div>`;
}

async function toggleVVReceipt(id, checked) {
  await sbClient.from('vv_payments').update({ receipt_sent: checked }).eq('id', id);
  toast(checked ? 'Receipt marked as sent âœ“' : 'Marked as not sent');
  loadVVPayments();
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}
</script>
</body>
</html>
