<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Practice Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f4f0;--surface:#fff;--surface2:#f0efeb;--surface3:#e8e7e2;
  --border:#dddbd4;--text:#1a1915;--muted:#6b6960;--dim:#a09e96;
  --accent:#2d6a4f;--abright:#40916c;--asoft:rgba(45,106,79,.10);--aglow:rgba(45,106,79,.18);
  --green:#2d6a4f;--gsoft:rgba(45,106,79,.12);
  --amber:#b5621a;--ambersoft:rgba(181,98,26,.12);
  --red:#c0392b;--rsoft:rgba(192,57,43,.12);
  --blue:#1d5c8a;--bsoft:rgba(29,92,138,.12);
  --shadow:0 2px 8px rgba(26,25,21,.08);--shadowlg:0 8px 32px rgba(26,25,21,.12);
  --r:10px;--rl:16px;
}
[data-theme="dark"]{
  --bg:#0f0f0d;--surface:#1a1916;--surface2:#222220;--surface3:#2a2a27;
  --border:#333330;--text:#f0ede6;--muted:#7a7870;--dim:#4a4845;
  --accent:#52b788;--abright:#74c69d;--asoft:rgba(82,183,136,.12);--aglow:rgba(82,183,136,.22);
  --green:#52b788;--gsoft:rgba(82,183,136,.12);
  --amber:#f4a261;--ambersoft:rgba(244,162,97,.12);
  --red:#e76f51;--rsoft:rgba(231,111,81,.12);
  --blue:#74b3ce;--bsoft:rgba(116,179,206,.12);
  --shadow:0 2px 8px rgba(0,0,0,.3);--shadowlg:0 8px 32px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;-webkit-font-smoothing:antialiased;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

#app{display:none;padding-bottom:80px;}
.hdr{background:var(--surface);border-bottom:1px solid var(--border);padding:.8rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow);}
.hdr h1{font-size:1rem;font-weight:700;}
.htabs{display:flex;gap:.15rem;}
.htab{padding:.4rem .85rem;border:none;background:none;cursor:pointer;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;color:var(--muted);transition:all .15s;}
.htab:hover{background:var(--surface2);color:var(--text);}
.htab.active{background:var(--asoft);color:var(--accent);font-weight:600;}
.hdr-right{display:flex;align-items:center;gap:.4rem;}
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:.4rem .25rem calc(.4rem + env(safe-area-inset-bottom));z-index:200;display:none;grid-template-columns:repeat(6,1fr);}
.bnav-btn{display:flex;flex-direction:column;align-items:center;gap:.2rem;padding:.45rem .15rem;border:none;background:none;cursor:pointer;border-radius:8px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.6rem;font-weight:500;transition:all .15s;}
.bnav-btn.active{color:var(--accent);background:var(--asoft);}
.main{padding:1.5rem;max-width:960px;margin:0 auto;}
.tab{display:none;}.tab.active{display:block;animation:fadeIn .18s ease;}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);padding:1.5rem;margin-bottom:1rem;box-shadow:var(--shadow);}
.ctitle{font-size:.72rem;font-weight:600;margin-bottom:1rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;}
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;}
.sh h2{font-size:1.25rem;font-weight:700;letter-spacing:-.01em;}
.sdiv{display:flex;align-items:center;gap:.75rem;margin:1.5rem 0 .75rem;}
.sdiv span{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);white-space:nowrap;}
.sdiv::before,.sdiv::after{content:'';flex:1;height:1px;background:var(--border);}

.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1rem;}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);padding:1.25rem 1.25rem 1rem;box-shadow:var(--shadow);border-top:3px solid var(--border);}
.sc.g{border-top-color:var(--green);}
.sc.a{border-top-color:var(--amber);}
.sc.b{border-top-color:var(--blue);}
.slabel{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--muted);margin-bottom:.5rem;}
.sval{font-family:'DM Mono',monospace;font-size:1.6rem;font-weight:500;line-height:1;}
.ssub{font-size:.68rem;color:var(--dim);margin-top:.4rem;}

.frow{display:flex;gap:.75rem;flex-wrap:wrap;align-items:flex-end;}
.fg{display:flex;flex-direction:column;gap:.35rem;flex:1;min-width:130px;}
.fg label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);}
select,input[type="date"],input[type="text"],input[type="number"]{padding:.6rem .85rem;border:1px solid var(--border);border-radius:var(--r);font-family:'DM Sans',sans-serif;font-size:.875rem;background:var(--surface2);color:var(--text);outline:none;transition:border-color .2s,box-shadow .2s;width:100%;appearance:none;-webkit-appearance:none;}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='none'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b6960' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .85rem center;padding-right:2.2rem;}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--aglow);}

.btn{padding:.6rem 1.15rem;border:none;border-radius:var(--r);cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.84rem;transition:all .15s;white-space:nowrap;display:inline-flex;align-items:center;gap:.35rem;}
.btn:active{transform:scale(.96);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-primary{background:var(--accent);color:white;}
.btn-primary:hover{background:var(--abright);}
.btn-sm{padding:.32rem .7rem;font-size:.74rem;border-radius:7px;}
.btn-ghost{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
.btn-ghost:hover:not(:disabled){background:var(--surface3);color:var(--text);}
.btn-danger{background:var(--rsoft);color:var(--red);border:none;}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted);}
.btn-outline:hover{border-color:var(--accent);color:var(--accent);}
.ico-btn{background:none;border:none;cursor:pointer;padding:.3rem .4rem;border-radius:6px;font-size:.95rem;line-height:1;color:var(--muted);transition:all .15s;}
.ico-btn:hover{background:var(--rsoft);color:var(--red);}
.edit-btn{background:none;border:none;cursor:pointer;padding:.3rem .4rem;border-radius:6px;font-size:.9rem;color:var(--muted);transition:all .15s;}
.edit-btn:hover{background:var(--bsoft);color:var(--blue);}

.tw{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.84rem;}
th{text-align:left;padding:.55rem .85rem;font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--dim);border-bottom:1px solid var(--border);background:var(--surface2);}
td{padding:.75rem .85rem;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:var(--surface2);}

.badge{display:inline-flex;align-items:center;padding:.18rem .55rem;border-radius:20px;font-size:.68rem;font-weight:600;}
.bg{background:var(--gsoft);color:var(--green);}
.ba{background:var(--ambersoft);color:var(--amber);}
.bc{background:var(--bsoft);color:var(--blue);}
.bb{background:var(--asoft);color:var(--accent);}
.bgrey{background:var(--surface3);color:var(--muted);}

.toggle{position:relative;width:34px;height:18px;cursor:pointer;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.tslider{position:absolute;inset:0;background:var(--border);border-radius:20px;transition:.2s;}
.tslider::before{content:'';position:absolute;width:12px;height:12px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s;}
.toggle input:checked+.tslider{background:var(--green);}
.toggle input:checked+.tslider::before{transform:translateX(16px);}

.picker{display:flex;flex-direction:column;gap:.35rem;max-height:240px;overflow-y:auto;padding:.5rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);margin-bottom:.75rem;}
.pitem{display:flex;align-items:center;gap:.65rem;padding:.55rem .7rem;background:var(--surface);border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:border-color .15s;}
.pitem:hover{border-color:var(--accent);}
.pitem.sel{border-color:var(--accent);background:var(--asoft);}
.pitem input[type="checkbox"]{accent-color:var(--accent);width:15px;height:15px;flex-shrink:0;min-width:unset;padding:0;border:none;background:none;}

.sumbox{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:.9rem 1.1rem;display:flex;gap:1.5rem;flex-wrap:wrap;margin-bottom:1rem;}
.sumbox .si{display:flex;flex-direction:column;gap:.2rem;}
.sumbox .si span:first-child{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;font-weight:600;}
.sumbox .si strong{font-size:1.05rem;font-family:'DM Mono',monospace;}

.fbar{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);padding:1rem 1.25rem;margin-bottom:.75rem;box-shadow:var(--shadow);}

.bcard{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);margin-bottom:.75rem;box-shadow:var(--shadow);overflow:hidden;}
.bhdr{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;cursor:pointer;transition:background .15s;gap:1rem;user-select:none;}
.bhdr:hover{background:var(--surface2);}
.bchev{color:var(--dim);font-size:.65rem;transition:transform .2s;}
.bcard.open .bchev{transform:rotate(180deg);}
.blist{display:none;border-top:1px solid var(--border);}
.bcard.open .blist{display:block;}
.brow{display:flex;align-items:center;gap:.75rem;padding:.65rem 1.25rem;border-bottom:1px solid var(--border);font-size:.82rem;background:var(--surface2);}
.brow:last-child{border-bottom:none;}
.btotals{display:flex;gap:1.5rem;flex-wrap:wrap;padding:.75rem 1.25rem;border-top:1px solid var(--border);font-size:.78rem;color:var(--muted);}

/* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
.cal-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--rl);padding:1.25rem;box-shadow:var(--shadow);}
.cal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;}
.cal-title{font-weight:700;font-size:.95rem;}
.cnav{background:none;border:1px solid var(--border);border-radius:7px;padding:.25rem .6rem;cursor:pointer;font-size:.9rem;color:var(--muted);transition:all .15s;}
.cnav:hover{background:var(--surface2);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cdl{text-align:center;font-size:.65rem;font-weight:600;color:var(--dim);text-transform:uppercase;padding:.3rem 0;}
.cd{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:8px;position:relative;min-height:32px;transition:background .12s;}
.cd.today{background:var(--asoft);}
.cd.today .cn{color:var(--accent);font-weight:700;}
.cd.om .cn{color:var(--dim);}
.cd.has-sess{cursor:default;}
.cd.has-sess:hover{background:var(--surface2);}
.cd.today.has-sess:hover{background:var(--aglow);}
.cn{font-size:.78rem;font-weight:500;line-height:1;}
.cdots{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap;justify-content:center;max-width:28px;}
.dot{width:5px;height:5px;border-radius:50%;}
.dot.h{background:var(--green);}
.dot.p{background:var(--blue);}
.dot.s{background:var(--dim);}

/* ‚îÄ‚îÄ Calendar Tooltip ‚îÄ‚îÄ */
.cal-tooltip{
  position:fixed;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:.75rem 1rem;
  box-shadow:var(--shadowlg);
  z-index:9999;
  pointer-events:none;
  min-width:170px;
  max-width:240px;
  font-size:.8rem;
  opacity:0;
  transform:translateY(4px);
  transition:opacity .15s,transform .15s;
}
.cal-tooltip.show{opacity:1;transform:translateY(0);}
.cal-tooltip .tt-date{
  font-size:.62rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.08em;color:var(--muted);margin-bottom:.5rem;
}
.cal-tooltip .tt-row{
  display:flex;align-items:center;gap:.55rem;
  padding:.22rem 0;border-bottom:1px solid var(--border);
}
.cal-tooltip .tt-row:last-child{border-bottom:none;}
.cal-tooltip .tt-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.cal-tooltip .tt-info{display:flex;flex-direction:column;gap:.06rem;flex:1;}
.cal-tooltip .tt-name{font-weight:600;font-size:.8rem;}
.cal-tooltip .tt-meta{font-size:.68rem;color:var(--muted);display:flex;gap:.4rem;}

.pend-item{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:var(--surface2);border-radius:var(--r);font-size:.84rem;border:1px solid var(--border);margin-bottom:.5rem;}
.pdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}

.out-item{display:flex;align-items:center;justify-content:space-between;padding:.6rem 0;border-bottom:1px solid var(--border);}
.out-item:last-child{border-bottom:none;}
.out-amt{font-family:'DM Mono',monospace;font-size:.95rem;color:var(--amber);font-weight:500;}
.out-days{font-size:.68rem;color:var(--red);margin-top:.1rem;text-align:right;}

.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:flex;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px);}
.modal{background:var(--surface);border-radius:var(--rl);padding:1.75rem;max-width:420px;width:100%;box-shadow:var(--shadowlg);border:1px solid var(--border);}
.modal h3{font-size:1.1rem;font-weight:700;margin-bottom:1.25rem;}
.mact{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.25rem;}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--surface);border:1px solid var(--border);color:var(--text);padding:.6rem 1.1rem;border-radius:30px;font-size:.84rem;font-weight:500;box-shadow:var(--shadowlg);z-index:9999;opacity:0;transition:all .22s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.ok{border-color:rgba(45,106,79,.4);color:var(--green);}
.toast.err{border-color:rgba(192,57,43,.4);color:var(--red);}

.skel{background:linear-gradient(90deg,var(--surface2) 25%,var(--surface3) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:var(--r);height:44px;margin-bottom:.5rem;}
.empty{text-align:center;padding:2rem 1rem;color:var(--muted);font-size:.84rem;line-height:1.6;}
.empty .ei{font-size:1.8rem;margin-bottom:.6rem;opacity:.5;}

.dash-sec{margin-bottom:1rem;position:relative;}
.drag-hnd{display:none;position:absolute;top:.75rem;right:.75rem;z-index:10;background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:.2rem .4rem;font-size:.75rem;color:var(--muted);cursor:grab;align-items:center;}
.arranging .drag-hnd{display:flex;}
.arranging .dash-sec{cursor:grab;}
.dragging{opacity:.4;}
.drag-over{outline:2px dashed var(--accent);outline-offset:3px;border-radius:var(--rl);}
.arr-banner{background:var(--asoft);border:1px dashed var(--accent);border-radius:var(--r);padding:.5rem 1rem;font-size:.78rem;color:var(--accent);font-weight:600;margin-bottom:.75rem;display:none;text-align:center;}
.arr-banner.show{display:block;}

@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

@media(max-width:600px){
  .htabs{display:none;}
  .bnav{display:grid!important;}
  #app{padding-bottom:75px;}
  .main{padding:1rem;}
  .frow{flex-direction:column;}
  .fg{min-width:100%;}
  .stats{grid-template-columns:repeat(2,1fr);}
  .sval{font-size:1.2rem;}
  .hdr{padding:.7rem 1rem;}
}
</style>
</head>
<body>
<div id="app">
  <div class="hdr">
    <div style="display:flex;align-items:center;gap:1.25rem">
      <h1>üìã Practice</h1>
      <div class="htabs">
        <button class="htab active" onclick="ST('home')">Home</button>
        <button class="htab" onclick="ST('sessions')">Sessions</button>
        <button class="htab" onclick="ST('clients')">Clients</button>
        <button class="htab" onclick="ST('cash')">Cash</button>
        <button class="htab" onclick="ST('bank')">Bank</button>
        <button class="htab" onclick="ST('records')">Records</button>
      </div>
    </div>
    <div class="hdr-right">
      <button class="btn btn-ghost btn-sm" id="undo-btn" onclick="doUndo()" disabled title="Undo">‚Ü© Undo</button>
      <button class="btn btn-ghost btn-sm" id="redo-btn" onclick="doRedo()" disabled title="Redo">‚Ü™ Redo</button>
      <button class="btn btn-outline btn-sm" id="theme-btn" onclick="toggleTheme()">üåô Dark</button>
    </div>
  </div>

  <div class="main">
    <!-- HOME -->
    <div id="tab-home" class="tab active">
      <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:1.25rem">
        <h2 id="dash-title" style="font-size:1.25rem;font-weight:700">Loading‚Ä¶</h2>
        <div style="display:flex;gap:.35rem;align-items:center">
          <button class="cnav" onclick="shiftDM(-1)">‚Äπ</button>
          <button class="cnav" onclick="shiftDM(1)">‚Ä∫</button>
          <button class="cnav" id="arr-btn" onclick="toggleArrange()" style="margin-left:.35rem;font-size:.7rem">‚ú¶ Arrange</button>
        </div>
      </div>
      <div class="stats">
        <div class="sc g"><div class="slabel">Earned</div><div class="sval" id="d-earned">‚Ç™‚Äî</div><div class="ssub">sessions happened</div></div>
        <div class="sc a"><div class="slabel">To collect</div><div class="sval" id="d-collect">‚Ç™‚Äî</div><div class="ssub">not yet received</div></div>
        <div class="sc b"><div class="slabel">Scheduled</div><div class="sval" id="d-sched" style="color:var(--muted)">‚Äî</div><div class="ssub">if all happen</div></div>
      </div>
      <div id="dash-secs"></div>
    </div>

    <!-- SESSIONS -->
    <div id="tab-sessions" class="tab">
      <div class="sh"><h2>Sessions</h2></div>
      <div class="card">
        <div class="ctitle">Log a Session</div>
        <div class="frow">
          <div class="fg"><label>Client</label><select id="s-client"></select></div>
          <div class="fg"><label>Date</label><input type="date" id="s-date"></div>
          <div class="fg" style="flex:0;min-width:160px"><label>Status</label>
            <select id="s-status"><option value="happened">‚úì Happened</option><option value="scheduled">‚ó∑ Scheduled</option></select>
          </div>
          <button class="btn btn-primary" id="add-s-btn" onclick="addSession()">+ Add</button>
        </div>
        <div style="font-size:.7rem;color:var(--dim);margin-top:.5rem">Press Enter to quickly add</div>
      </div>
      <div class="fbar">
        <div class="frow" style="margin-bottom:.5rem">
          <div class="fg" style="min-width:120px"><label>Status</label>
            <select id="f-status" onchange="applySessionFilters()">
              <option value="all">All statuses</option>
              <option value="happened">Happened</option>
              <option value="scheduled">Scheduled</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="fg" style="min-width:120px"><label>Client</label><select id="f-client" onchange="applySessionFilters()"><option value="all">All clients</option></select></div>
          <div class="fg" style="min-width:120px"><label>Type</label>
            <select id="f-type" onchange="applySessionFilters()">
              <option value="all">Cash & Bank</option>
              <option value="cash">Cash only</option>
              <option value="bank">Bank only</option>
            </select>
          </div>
          <div class="fg" style="min-width:120px"><label>Month</label><select id="f-month" onchange="applySessionFilters()"><option value="all">All months</option></select></div>
          <button class="btn btn-ghost btn-sm" onclick="clearSF()" style="align-self:flex-end">‚úï Clear</button>
        </div>
        <div style="font-size:.7rem;color:var(--dim)">Click column headers to sort</div>
      </div>
      <div id="sessions-list" class="card"><div class="skel"></div><div class="skel"></div></div>
    </div>

    <!-- CLIENTS -->
    <div id="tab-clients" class="tab">
      <div class="sh"><h2>Clients</h2></div>
      <div class="card">
        <div class="ctitle">Add Client</div>
        <div class="frow">
          <div class="fg"><label>Name</label><input type="text" id="c-name" placeholder="e.g. Miki"></div>
          <div class="fg"><label>Type</label><select id="c-type"><option value="cash">Cash</option><option value="bank">Bank Transfer</option></select></div>
          <div class="fg"><label>Rate (‚Ç™)</label><input type="number" id="c-rate" placeholder="420"></div>
          <button class="btn btn-primary" onclick="addClient()">+ Add</button>
        </div>
      </div>
      <div class="fbar">
        <div class="frow">
          <div class="fg" style="min-width:120px"><label>Type</label>
            <select id="cf-type" onchange="renderClientsTab()">
              <option value="all">All</option><option value="cash">Cash</option><option value="bank">Bank</option>
            </select>
          </div>
          <div class="fg" style="min-width:120px"><label>Sort</label>
            <select id="cf-sort" onchange="renderClientsTab()">
              <option value="name">Name A‚ÄìZ</option>
              <option value="name-d">Name Z‚ÄìA</option>
              <option value="rate">Rate ‚Üë</option>
              <option value="rate-d">Rate ‚Üì</option>
              <option value="sessions">Sessions ‚Üë</option>
              <option value="sessions-d">Sessions ‚Üì</option>
            </select>
          </div>
        </div>
      </div>
      <div id="clients-list" class="card"><div class="skel"></div></div>
      <div id="archived-sec" style="display:none">
        <div class="sdiv"><span>Archived</span></div>
        <div id="archived-list" class="card"></div>
      </div>
    </div>

    <!-- CASH -->
    <div id="tab-cash" class="tab">
      <div class="sh"><h2>Cash Payments</h2></div>
      <div class="card">
        <div class="ctitle">Record Cash Received</div>
        <p style="font-size:.81rem;color:var(--muted);margin-bottom:1rem;line-height:1.5">Select sessions where you collected cash. You keep 85% ‚Äî VV gets 15%.</p>
        <div id="cash-picker"><div class="skel"></div></div>
        <div class="sumbox" id="cash-sum" style="display:none">
          <div class="si"><span>Sessions</span><strong id="cash-cnt">0</strong></div>
          <div class="si"><span>You Keep (85%)</span><strong id="cash-net" style="color:var(--green)">‚Ç™0</strong></div>
          <div class="si"><span>VV Owed (15%)</span><strong id="cash-vv" style="color:var(--amber)">‚Ç™0</strong></div>
        </div>
        <div class="frow">
          <div class="fg"><label>Date Received</label><input type="date" id="cash-date"></div>
          <button class="btn btn-primary" onclick="recordCash()">Record Payment</button>
        </div>
      </div>
      <div class="sdiv"><span>All cash batches</span></div>
      <div id="cash-batches"><div class="skel"></div></div>
    </div>

    <!-- BANK -->
    <div id="tab-bank" class="tab">
      <div class="sh"><h2>Bank Transfer</h2></div>
      <div class="card">
        <div class="ctitle">Record Bank Transfer Received</div>
        <p style="font-size:.81rem;color:var(--muted);margin-bottom:1rem;line-height:1.5">Select sessions paid by VV via bank transfer.</p>
        <div id="bank-picker"><div class="skel"></div></div>
        <div class="sumbox" id="bank-sum" style="display:none">
          <div class="si"><span>Sessions</span><strong id="bank-cnt">0</strong></div>
          <div class="si"><span>Full Rate</span><strong id="bank-gross">‚Ç™0</strong></div>
          <div class="si"><span>You Get (85%)</span><strong id="bank-net" style="color:var(--green)">‚Ç™0</strong></div>
        </div>
        <div class="frow">
          <div class="fg"><label>Date Received</label><input type="date" id="bank-date"></div>
          <button class="btn btn-primary" onclick="recordBank()">Record Payment</button>
        </div>
      </div>
      <div class="sdiv"><span>All bank transfers</span></div>
      <div id="bank-batches"><div class="skel"></div></div>
    </div>

    <!-- RECORDS -->
    <div id="tab-records" class="tab">
      <div class="sh"><h2>Records</h2></div>
      <div class="fbar">
        <div class="frow">
          <div class="fg" style="min-width:120px"><label>View</label>
            <select id="r-view" onchange="renderRecords()"><option value="batch">All batches</option><option value="month">By month</option></select>
          </div>
          <div class="fg" style="min-width:120px"><label>Type</label>
            <select id="r-type" onchange="renderRecords()"><option value="all">Cash & Bank</option><option value="cash">Cash only</option><option value="bank">Bank only</option></select>
          </div>
          <div class="fg" style="min-width:120px"><label>Status</label>
            <select id="r-status" onchange="renderRecords()"><option value="all">All</option><option value="pending">Pending</option><option value="complete">Completed</option></select>
          </div>
          <div class="fg" style="min-width:120px"><label>Month</label><select id="r-month" onchange="renderRecords()"><option value="all">All months</option></select></div>
          <div class="fg" style="min-width:120px"><label>Sort</label>
            <select id="r-sort" onchange="renderRecords()">
              <option value="date-d">Date ‚Üì</option><option value="date-a">Date ‚Üë</option>
              <option value="amt-d">Amount ‚Üì</option><option value="amt-a">Amount ‚Üë</option>
            </select>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="clearRF()" style="align-self:flex-end">‚úï Clear</button>
        </div>
      </div>
      <div id="records-content"><div class="skel"></div><div class="skel"></div></div>
    </div>
  </div>
</div>

<nav class="bnav">
  <button class="bnav-btn active" id="bn-home" onclick="ST('home')"><span>üè†</span><span>Home</span></button>
  <button class="bnav-btn" id="bn-sessions" onclick="ST('sessions')"><span>üìã</span><span>Sessions</span></button>
  <button class="bnav-btn" id="bn-clients" onclick="ST('clients')"><span>üë§</span><span>Clients</span></button>
  <button class="bnav-btn" id="bn-cash" onclick="ST('cash')"><span>üíµ</span><span>Cash</span></button>
  <button class="bnav-btn" id="bn-bank" onclick="ST('bank')"><span>üè¶</span><span>Bank</span></button>
  <button class="bnav-btn" id="bn-records" onclick="ST('records')"><span>üìÅ</span><span>Records</span></button>
</nav>

<div id="toast" class="toast"></div>

<div id="modal-session" class="modal-bg" style="display:none" onclick="if(event.target===this)closeModal('session')">
  <div class="modal">
    <h3>Edit Session</h3>
    <div class="fg" style="margin-bottom:.75rem"><label>Client</label><select id="es-client"></select></div>
    <div class="fg" style="margin-bottom:.75rem"><label>Date</label><input type="date" id="es-date"></div>
    <div class="fg" style="margin-bottom:.75rem"><label>Status</label>
      <select id="es-status"><option value="happened">‚úì Happened</option><option value="scheduled">‚ó∑ Scheduled</option><option value="paid">‚úì Paid</option></select>
    </div>
    <div class="mact">
      <button class="btn btn-ghost" onclick="closeModal('session')">Cancel</button>
      <button class="btn btn-primary" onclick="saveSessionEdit()">Save</button>
    </div>
  </div>
</div>

<div id="modal-client" class="modal-bg" style="display:none" onclick="if(event.target===this)closeModal('client')">
  <div class="modal">
    <h3>Edit Client</h3>
    <div class="fg" style="margin-bottom:.75rem"><label>Name</label><input type="text" id="ec-name"></div>
    <div class="fg" style="margin-bottom:.75rem"><label>Type</label><select id="ec-type"><option value="cash">Cash</option><option value="bank">Bank Transfer</option></select></div>
    <div class="fg" style="margin-bottom:.75rem"><label>Rate (‚Ç™)</label><input type="number" id="ec-rate"></div>
    <div class="mact">
      <button class="btn btn-ghost" onclick="closeModal('client')">Cancel</button>
      <button class="btn btn-primary" onclick="saveClientEdit()">Save</button>
    </div>
  </div>
</div>

<script>
const SB_URL='https://fxpaacqnsbnbzbcabpvi.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4cGFhY3Fuc2JuYnpiY2FicHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjM0MzgsImV4cCI6MjA4NzY5OTQzOH0.cLIEMR4ZpH3buhMjC8nwHu8h9p-WfHPfNZpHQXua3Oc';
const VV=0.15;
const net=g=>Number(g||0)*(1-VV);
let sb,clients=[],sessions=[];
let calY,calM,dmY,dmM;
let sSortCol='date',sSortDir='desc';
let sFilters={status:'all',client:'all',type:'all',month:'all'};
let editSId=null,editCId=null;
let chart=null;
const undoStack=[],redoStack=[];
let arranging=false,dragSrc=null;
let secOrder=JSON.parse(localStorage.getItem('secOrder')||'null')||['todo','chart','cal','sched'];

window.addEventListener('load',()=>{
  applyTheme(localStorage.getItem('theme')||'light');
  sb=window.supabase.createClient(SB_URL,SB_KEY);
  const now=new Date();
  calY=now.getFullYear();calM=now.getMonth();
  dmY=now.getFullYear();dmM=now.getMonth();
  const t=today();
  ['s-date','cash-date','bank-date'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=t;});
  document.addEventListener('keydown',e=>{
    if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();doUndo();}
    if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();doRedo();}
    if(e.key==='Enter'&&document.getElementById('tab-sessions').classList.contains('active'))addSession();
  });
  document.getElementById('app').style.display='block';
  loadAll();
});

function applyTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t);const b=document.getElementById('theme-btn');if(b)b.textContent=t==='dark'?'‚òÄÔ∏è Light':'üåô Dark';}
function toggleTheme(){applyTheme((document.documentElement.getAttribute('data-theme')||'light')==='dark'?'light':'dark');if(chart)renderChart();}

async function loadAll(){await loadClients();await loadSessions();renderHome();renderSessionsTab();renderClientsTab();}
async function loadClients(){const{data}=await sb.from('clients').select('*').order('name');clients=data||[];fillClientSelects();}
async function loadSessions(){const{data}=await sb.from('sessions').select('*').order('date',{ascending:false});sessions=data||[];}

function fillClientSelects(){
  const active=clients.filter(c=>!c.archived).sort((a,b)=>a.name.localeCompare(b.name));
  ['s-client','es-client'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    el.innerHTML=active.length?active.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''):'<option value="">No clients</option>';
  });
}

const status=s=>{if(s.paid)return'paid';if(s.status)return s.status;return'happened';};
const cname=id=>{const c=clients.find(c=>c.id===id);return c?c.name:'?';};
const crate=id=>{const c=clients.find(c=>c.id===id);return c?Number(c.rate):0;};
const today=()=>new Date().toISOString().split('T')[0];
const fdate=s=>{if(!s)return'‚Äî';return new Date(s+'T12:00:00').toLocaleDateString('en-IL',{day:'numeric',month:'short',year:'numeric'});};
const fdateS=s=>{if(!s)return'‚Äî';return new Date(s+'T12:00:00').toLocaleDateString('en-IL',{day:'numeric',month:'short'});};
const fmonth=(y,m)=>new Date(y,m,1).toLocaleDateString('en-IL',{month:'long',year:'numeric'});
const daysSince=d=>{if(!d)return 0;return Math.floor((new Date()-new Date(d+'T12:00:00'))/(864e5));};

function ST(name){
  document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.htab,.bnav-btn').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+name)?.classList.add('active');
  document.querySelectorAll('.htab').forEach(b=>{if(b.getAttribute('onclick')?.includes("'"+name+"'"))b.classList.add('active');});
  document.getElementById('bn-'+name)?.classList.add('active');
  if(name==='cash'){renderCashPicker();loadCashBatches();}
  if(name==='bank'){renderBankPicker();loadBankBatches();}
  if(name==='home')renderHome();
  if(name==='records')renderRecords();
}

// ‚îÄ‚îÄ‚îÄ UNDO/REDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pushU(action){undoStack.push(action);redoStack.length=0;updUndoBtns();}
function updUndoBtns(){
  const u=document.getElementById('undo-btn'),r=document.getElementById('redo-btn');
  if(u){u.disabled=!undoStack.length;u.style.opacity=undoStack.length?'1':'.4';u.title=undoStack.length?'Undo: '+undoStack[undoStack.length-1].label:'Nothing to undo';}
  if(r){r.disabled=!redoStack.length;r.style.opacity=redoStack.length?'1':'.4';r.title=redoStack.length?'Redo: '+redoStack[redoStack.length-1].label:'Nothing to redo';}
}
async function doUndo(){if(!undoStack.length)return;const a=undoStack.pop();redoStack.push(a);updUndoBtns();await a.undo();toast('Undone: '+a.label,'ok');}
async function doRedo(){if(!redoStack.length)return;const a=redoStack.pop();undoStack.push(a);updUndoBtns();await a.redo();toast('Redone: '+a.label,'ok');}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function shiftDM(d){dmM+=d;if(dmM>11){dmM=0;dmY++;}if(dmM<0){dmM=11;dmY--;}renderHome();}
function shiftCal(d){calM+=d;if(calM>11){calM=0;calY++;}if(calM<0){calM=11;calY--;}renderCal();}

function renderHome(){
  const ms=new Date(dmY,dmM,1).toISOString().split('T')[0];
  const me=new Date(dmY,dmM+1,0).toISOString().split('T')[0];
  const mo=sessions.filter(s=>s.date>=ms&&s.date<=me);
  const earned=mo.filter(s=>['happened','paid'].includes(status(s))).reduce((sum,s)=>sum+net(crate(s.client_id)),0);
  const toCollect=sessions.filter(s=>status(s)==='happened').reduce((sum,s)=>sum+net(crate(s.client_id)),0);
  const sched=mo.filter(s=>status(s)==='scheduled').reduce((sum,s)=>sum+net(crate(s.client_id)),0);
  document.getElementById('dash-title').textContent=fmonth(dmY,dmM);
  document.getElementById('d-earned').textContent='‚Ç™'+Math.round(earned);
  document.getElementById('d-collect').textContent='‚Ç™'+Math.round(toCollect);
  document.getElementById('d-sched').textContent=sched>0?'‚Ç™'+Math.round(sched):'‚Äî';
  if(!document.getElementById('dsec-todo'))buildDashSections();
  renderDashContent();
}

function toggleArrange(){
  arranging=!arranging;
  const btn=document.getElementById('arr-btn');
  btn.textContent=arranging?'‚úì Done':'‚ú¶ Arrange';
  btn.style.color=arranging?'var(--accent)':'';
  const cont=document.getElementById('dash-secs');
  cont.classList.toggle('arranging',arranging);
  document.getElementById('arr-banner')?.classList.toggle('show',arranging);
}

function buildDashSections(){
  const cont=document.getElementById('dash-secs');
  cont.innerHTML=`<div id="arr-banner" class="arr-banner">Drag sections to reorder ‚Ä¢ tap ‚úì Done when finished</div>`+
    secOrder.map(id=>`<div class="dash-sec" id="dsec-${id}" draggable="true" data-sid="${id}"><div class="drag-hnd">‚†ø drag</div>${secHTML(id)}</div>`).join('');
  cont.querySelectorAll('.dash-sec').forEach(el=>{
    el.addEventListener('dragstart',e=>{if(!arranging){e.preventDefault();return;}dragSrc=el;setTimeout(()=>el.classList.add('dragging'),0);});
    el.addEventListener('dragend',()=>{el.classList.remove('dragging');cont.querySelectorAll('.dash-sec').forEach(x=>x.classList.remove('drag-over'));});
    el.addEventListener('dragover',e=>{if(!arranging||!dragSrc||dragSrc===el)return;e.preventDefault();cont.querySelectorAll('.dash-sec').forEach(x=>x.classList.remove('drag-over'));el.classList.add('drag-over');});
    el.addEventListener('drop',e=>{
      if(!arranging||!dragSrc||dragSrc===el)return;e.preventDefault();el.classList.remove('drag-over');
      const ids=[...cont.querySelectorAll('.dash-sec')].map(x=>x.dataset.sid);
      const fi=ids.indexOf(dragSrc.dataset.sid),ti=ids.indexOf(el.dataset.sid);
      ids.splice(fi,1);ids.splice(ti,0,dragSrc.dataset.sid);
      secOrder=ids;localStorage.setItem('secOrder',JSON.stringify(secOrder));
      buildDashSections();
      if(arranging){cont.classList.add('arranging');document.getElementById('arr-banner')?.classList.add('show');}
      renderDashContent();
    });
  });
}

function secHTML(id){
  if(id==='todo')return`<div class="card"><div class="ctitle" style="margin-bottom:.75rem">To do</div><div id="d-todo"><div class="skel"></div></div></div>`;
  if(id==='chart')return`<div class="card"><div class="ctitle">Monthly earnings (net)</div><canvas id="d-chart" height="80"></canvas></div>`;
  if(id==='cal')return`<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem" id="home-grid">
    <div class="cal-wrap">
      <div class="cal-hdr"><button class="cnav" onclick="shiftCal(-1)">‚Äπ</button><span class="cal-title" id="cal-title"></span><button class="cnav" onclick="shiftCal(1)">‚Ä∫</button></div>
      <div class="cal-grid" id="cal-grid"></div>
      <div style="display:flex;gap:1rem;margin-top:.85rem;flex-wrap:wrap">
        <span style="display:flex;align-items:center;gap:.35rem;font-size:.7rem;color:var(--muted)"><span style="width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block"></span>Happened</span>
        <span style="display:flex;align-items:center;gap:.35rem;font-size:.7rem;color:var(--muted)"><span style="width:8px;height:8px;border-radius:50%;background:var(--blue);display:inline-block"></span>Paid</span>
        <span style="display:flex;align-items:center;gap:.35rem;font-size:.7rem;color:var(--muted)"><span style="width:8px;height:8px;border-radius:50%;background:var(--dim);display:inline-block"></span>Scheduled</span>
      </div>
    </div>
    <div><div class="card" style="margin-bottom:0"><div class="ctitle">Outstanding per client</div><div id="d-outstanding"><div class="skel"></div></div></div></div>
  </div>`;
  if(id==='sched')return`<div class="card"><div class="ctitle">Scheduled sessions</div><div id="d-sched-list"><div class="skel"></div></div></div>`;
  return'';
}

function renderDashContent(){renderTodo();renderChart();renderCal();renderOutstanding();renderSchedList();}

async function renderTodo(){
  const el=document.getElementById('d-todo');if(!el)return;
  const hapCash=sessions.filter(s=>status(s)==='happened'&&clients.find(c=>c.id===s.client_id)?.type==='cash');
  const hapBank=sessions.filter(s=>status(s)==='happened'&&clients.find(c=>c.id===s.client_id)?.type==='bank');
  const{data:cp}=await sb.from('cash_payments').select('vv_owed,paid_to_vv').eq('paid_to_vv',false);
  const vvOwed=(cp||[]).reduce((s,p)=>s+Number(p.vv_owed),0);
  const{data:vp}=await sb.from('vv_payments').select('id').eq('receipt_sent',false);
  const noReceipt=(vp||[]).length;
  const items=[];
  if(hapCash.length)items.push({dot:'var(--blue)',text:`${hapCash.length} cash session${hapCash.length>1?'s':''} to record`,tab:'cash'});
  if(hapBank.length)items.push({dot:'var(--accent)',text:`${hapBank.length} bank session${hapBank.length>1?'s':''} waiting for VV`,tab:'bank'});
  if(vvOwed>0)items.push({dot:'var(--amber)',text:`‚Ç™${Math.round(vvOwed)} you owe VV`,tab:'cash'});
  if(noReceipt>0)items.push({dot:'var(--red)',text:`${noReceipt} bank transfer${noReceipt>1?'s':''} need a receipt`,tab:'bank'});
  el.innerHTML=!items.length
    ?`<div class="empty" style="padding:.75rem 0"><div class="ei">‚úÖ</div>All caught up!</div>`
    :items.map(it=>`<div class="pend-item"><div style="display:flex;align-items:center;gap:.6rem"><div class="pdot" style="background:${it.dot}"></div><span>${it.text}</span></div><button class="btn btn-ghost btn-sm" onclick="ST('${it.tab}')">View ‚Üí</button></div>`).join('');
}

function renderChart(){
  const el=document.getElementById('d-chart');if(!el)return;
  const months=[];
  for(let i=5;i>=0;i--){
    let y=dmY,m=dmM-i;if(m<0){m+=12;y--;}
    const ms=new Date(y,m,1).toISOString().split('T')[0];
    const me=new Date(y,m+1,0).toISOString().split('T')[0];
    const label=new Date(y,m,1).toLocaleDateString('en-IL',{month:'short'});
    const earned=sessions.filter(s=>s.date>=ms&&s.date<=me&&['happened','paid'].includes(status(s))).reduce((sum,s)=>sum+net(crate(s.client_id)),0);
    months.push({label,earned:Math.round(earned)});
  }
  const ctx=el.getContext('2d');
  if(chart)chart.destroy();
  const dark=document.documentElement.getAttribute('data-theme')==='dark';
  const g=dark?'#52b788':'#2d6a4f';
  chart=new Chart(ctx,{type:'bar',data:{labels:months.map(m=>m.label),datasets:[{data:months.map(m=>m.earned),backgroundColor:months.map((_,i)=>i===5?g:g+'55'),borderRadius:6,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>'‚Ç™'+c.raw}}},
      scales:{x:{grid:{display:false},ticks:{font:{family:'DM Sans',size:11},color:dark?'#7a7870':'#6b6960'}},
        y:{grid:{color:dark?'#333330':'#e8e7e2'},ticks:{font:{family:'DM Mono',size:10},color:dark?'#7a7870':'#6b6960',callback:v=>'‚Ç™'+v}}}}});
}

// ‚îÄ‚îÄ‚îÄ CALENDAR WITH HOVER TOOLTIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _calTT=null;

function renderCal(){
  const tEl=document.getElementById('cal-title');
  const gEl=document.getElementById('cal-grid');
  if(!tEl||!gEl)return;
  tEl.textContent=fmonth(calY,calM);
  const days=['Su','Mo','Tu','We','Th','Fr','Sa'];
  const first=new Date(calY,calM,1).getDay();
  const dim=new Date(calY,calM+1,0).getDate();
  const td=today();
  let html=days.map(d=>`<div class="cdl">${d}</div>`).join('');
  // previous month filler days
  for(let i=0;i<first;i++){
    const d=new Date(calY,calM,-(first-i-1));
    html+=`<div class="cd om"><span class="cn">${d.getDate()}</span></div>`;
  }
  // actual days
  for(let d=1;d<=dim;d++){
    const ds=`${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const daySessions=sessions.filter(s=>s.date===ds);
    const isT=ds===td;
    const hasSess=daySessions.length>0;
    const dots=daySessions.map(s=>`<span class="dot ${status(s)==='paid'?'p':status(s)==='scheduled'?'s':'h'}"></span>`).join('');
    html+=`<div class="cd${isT?' today':''}${hasSess?' has-sess':''}" data-date="${ds}">` +
      `<span class="cn">${d}</span>` +
      (hasSess?`<div class="cdots">${dots}</div>`:'') +
      `</div>`;
  }
  gEl.innerHTML=html;

  // Create tooltip element once
  if(!_calTT){
    _calTT=document.createElement('div');
    _calTT.className='cal-tooltip';
    document.body.appendChild(_calTT);
  }

  // Attach hover listeners to days that have sessions
  gEl.querySelectorAll('.has-sess').forEach(cell=>{
    const ds=cell.dataset.date;
    cell.addEventListener('mouseenter',e=>showCalTT(e,ds));
    cell.addEventListener('mousemove',e=>posCalTT(e));
    cell.addEventListener('mouseleave',hideCalTT);
  });
}

function showCalTT(e,ds){
  const daySessions=sessions.filter(s=>s.date===ds);
  const d=new Date(ds+'T12:00:00');
  const label=d.toLocaleDateString('en-IL',{weekday:'long',day:'numeric',month:'long'});

  const rows=daySessions.map(s=>{
    const c=clients.find(x=>x.id===s.client_id);
    const st=status(s);
    const dotCol=st==='paid'?'var(--blue)':st==='scheduled'?'var(--dim)':'var(--green)';
    const stLabel=st==='paid'?'Paid':st==='scheduled'?'Scheduled':'Happened';
    const r=c?Math.round(net(c.rate)):0;
    const typeTag=c?(c.type==='cash'?'Cash':'Bank'):'';
    return `<div class="tt-row">
      <span class="tt-dot" style="background:${dotCol}"></span>
      <span class="tt-info">
        <span class="tt-name">${c?c.name:'?'}</span>
        <span class="tt-meta"><span>${stLabel}</span>${r?`<span>‚Ç™${r}</span>`:''}<span style="opacity:.6">${typeTag}</span></span>
      </span>
    </div>`;
  }).join('');

  _calTT.innerHTML=`<div class="tt-date">${label}</div>${rows}`;
  posCalTT(e);
  _calTT.classList.add('show');
}

function posCalTT(e){
  if(!_calTT)return;
  const w=_calTT.offsetWidth||190;
  const h=_calTT.offsetHeight||80;
  const vw=window.innerWidth;
  const vh=window.innerHeight;
  let x=e.clientX+16;
  let y=e.clientY-8;
  if(x+w>vw-12)x=e.clientX-w-10;
  if(y+h>vh-12)y=e.clientY-h-4;
  _calTT.style.left=x+'px';
  _calTT.style.top=y+'px';
}

function hideCalTT(){
  if(_calTT)_calTT.classList.remove('show');
}

function renderOutstanding(){
  const el=document.getElementById('d-outstanding');if(!el)return;
  const unpaid=sessions.filter(s=>status(s)==='happened');
  const byC={};
  unpaid.forEach(s=>{if(!byC[s.client_id])byC[s.client_id]={total:0,count:0,oldest:s.date};byC[s.client_id].total+=net(crate(s.client_id));byC[s.client_id].count++;if(s.date<byC[s.client_id].oldest)byC[s.client_id].oldest=s.date;});
  const entries=Object.entries(byC).map(([id,d])=>({id,name:cname(id),...d})).sort((a,b)=>b.total-a.total);
  if(!entries.length){el.innerHTML=`<div class="empty" style="padding:1rem 0"><div class="ei">‚úÖ</div>All collected!</div>`;return;}
  el.innerHTML=entries.map(e=>{const days=daysSince(e.oldest);return`<div class="out-item"><div><div style="font-weight:600;font-size:.88rem">${e.name}</div><div style="font-size:.72rem;color:var(--muted)">${e.count} session${e.count!==1?'s':''}</div></div><div style="text-align:right"><div class="out-amt">‚Ç™${Math.round(e.total)}</div><div class="out-days">${days>14?days+' days ago':''}</div></div></div>`;}).join('');
}

function renderSchedList(){
  const el=document.getElementById('d-sched-list');if(!el)return;
  const list=sessions.filter(s=>status(s)==='scheduled').sort((a,b)=>a.date<b.date?-1:1);
  if(!list.length){el.innerHTML=`<div class="empty" style="padding:.75rem 0"><div class="ei">üìÖ</div>No scheduled sessions</div>`;return;}
  el.innerHTML=`<div class="tw"><table><thead><tr><th>Date</th><th>Client</th><th>Type</th><th>You'd earn</th><th></th></tr></thead><tbody>${list.map(s=>{
    const c=clients.find(x=>x.id===s.client_id);
    return`<tr><td style="font-family:'DM Mono',monospace;font-size:.77rem;color:var(--muted)">${fdate(s.date)}</td><td><strong>${c?c.name:'‚Äî'}</strong></td><td>${c?(c.type==='cash'?'<span class="badge bc">Cash</span>':'<span class="badge bb">Bank</span>'):''}</td><td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(net(c.rate)):'‚Äî'}</td><td><button class="btn btn-sm btn-ghost" onclick="markHappened('${s.id}')">‚úì Happened</button></td></tr>`;
  }).join('')}</tbody></table></div>`;
}

async function markHappened(id){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  const old=s.status;s.status='happened';
  await sb.from('sessions').update({status:'happened'}).eq('id',id);
  pushU({label:'Mark happened: '+cname(s.client_id),undo:async()=>{s.status=old;await sb.from('sessions').update({status:old}).eq('id',id);renderHome();renderSessionsTab();},redo:async()=>{s.status='happened';await sb.from('sessions').update({status:'happened'}).eq('id',id);renderHome();renderSessionsTab();}});
  toast('Marked as happened ‚úì','ok');renderHome();renderSessionsTab();renderCashPicker();renderBankPicker();
}

// ‚îÄ‚îÄ‚îÄ SESSIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addSession(){
  const cid=document.getElementById('s-client').value;
  const date=document.getElementById('s-date').value;
  const stat=document.getElementById('s-status').value;
  if(!cid||!date){toast('Fill all fields','err');return;}
  const btn=document.getElementById('add-s-btn');btn.textContent='‚Ä¶';btn.disabled=true;
  const{data,error}=await sb.from('sessions').insert({client_id:cid,date,status:stat,paid:false}).select().single();
  btn.textContent='+ Add';btn.disabled=false;
  if(error){toast('Error: '+error.message,'err');return;}
  sessions=[data,...sessions].sort((a,b)=>a.date<b.date?1:-1);
  pushU({label:'Add session: '+cname(cid)+' '+fdateS(date),
    undo:async()=>{await sb.from('sessions').delete().eq('id',data.id);sessions=sessions.filter(s=>s.id!==data.id);renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();},
    redo:async()=>{await sb.from('sessions').insert({...data});sessions=[data,...sessions].sort((a,b)=>a.date<b.date?1:-1);renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();}
  });
  toast(stat==='scheduled'?'Session scheduled ‚ó∑':'Session logged ‚úì','ok');
  renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();
}

async function deleteSession(id){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  const snap={...s};
  await sb.from('sessions').delete().eq('id',id);
  sessions=sessions.filter(x=>x.id!==id);
  pushU({label:'Delete session: '+cname(snap.client_id)+' '+fdateS(snap.date),
    undo:async()=>{await sb.from('sessions').insert(snap);sessions=[snap,...sessions].sort((a,b)=>a.date<b.date?1:-1);renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();},
    redo:async()=>{await sb.from('sessions').delete().eq('id',snap.id);sessions=sessions.filter(s=>s.id!==snap.id);renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();}
  });
  toast('Session deleted','ok');renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();
}

function openSessionEdit(id){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  editSId=id;
  fillClientSelects();
  document.getElementById('es-client').value=s.client_id;
  document.getElementById('es-date').value=s.date;
  document.getElementById('es-status').value=status(s)==='paid'?'paid':(s.status||'happened');
  document.getElementById('modal-session').style.display='flex';
}
async function saveSessionEdit(){
  if(!editSId)return;
  const s=sessions.find(x=>x.id===editSId);if(!s)return;
  const oldSnap={...s};
  const cid=document.getElementById('es-client').value;
  const date=document.getElementById('es-date').value;
  const stat=document.getElementById('es-status').value;
  await sb.from('sessions').update({client_id:cid,date,status:stat}).eq('id',editSId);
  s.client_id=cid;s.date=date;s.status=stat;
  pushU({label:'Edit session',undo:async()=>{Object.assign(s,oldSnap);await sb.from('sessions').update(oldSnap).eq('id',editSId);renderSessionsTab();renderHome();},redo:async()=>{s.client_id=cid;s.date=date;s.status=stat;await sb.from('sessions').update({client_id:cid,date,status:stat}).eq('id',editSId);renderSessionsTab();renderHome();}});
  closeModal('session');toast('Session updated ‚úì','ok');renderSessionsTab();renderHome();
}

async function changeStatus(id,val){
  const s=sessions.find(x=>x.id===id);if(!s)return;
  const old=s.status;s.status=val;
  await sb.from('sessions').update({status:val}).eq('id',id);
  pushU({label:'Status: '+cname(s.client_id)+' '+old+' ‚Üí '+val,undo:async()=>{s.status=old;await sb.from('sessions').update({status:old}).eq('id',id);renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();},redo:async()=>{s.status=val;await sb.from('sessions').update({status:val}).eq('id',id);renderSessionsTab();renderHome();renderCashPicker();renderBankPicker();}});
  toast('Status updated ‚úì','ok');renderHome();renderCashPicker();renderBankPicker();renderSessionsTab();
}

function applySessionFilters(){
  sFilters.status=document.getElementById('f-status')?.value||'all';
  sFilters.client=document.getElementById('f-client')?.value||'all';
  sFilters.type=document.getElementById('f-type')?.value||'all';
  sFilters.month=document.getElementById('f-month')?.value||'all';
  renderSessionsTab();
}
function clearSF(){sFilters={status:'all',client:'all',type:'all',month:'all'};['f-status','f-client','f-type','f-month'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='all';});renderSessionsTab();}
function sortSessions(col){if(sSortCol===col)sSortDir=sSortDir==='asc'?'desc':'asc';else{sSortCol=col;sSortDir=col==='date'?'desc':'asc';}renderSessionsTab();}

function renderSessionsTab(){
  const fc=document.getElementById('f-client');
  if(fc){const active=clients.filter(c=>!c.archived).sort((a,b)=>a.name.localeCompare(b.name));fc.innerHTML='<option value="all">All clients</option>'+active.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');if(sFilters.client!=='all')fc.value=sFilters.client;}
  const fm=document.getElementById('f-month');
  if(fm&&fm.options.length<=1){const months=[...new Set(sessions.map(s=>s.date.substring(0,7)))].sort((a,b)=>b.localeCompare(a));months.forEach(m=>{const[y,mo]=m.split('-');const opt=document.createElement('option');opt.value=m;opt.textContent=new Date(Number(y),Number(mo)-1,1).toLocaleDateString('en-IL',{month:'long',year:'numeric'});fm.appendChild(opt);});}
  const el=document.getElementById('sessions-list');
  let list=[...sessions];
  if(sFilters.status!=='all')list=list.filter(s=>status(s)===sFilters.status);
  if(sFilters.client!=='all')list=list.filter(s=>s.client_id===sFilters.client);
  if(sFilters.type!=='all'){const ids=clients.filter(c=>c.type===sFilters.type).map(c=>c.id);list=list.filter(s=>ids.includes(s.client_id));}
  if(sFilters.month!=='all')list=list.filter(s=>s.date.startsWith(sFilters.month));
  const dir=sSortDir==='asc'?1:-1;
  if(sSortCol==='date')list.sort((a,b)=>(a.date>b.date?1:-1)*dir);
  else if(sSortCol==='client')list.sort((a,b)=>cname(a.client_id).localeCompare(cname(b.client_id))*dir);
  else if(sSortCol==='status'){const o={scheduled:0,happened:1,paid:2};list.sort((a,b)=>((o[status(a)]||0)-(o[status(b)]||0))*dir);}
  const arr=col=>sSortCol===col?(sSortDir==='asc'?' ‚Üë':' ‚Üì'):'';
  const ts='cursor:pointer;user-select:none;';
  if(!list.length){el.innerHTML=`<div class="empty"><div class="ei">üìã</div>No sessions match filters</div>`;return;}
  el.innerHTML=`<div class="tw"><table>
    <thead><tr>
      <th style="${ts}" onclick="sortSessions('date')">Date${arr('date')}</th>
      <th style="${ts}" onclick="sortSessions('client')">Client${arr('client')}</th>
      <th>Type</th><th>You Keep</th>
      <th style="${ts}" onclick="sortSessions('status')">Status${arr('status')}</th>
      <th></th>
    </tr></thead>
    <tbody>${list.map(s=>{
      const c=clients.find(x=>x.id===s.client_id);
      const st=status(s);
      const stBadge=st==='paid'?'<span class="badge bg">‚úì Paid</span>':st==='happened'?'<span class="badge ba">Happened</span>':'<span class="badge bgrey">‚ó∑ Scheduled</span>';
      return`<tr>
        <td style="font-family:'DM Mono',monospace;font-size:.77rem;color:var(--muted)">${fdate(s.date)}</td>
        <td><strong>${c?c.name:'‚Äî'}</strong></td>
        <td>${c?(c.type==='cash'?'<span class="badge bc">Cash</span>':'<span class="badge bb">Bank</span>'):''}</td>
        <td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(net(c.rate)):'‚Äî'}</td>
        <td>${st!=='paid'?`<select onchange="changeStatus('${s.id}',this.value)" style="font-size:.75rem;padding:.25rem .5rem;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);cursor:pointer;width:auto"><option value="scheduled" ${st==='scheduled'?'selected':''}>‚ó∑ Scheduled</option><option value="happened" ${st==='happened'?'selected':''}>‚úì Happened</option></select>`:stBadge}</td>
        <td style="display:flex;gap:.25rem;justify-content:flex-end">
          <button class="edit-btn" onclick="openSessionEdit('${s.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="ico-btn" onclick="deleteSession('${s.id}')" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('')}</tbody></table></div>`;
}

// ‚îÄ‚îÄ‚îÄ CLIENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addClient(){
  const name=document.getElementById('c-name').value.trim();
  const type=document.getElementById('c-type').value;
  const rate=parseFloat(document.getElementById('c-rate').value);
  if(!name||!rate){toast('Fill all fields','err');return;}
  const{data,error}=await sb.from('clients').insert({name,type,rate,archived:false}).select().single();
  if(error){toast('Error: '+error.message,'err');return;}
  clients=[...clients,data].sort((a,b)=>a.name.localeCompare(b.name));
  pushU({label:'Add client: '+name,undo:async()=>{await sb.from('clients').delete().eq('id',data.id);clients=clients.filter(c=>c.id!==data.id);fillClientSelects();renderClientsTab();renderSessionsTab();},redo:async()=>{await sb.from('clients').insert({...data});clients=[...clients,data].sort((a,b)=>a.name.localeCompare(b.name));fillClientSelects();renderClientsTab();}});
  toast('Client added ‚úì','ok');
  document.getElementById('c-name').value='';document.getElementById('c-rate').value='';
  fillClientSelects();renderClientsTab();
}

function openClientEdit(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  editCId=id;
  document.getElementById('ec-name').value=c.name;
  document.getElementById('ec-type').value=c.type;
  document.getElementById('ec-rate').value=c.rate;
  document.getElementById('modal-client').style.display='flex';
}
async function saveClientEdit(){
  if(!editCId)return;
  const c=clients.find(x=>x.id===editCId);if(!c)return;
  const oldSnap={...c};
  const name=document.getElementById('ec-name').value.trim();
  const type=document.getElementById('ec-type').value;
  const rate=parseFloat(document.getElementById('ec-rate').value);
  if(!name||!rate){toast('Fill all fields','err');return;}
  await sb.from('clients').update({name,type,rate}).eq('id',editCId);
  Object.assign(c,{name,type,rate});
  pushU({label:'Edit client: '+name,undo:async()=>{Object.assign(c,oldSnap);await sb.from('clients').update(oldSnap).eq('id',editCId);fillClientSelects();renderClientsTab();renderSessionsTab();renderHome();},redo:async()=>{Object.assign(c,{name,type,rate});await sb.from('clients').update({name,type,rate}).eq('id',editCId);fillClientSelects();renderClientsTab();renderSessionsTab();renderHome();}});
  closeModal('client');toast('Client updated ‚úì','ok');fillClientSelects();renderClientsTab();renderSessionsTab();renderHome();
}

async function archiveClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  await sb.from('clients').update({archived:true}).eq('id',id);c.archived=true;
  pushU({label:'Archive: '+c.name,undo:async()=>{c.archived=false;await sb.from('clients').update({archived:false}).eq('id',id);fillClientSelects();renderClientsTab();},redo:async()=>{c.archived=true;await sb.from('clients').update({archived:true}).eq('id',id);fillClientSelects();renderClientsTab();}});
  toast('Archived ‚Äî click Unarchive to restore','ok');fillClientSelects();renderClientsTab();
}
async function unarchiveClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  await sb.from('clients').update({archived:false}).eq('id',id);c.archived=false;
  pushU({label:'Unarchive: '+c.name,undo:async()=>{c.archived=true;await sb.from('clients').update({archived:true}).eq('id',id);fillClientSelects();renderClientsTab();},redo:async()=>{c.archived=false;await sb.from('clients').update({archived:false}).eq('id',id);fillClientSelects();renderClientsTab();}});
  toast('Client restored ‚úì','ok');fillClientSelects();renderClientsTab();
}
async function deleteClient(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  const sc=sessions.filter(s=>s.client_id===id);
  const msg=sc.length?`Delete ${c.name}? This will also delete their ${sc.length} session${sc.length!==1?'s':''}. Cannot be undone.`:`Delete ${c.name}? Cannot be undone.`;
  if(!confirm(msg))return;
  if(sc.length)await sb.from('sessions').delete().eq('client_id',id);
  await sb.from('clients').delete().eq('id',id);
  clients=clients.filter(c=>c.id!==id);sessions=sessions.filter(s=>s.client_id!==id);
  toast('Client deleted','ok');fillClientSelects();renderClientsTab();renderSessionsTab();renderHome();
}

function renderClientsTab(){
  const tf=document.getElementById('cf-type')?.value||'all';
  const sf=document.getElementById('cf-sort')?.value||'name';
  let active=clients.filter(c=>!c.archived);
  if(tf==='cash')active=active.filter(c=>c.type==='cash');
  if(tf==='bank')active=active.filter(c=>c.type==='bank');
  if(sf==='name')active.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sf==='name-d')active.sort((a,b)=>b.name.localeCompare(a.name));
  else if(sf==='rate')active.sort((a,b)=>Number(a.rate)-Number(b.rate));
  else if(sf==='rate-d')active.sort((a,b)=>Number(b.rate)-Number(a.rate));
  else if(sf==='sessions')active.sort((a,b)=>sessions.filter(s=>s.client_id===a.id).length-sessions.filter(s=>s.client_id===b.id).length);
  else if(sf==='sessions-d')active.sort((a,b)=>sessions.filter(s=>s.client_id===b.id).length-sessions.filter(s=>s.client_id===a.id).length);
  const archived=clients.filter(c=>c.archived);
  const el=document.getElementById('clients-list');
  if(!active.length){el.innerHTML=`<div class="empty"><div class="ei">üë§</div>No active clients</div>`;}
  else el.innerHTML=`<div class="tw"><table><thead><tr><th>Name</th><th>Type</th><th>Rate</th><th>You Keep</th><th>Sessions</th><th></th></tr></thead><tbody>${active.map(c=>{
    const cnt=sessions.filter(s=>s.client_id===c.id).length;
    const unpaid=sessions.filter(s=>s.client_id===c.id&&!s.paid).length;
    return`<tr><td><strong>${c.name}</strong></td><td>${c.type==='cash'?'<span class="badge bc">Cash</span>':'<span class="badge bb">Bank</span>'}</td><td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c.rate}</td><td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${Math.round(net(c.rate))}</td><td><strong>${cnt}</strong>${unpaid>0?` <span style="font-size:.7rem;color:var(--amber)">${unpaid} unpaid</span>`:''}</td><td style="display:flex;gap:.25rem;justify-content:flex-end"><button class="edit-btn" onclick="openClientEdit('${c.id}')">‚úèÔ∏è</button><button class="btn btn-sm btn-ghost" onclick="archiveClient('${c.id}')">Archive</button><button class="ico-btn" onclick="deleteClient('${c.id}')">üóëÔ∏è</button></td></tr>`;
  }).join('')}</tbody></table></div>`;
  const as=document.getElementById('archived-sec');const al=document.getElementById('archived-list');
  if(!archived.length){as.style.display='none';return;}
  as.style.display='block';
  al.innerHTML=`<div class="tw"><table><thead><tr><th>Name</th><th>Type</th><th>Rate</th><th></th></tr></thead><tbody>${archived.map(c=>`<tr><td><strong style="color:var(--muted)">${c.name}</strong></td><td>${c.type==='cash'?'<span class="badge bc">Cash</span>':'<span class="badge bb">Bank</span>'}</td><td style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--muted)">‚Ç™${c.rate}</td><td style="display:flex;gap:.25rem;justify-content:flex-end"><button class="btn btn-sm btn-ghost" onclick="unarchiveClient('${c.id}')">Unarchive</button><button class="ico-btn" onclick="deleteClient('${c.id}')">üóëÔ∏è</button></td></tr>`).join('')}</tbody></table></div>`;
}

// ‚îÄ‚îÄ‚îÄ CASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCashPicker(){
  const el=document.getElementById('cash-picker');if(!el)return;
  const ids=clients.filter(c=>c.type==='cash'&&!c.archived).map(c=>c.id);
  const unpaid=sessions.filter(s=>!s.paid&&status(s)==='happened'&&ids.includes(s.client_id));
  if(!unpaid.length){el.innerHTML=`<div class="empty" style="padding:1.25rem"><div class="ei">‚úì</div>No unpaid cash sessions</div>`;document.getElementById('cash-sum').style.display='none';return;}
  el.innerHTML=`<div class="picker">${unpaid.map(s=>{const c=clients.find(x=>x.id===s.client_id);return`<label class="pitem"><input type="checkbox" value="${s.id}" data-rate="${c?c.rate:0}" onchange="updCashSum()"><span style="font-weight:600">${c?c.name:'?'}</span><span style="color:var(--muted);font-size:.77rem">${fdateS(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(net(c.rate)):'?'} net</span></label>`;}).join('')}</div>`;
  updCashSum();
}
function updCashSum(){
  const checked=[...document.querySelectorAll('#cash-picker input:checked')];
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  document.querySelectorAll('#cash-picker .pitem').forEach(item=>item.classList.toggle('sel',item.querySelector('input').checked));
  document.getElementById('cash-sum').style.display=checked.length?'flex':'none';
  document.getElementById('cash-cnt').textContent=checked.length;
  document.getElementById('cash-net').textContent='‚Ç™'+Math.round(net(gross));
  document.getElementById('cash-vv').textContent='‚Ç™'+Math.round(gross*VV);
}
async function recordCash(){
  const checked=[...document.querySelectorAll('#cash-picker input:checked')];
  if(!checked.length){toast('Select at least one session','err');return;}
  const date=document.getElementById('cash-date').value;if(!date){toast('Select a date','err');return;}
  const sids=checked.map(cb=>cb.value);
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  const{data:batch,error}=await sb.from('cash_payments').insert({date,session_ids:sids,total:gross,vv_owed:gross*VV,paid_to_vv:false}).select().single();
  if(error){toast('Error: '+error.message,'err');return;}
  await sb.from('sessions').update({paid:true}).in('id',sids);
  sids.forEach(id=>{const s=sessions.find(x=>x.id===id);if(s)s.paid=true;});
  pushU({label:'Record cash payment',
    undo:async()=>{await sb.from('sessions').update({paid:false}).in('id',sids);sids.forEach(id=>{const s=sessions.find(x=>x.id===id);if(s)s.paid=false;});await sb.from('cash_payments').delete().eq('id',batch.id);renderCashPicker();loadCashBatches();renderHome();renderSessionsTab();},
    redo:async()=>{const{data:nb}=await sb.from('cash_payments').insert({date,session_ids:sids,total:gross,vv_owed:gross*VV,paid_to_vv:false}).select().single();await sb.from('sessions').update({paid:true}).in('id',sids);sids.forEach(id=>{const s=sessions.find(x=>x.id===id);if(s)s.paid=true;});renderCashPicker();loadCashBatches();renderHome();renderSessionsTab();}
  });
  toast('Cash payment recorded ‚úì','ok');await loadSessions();renderSessionsTab();renderCashPicker();loadCashBatches();renderHome();
}
async function loadCashBatches(){
  const{data}=await sb.from('cash_payments').select('*').order('date',{ascending:false});
  renderCashBatches(data||[]);
}
function renderCashBatches(payments){
  const el=document.getElementById('cash-batches');if(!el)return;
  if(!payments.length){el.innerHTML=`<div class="card"><div class="empty" style="padding:1.25rem">No cash batches yet</div></div>`;return;}
  el.innerHTML=payments.map(p=>{
    const rows=(p.session_ids||[]).map(sid=>{
      const s=sessions.find(x=>x.id===sid);if(!s)return'';
      const c=clients.find(x=>x.id===s.client_id);
      return`<div class="brow"><span style="font-weight:600;min-width:90px">${c?c.name:'?'}</span><span style="color:var(--muted)">${fdateS(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;color:var(--green)">‚Ç™${Math.round(net(crate(s.client_id)))} net</span><button onclick="removeCashSession('${p.id}','${sid}')" style="margin-left:.75rem;background:var(--rsoft);color:var(--red);border:none;padding:.18rem .55rem;font-size:.7rem;border-radius:5px;cursor:pointer;font-weight:600">‚úï remove</button></div>`;
    }).join('');
    return`<div class="bcard" id="cb-${p.id}" style="${p.paid_to_vv?'border-left:3px solid var(--green)':'border-left:3px solid var(--amber)'}">
      <div class="bhdr" onclick="toggleBatch('cb-${p.id}')">
        <div style="display:flex;align-items:center;gap:.85rem;flex:1;flex-wrap:wrap">
          <span style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--muted)">${fdate(p.date)}</span>
          <span style="font-size:.7rem;color:var(--dim)">${p.session_ids.length} session${p.session_ids.length!==1?'s':''}</span>
          <span style="font-family:'DM Mono',monospace;font-size:.95rem;font-weight:500;color:var(--amber)">‚Ç™${Math.round(Number(p.vv_owed))} owed to VV</span>
        </div>
        <div style="display:flex;align-items:center;gap:.65rem;flex-shrink:0">
          <label style="display:flex;align-items:center;gap:.4rem" onclick="event.stopPropagation()">
            <label class="toggle"><input type="checkbox" ${p.paid_to_vv?'checked':''} onchange="toggleCashVV('${p.id}',this.checked)"><span class="tslider"></span></label>
            <span style="font-size:.73rem;color:var(--muted)">${p.paid_to_vv?'Paid VV':'Pending'}</span>
          </label>
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteCashBatch('${p.id}')">üóëÔ∏è Delete</button>
          <span class="bchev">‚ñº</span>
        </div>
      </div>
      <div class="blist">${rows||'<div class="brow" style="color:var(--dim)">No details</div>'}<div class="btotals"><span>Gross: <strong style="font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.total))}</strong></span><span>You kept (85%): <strong style="color:var(--green);font-family:'DM Mono',monospace">‚Ç™${Math.round(net(Number(p.total)))}</strong></span><span>VV owed (15%): <strong style="color:var(--amber);font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.vv_owed))}</strong></span></div></div>
    </div>`;
  }).join('');
}
function toggleBatch(id){document.getElementById(id)?.classList.toggle('open');}
async function toggleCashVV(id,v){await sb.from('cash_payments').update({paid_to_vv:v}).eq('id',id);toast(v?'Marked paid to VV ‚úì':'Marked pending','ok');loadCashBatches();renderHome();}
async function deleteCashBatch(id){
  const{data:b}=await sb.from('cash_payments').select('*').eq('id',id).single();if(!b)return;
  if(!confirm('Delete this batch? Sessions will go back to unpaid.'))return;
  await sb.from('sessions').update({paid:false}).in('id',b.session_ids);
  b.session_ids.forEach(sid=>{const s=sessions.find(x=>x.id===sid);if(s)s.paid=false;});
  await sb.from('cash_payments').delete().eq('id',id);
  pushU({label:'Delete cash batch',undo:async()=>{await sb.from('cash_payments').insert(b);await sb.from('sessions').update({paid:true}).in('id',b.session_ids);b.session_ids.forEach(sid=>{const s=sessions.find(x=>x.id===sid);if(s)s.paid=true;});loadCashBatches();renderCashPicker();renderHome();},redo:async()=>{await sb.from('sessions').update({paid:false}).in('id',b.session_ids);b.session_ids.forEach(sid=>{const s=sessions.find(x=>x.id===sid);if(s)s.paid=false;});await sb.from('cash_payments').delete().eq('id',id);loadCashBatches();renderCashPicker();renderHome();}});
  toast('Batch deleted ‚úì','ok');renderCashPicker();loadCashBatches();renderHome();renderSessionsTab();
}
async function removeCashSession(batchId,sid){
  const{data:b}=await sb.from('cash_payments').select('*').eq('id',batchId).single();if(!b)return;
  const newIds=b.session_ids.filter(x=>x!==sid);
  await sb.from('sessions').update({paid:false}).eq('id',sid);
  const s=sessions.find(x=>x.id===sid);if(s)s.paid=false;
  if(!newIds.length){await sb.from('cash_payments').delete().eq('id',batchId);toast('Removed ‚Äî empty batch deleted ‚úì','ok');}
  else{const g=newIds.reduce((sum,id)=>{const ss=sessions.find(x=>x.id===id);return sum+(ss?crate(ss.client_id):0);},0);await sb.from('cash_payments').update({session_ids:newIds,total:g,vv_owed:g*VV}).eq('id',batchId);toast('Session removed ‚úì','ok');}
  renderCashPicker();loadCashBatches();renderHome();renderSessionsTab();
}

// ‚îÄ‚îÄ‚îÄ BANK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBankPicker(){
  const el=document.getElementById('bank-picker');if(!el)return;
  const ids=clients.filter(c=>c.type==='bank'&&!c.archived).map(c=>c.id);
  const unpaid=sessions.filter(s=>!s.paid&&status(s)==='happened'&&ids.includes(s.client_id));
  if(!unpaid.length){el.innerHTML=`<div class="empty" style="padding:1.25rem"><div class="ei">‚úì</div>No pending bank sessions</div>`;document.getElementById('bank-sum').style.display='none';return;}
  el.innerHTML=`<div class="picker">${unpaid.map(s=>{const c=clients.find(x=>x.id===s.client_id);return`<label class="pitem"><input type="checkbox" value="${s.id}" data-rate="${c?c.rate:0}" onchange="updBankSum()"><span style="font-weight:600">${c?c.name:'?'}</span><span style="color:var(--muted);font-size:.77rem">${fdateS(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${c?Math.round(net(c.rate)):'?'} net</span></label>`;}).join('')}</div>`;
  updBankSum();
}
function updBankSum(){
  const checked=[...document.querySelectorAll('#bank-picker input:checked')];
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  document.querySelectorAll('#bank-picker .pitem').forEach(item=>item.classList.toggle('sel',item.querySelector('input').checked));
  document.getElementById('bank-sum').style.display=checked.length?'flex':'none';
  document.getElementById('bank-cnt').textContent=checked.length;
  document.getElementById('bank-gross').textContent='‚Ç™'+Math.round(gross);
  document.getElementById('bank-net').textContent='‚Ç™'+Math.round(net(gross));
}
async function recordBank(){
  const checked=[...document.querySelectorAll('#bank-picker input:checked')];
  if(!checked.length){toast('Select at least one session','err');return;}
  const date=document.getElementById('bank-date').value;if(!date){toast('Select a date','err');return;}
  const sids=checked.map(cb=>cb.value);
  let gross=0;checked.forEach(cb=>gross+=parseFloat(cb.dataset.rate||0));
  const{data:batch,error}=await sb.from('vv_payments').insert({date,session_ids:sids,total:gross,you_get:net(gross),receipt_sent:false}).select().single();
  if(error){toast('Error: '+error.message,'err');return;}
  await sb.from('sessions').update({paid:true}).in('id',sids);
  sids.forEach(id=>{const s=sessions.find(x=>x.id===id);if(s)s.paid=true;});
  pushU({label:'Record bank transfer',
    undo:async()=>{await sb.from('sessions').update({paid:false}).in('id',sids);sids.forEach(id=>{const s=sessions.find(x=>x.id===id);if(s)s.paid=false;});await sb.from('vv_payments').delete().eq('id',batch.id);renderBankPicker();loadBankBatches();renderHome();renderSessionsTab();},
    redo:async()=>{const{data:nb}=await sb.from('vv_payments').insert({date,session_ids:sids,total:gross,you_get:net(gross),receipt_sent:false}).select().single();await sb.from('sessions').update({paid:true}).in('id',sids);sids.forEach(id=>{const s=sessions.find(x=>x.id===id);if(s)s.paid=true;});renderBankPicker();loadBankBatches();renderHome();renderSessionsTab();}
  });
  toast('Bank transfer recorded ‚úì','ok');await loadSessions();renderSessionsTab();renderBankPicker();loadBankBatches();renderHome();
}
async function loadBankBatches(){
  const{data}=await sb.from('vv_payments').select('*').order('date',{ascending:false});
  renderBankBatches(data||[]);
}
function renderBankBatches(payments){
  const el=document.getElementById('bank-batches');if(!el)return;
  if(!payments.length){el.innerHTML=`<div class="card"><div class="empty" style="padding:1.25rem">No bank transfers yet</div></div>`;return;}
  el.innerHTML=payments.map(p=>{
    const names=[...new Set((p.session_ids||[]).map(sid=>{const s=sessions.find(x=>x.id===sid);return s?cname(s.client_id):null;}).filter(Boolean))].join(', ');
    const rows=(p.session_ids||[]).map(sid=>{
      const s=sessions.find(x=>x.id===sid);if(!s)return'';
      const c=clients.find(x=>x.id===s.client_id);
      return`<div class="brow"><span style="font-weight:600;min-width:110px">${c?c.name:'?'}</span><span style="color:var(--muted)">${fdateS(s.date)}</span><span style="margin-left:auto;font-family:'DM Mono',monospace;color:var(--green)">‚Ç™${Math.round(net(crate(s.client_id)))} net</span><button onclick="removeBankSession('${p.id}','${sid}')" style="margin-left:.75rem;background:var(--rsoft);color:var(--red);border:none;padding:.18rem .55rem;font-size:.7rem;border-radius:5px;cursor:pointer;font-weight:600">‚úï remove</button></div>`;
    }).join('');
    return`<div class="bcard" id="bb-${p.id}" style="${p.receipt_sent?'border-left:3px solid var(--green)':'border-left:3px solid var(--amber)'}">
      <div class="bhdr" onclick="toggleBatch('bb-${p.id}')">
        <div style="display:flex;align-items:center;gap:.85rem;flex:1;flex-wrap:wrap">
          <span style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--muted)">${fdate(p.date)}</span>
          <span style="font-weight:600;font-size:.88rem">${names||'‚Äî'}</span>
          <span style="font-size:.7rem;color:var(--dim)">${p.session_ids.length} session${p.session_ids.length!==1?'s':''}</span>
        </div>
        <div style="display:flex;align-items:center;gap:.65rem;flex-shrink:0">
          <span style="font-family:'DM Mono',monospace;font-size:.95rem;font-weight:500;color:var(--green)">‚Ç™${Math.round(Number(p.you_get))} net</span>
          <label style="display:flex;align-items:center;gap:.4rem" onclick="event.stopPropagation()">
            <label class="toggle"><input type="checkbox" ${p.receipt_sent?'checked':''} onchange="toggleReceipt('${p.id}',this.checked)"><span class="tslider"></span></label>
            <span style="font-size:.73rem;color:var(--muted)">${p.receipt_sent?'Receipt sent':'No receipt'}</span>
          </label>
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteBankBatch('${p.id}')">üóëÔ∏è Delete</button>
          <span class="bchev">‚ñº</span>
        </div>
      </div>
      <div class="blist">${rows||'<div class="brow" style="color:var(--dim)">No details</div>'}<div class="btotals"><span>Full rate: <strong style="font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.total))}</strong></span><span>You get (85%): <strong style="color:var(--green);font-family:'DM Mono',monospace">‚Ç™${Math.round(Number(p.you_get))}</strong></span></div></div>
    </div>`;
  }).join('');
}
async function toggleReceipt(id,v){await sb.from('vv_payments').update({receipt_sent:v}).eq('id',id);toast(v?'Receipt marked sent ‚úì':'Marked no receipt','ok');loadBankBatches();renderHome();}
async function deleteBankBatch(id){
  const{data:b}=await sb.from('vv_payments').select('*').eq('id',id).single();if(!b)return;
  if(!confirm('Delete this batch? Sessions will go back to unpaid.'))return;
  await sb.from('sessions').update({paid:false}).in('id',b.session_ids);
  b.session_ids.forEach(sid=>{const s=sessions.find(x=>x.id===sid);if(s)s.paid=false;});
  await sb.from('vv_payments').delete().eq('id',id);
  pushU({label:'Delete bank batch',undo:async()=>{await sb.from('vv_payments').insert(b);await sb.from('sessions').update({paid:true}).in('id',b.session_ids);b.session_ids.forEach(sid=>{const s=sessions.find(x=>x.id===sid);if(s)s.paid=true;});loadBankBatches();renderBankPicker();renderHome();},redo:async()=>{await sb.from('sessions').update({paid:false}).in('id',b.session_ids);b.session_ids.forEach(sid=>{const s=sessions.find(x=>x.id===sid);if(s)s.paid=false;});await sb.from('vv_payments').delete().eq('id',id);loadBankBatches();renderBankPicker();renderHome();}});
  toast('Batch deleted ‚úì','ok');renderBankPicker();loadBankBatches();renderHome();renderSessionsTab();
}
async function removeBankSession(batchId,sid){
  const{data:b}=await sb.from('vv_payments').select('*').eq('id',batchId).single();if(!b)return;
  const newIds=b.session_ids.filter(x=>x!==sid);
  await sb.from('sessions').update({paid:false}).eq('id',sid);
  const s=sessions.find(x=>x.id===sid);if(s)s.paid=false;
  if(!newIds.length){await sb.from('vv_payments').delete().eq('id',batchId);toast('Removed ‚Äî empty batch deleted ‚úì','ok');}
  else{const g=newIds.reduce((sum,id)=>{const ss=sessions.find(x=>x.id===id);return sum+(ss?crate(ss.client_id):0);},0);await sb.from('vv_payments').update({session_ids:newIds,total:g,you_get:net(g)}).eq('id',batchId);toast('Session removed ‚úì','ok');}
  renderBankPicker();loadBankBatches();renderHome();renderSessionsTab();
}

// ‚îÄ‚îÄ‚îÄ RECORDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clearRF(){['r-type','r-status','r-month'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='all';});const rv=document.getElementById('r-view');if(rv)rv.value='batch';const rs=document.getElementById('r-sort');if(rs)rs.value='date-d';renderRecords();}
async function renderRecords(){
  const el=document.getElementById('records-content');if(!el)return;
  el.innerHTML='<div class="skel"></div><div class="skel"></div>';
  const{data:cashAll}=await sb.from('cash_payments').select('*').order('date',{ascending:false});
  const{data:bankAll}=await sb.from('vv_payments').select('*').order('date',{ascending:false});
  const rm=document.getElementById('r-month');
  if(rm&&rm.options.length<=1){
    const all=[...(cashAll||[]).map(p=>p.date.substring(0,7)),...(bankAll||[]).map(p=>p.date.substring(0,7))];
    const months=[...new Set(all)].sort((a,b)=>b.localeCompare(a));
    months.forEach(m=>{const[y,mo]=m.split('-');const opt=document.createElement('option');opt.value=m;opt.textContent=new Date(Number(y),Number(mo)-1,1).toLocaleDateString('en-IL',{month:'long',year:'numeric'});rm.appendChild(opt);});
  }
  const view=document.getElementById('r-view')?.value||'batch';
  const typeF=document.getElementById('r-type')?.value||'all';
  const statF=document.getElementById('r-status')?.value||'all';
  const monF=document.getElementById('r-month')?.value||'all';
  const sortF=document.getElementById('r-sort')?.value||'date-d';
  let cash=(cashAll||[]).map(p=>({...p,_t:'cash'}));
  let bank=(bankAll||[]).map(p=>({...p,_t:'bank'}));
  if(typeF==='cash')bank=[];
  if(typeF==='bank')cash=[];
  if(statF==='pending'){cash=cash.filter(p=>!p.paid_to_vv);bank=bank.filter(p=>!p.receipt_sent);}
  if(statF==='complete'){cash=cash.filter(p=>p.paid_to_vv);bank=bank.filter(p=>p.receipt_sent);}
  if(monF!=='all'){cash=cash.filter(p=>p.date.startsWith(monF));bank=bank.filter(p=>p.date.startsWith(monF));}
  if(view==='month'){renderRecordsByMonth(el,cash,bank);}
  else{
    let all=[...cash,...bank];
    if(sortF==='date-d')all.sort((a,b)=>b.date.localeCompare(a.date));
    else if(sortF==='date-a')all.sort((a,b)=>a.date.localeCompare(b.date));
    else if(sortF==='amt-d')all.sort((a,b)=>Number(b.total)-Number(a.total));
    else if(sortF==='amt-a')all.sort((a,b)=>Number(a.total)-Number(b.total));
    renderRecordsByBatch(el,all);
  }
}
function renderRecordsByMonth(el,cash,bank){
  const months={};
  cash.forEach(p=>{const k=p.date.substring(0,7);if(!months[k])months[k]={cash:0,bank:0,cashP:0,bankP:0};months[k].cash+=Number(p.total);if(!p.paid_to_vv)months[k].cashP+=Number(p.total);});
  bank.forEach(p=>{const k=p.date.substring(0,7);if(!months[k])months[k]={cash:0,bank:0,cashP:0,bankP:0};months[k].bank+=Number(p.total);if(!p.receipt_sent)months[k].bankP+=Number(p.total);});
  const keys=Object.keys(months).sort((a,b)=>b.localeCompare(a));
  if(!keys.length){el.innerHTML=`<div class="empty"><div class="ei">üìÅ</div>No records match filters</div>`;return;}
  el.innerHTML=keys.map(k=>{
    const m=months[k];const[y,mo]=k.split('-');
    const totalNet=Math.round(net(m.cash+m.bank));
    const pendingNet=Math.round(net(m.cashP+m.bankP));
    return`<div class="card" style="margin-bottom:.75rem"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem"><div style="font-weight:700;font-size:1rem">${fmonth(Number(y),Number(mo)-1)}</div><div style="text-align:right"><div style="font-family:'DM Mono',monospace;font-size:1rem;font-weight:500;color:var(--green)">‚Ç™${totalNet} <span style="font-size:.7rem;color:var(--muted)">net</span></div>${pendingNet>0?`<div style="font-size:.7rem;color:var(--amber)">‚Ç™${pendingNet} pending</div>`:''}</div></div><div style="display:flex;gap:1.5rem;font-size:.8rem;color:var(--muted);flex-wrap:wrap">${m.cash>0?`<span>üíµ Cash: ‚Ç™${Math.round(net(m.cash))} net${m.cashP>0?` <span style="color:var(--amber)">(‚Ç™${Math.round(net(m.cashP))} pending)</span>`:''}</span>`:''} ${m.bank>0?`<span>üè¶ Bank: ‚Ç™${Math.round(net(m.bank))} net${m.bankP>0?` <span style="color:var(--amber)">(‚Ç™${Math.round(net(m.bankP))} pending)</span>`:''}</span>`:''}</div></div>`;
  }).join('');
}
function renderRecordsByBatch(el,all){
  if(!all.length){el.innerHTML=`<div class="empty"><div class="ei">üìÅ</div>No records match filters</div>`;return;}
  const rows=all.map(p=>{
    const names=[...new Set((p.session_ids||[]).map(sid=>{const s=sessions.find(x=>x.id===sid);return s?cname(s.client_id):null;}).filter(Boolean))].join(', ')||'‚Äî';
    const cnt=(p.session_ids||[]).length;
    const statBadge=p._t==='cash'?(p.paid_to_vv?'<span class="badge bg">VV paid</span>':'<span class="badge ba">VV pending</span>'):(p.receipt_sent?'<span class="badge bg">Receipt sent</span>':'<span class="badge ba">No receipt</span>');
    return`<tr><td style="font-family:'DM Mono',monospace;font-size:.77rem;color:var(--muted)">${fdate(p.date)}</td><td>${p._t==='cash'?'<span class="badge bc">Cash</span>':'<span class="badge bb">Bank</span>'}</td><td style="font-size:.82rem">${names} <span style="color:var(--dim);font-size:.72rem">(${cnt})</span></td><td style="font-family:'DM Mono',monospace;font-size:.78rem">‚Ç™${Math.round(Number(p.total))}</td><td style="font-family:'DM Mono',monospace;font-size:.78rem;color:var(--green)">‚Ç™${Math.round(net(Number(p.total)))}</td><td>${statBadge}</td></tr>`;
  }).join('');
  el.innerHTML=`<div class="tw"><table><thead><tr><th>Date</th><th>Type</th><th>Clients</th><th>Gross</th><th>Net (85%)</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeModal(name){document.getElementById('modal-'+name).style.display='none';}
function toast(msg,type=''){const el=document.getElementById('toast');el.textContent=msg;el.className='toast'+(type?' '+type:'');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3000);}

window.addEventListener('resize',()=>{const g=document.getElementById('home-grid');if(g)g.style.gridTemplateColumns=window.innerWidth<650?'1fr':'1fr 1fr';});
window.dispatchEvent(new Event('resize'));
</script>
</body>
</html>
