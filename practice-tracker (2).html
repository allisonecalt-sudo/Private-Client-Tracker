<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Practice Tracker Pro</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f8f9fa; --surface: #ffffff; --surface2: #f1f3f5; --border: #e9ecef;
  --text: #212529; --text-muted: #6c757d; --accent: #2d6a4f; --accent-soft: rgba(45,106,79,0.1);
  --green: #2d6a4f; --amber: #d9480f; --red: #c92a2a; --blue: #1971c2;
  --radius: 12px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; font-size: 15px; }
.app-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
.main { max-width: 800px; margin: 0 auto; padding: 1.5rem; padding-bottom: 100px; }
.card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1.25rem; box-shadow: var(--shadow); }
.tab-content { display: none; animation: fadeIn 0.2s ease-out; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* UI Components */
.btn { padding: 0.6rem 1.2rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: inherit; display: inline-flex; align-items: center; gap: 0.5rem; }
.btn-primary { background: var(--accent); color: white; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.btn-danger { background: #fff5f5; color: var(--red); }
.badge { padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
.badge-cash { background: #e7f5ff; color: var(--blue); }
.badge-bank { background: #ebfbee; color: var(--green); }
.badge-archived { background: #f1f3f5; color: var(--text-muted); }

/* Forms */
.form-group { margin-bottom: 1rem; flex: 1; min-width: 200px; }
label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 0.4rem; text-transform: uppercase; }
input, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--surface2); font-size: 1rem; outline: none; }
input:focus { border-color: var(--accent); background: white; }

/* Table */
.table-wrap { overflow-x: auto; margin: 0 -1.5rem; padding: 0 1.5rem; }
table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
th { text-align: left; padding: 0.75rem; font-size: 0.75rem; color: var(--text-muted); border-bottom: 2px solid var(--border); }
td { padding: 1rem 0.75rem; border-bottom: 1px solid var(--border); }

/* Nav */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: grid; grid-template-columns: repeat(5, 1fr); padding: 0.5rem; z-index: 1000; }
.nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; font-size: 0.65rem; color: var(--text-muted); cursor: pointer; }
.nav-btn.active { color: var(--accent); }
.nav-btn span { font-size: 1.2rem; }

.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 0.75rem 1.5rem; border-radius: 50px; font-size: 0.9rem; z-index: 2000; opacity: 0; transition: 0.3s; pointer-events: none; }
.toast.show { opacity: 1; bottom: 100px; }
</style>
</head>
<body>

<div id="toast" class="toast"></div>

<header class="app-header">
  <h2 style="font-size: 1.1rem">Practice Tracker</h2>
  <div id="sync-indicator" style="font-size: 0.7rem; color: var(--green)">‚óè System Ready</div>
</header>

<main class="main">
  <section id="tab-home" class="tab-content active">
    <h3 id="dash-month" style="margin-bottom: 1.5rem">...</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
      <div class="card" style="border-top: 4px solid var(--green); margin-bottom: 0;">
        <label>Net Earned</label>
        <div id="dash-earned" style="font-size: 1.5rem; font-weight: 700; font-family: 'DM Mono'">‚Ç™0</div>
      </div>
      <div class="card" style="border-top: 4px solid var(--amber); margin-bottom: 0;">
        <label>Unpaid</label>
        <div id="dash-unpaid" style="font-size: 1.5rem; font-weight: 700; font-family: 'DM Mono'">‚Ç™0</div>
      </div>
    </div>
    <div id="pending-tasks"></div>
  </section>

  <section id="tab-sessions" class="tab-content">
    <div class="card">
      <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        <div class="form-group"><label>Client</label><select id="session-client"></select></div>
        <div class="form-group"><label>Date</label><input type="date" id="session-date"></div>
        <div class="form-group"><label>Status</label>
          <select id="session-status">
            <option value="happened">‚úì Happened</option>
            <option value="scheduled">‚ó∑ Scheduled</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" style="width: 100%" onclick="addSession()">Log Session</button>
    </div>
    <div id="sessions-list"></div>
  </section>

  <section id="tab-clients" class="tab-content">
    <div class="card">
      <label>Add New Child/Clinic</label>
      <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem">
        <input type="text" id="client-name" placeholder="Name">
        <div style="display: flex; gap: 0.75rem">
          <select id="client-type"><option value="cash">Cash</option><option value="bank">Bank</option></select>
          <input type="number" id="client-rate" placeholder="Rate (‚Ç™)">
        </div>
        <button class="btn btn-primary" onclick="handleClientAdd()">Add Client</button>
      </div>
    </div>
    <div id="clients-list"></div>
  </section>

  <section id="tab-payments" class="tab-content">
      <div class="card">
          <h3>Record Payments</h3>
          <p style="color: var(--text-muted); font-size: 0.9rem">Select "Cash" or "Bank" in the records to mark batches as paid.</p>
          <div id="payment-actions" style="margin-top: 1rem"></div>
      </div>
  </section>
</main>

<nav class="bottom-nav">
  <button class="nav-btn active" onclick="switchTab('home', this)"><span>üè†</span>Home</button>
  <button class="nav-btn" onclick="switchTab('sessions', this)"><span>üìã</span>Log</button>
  <button class="nav-btn" onclick="switchTab('clients', this)"><span>üë§</span>Clients</button>
  <button class="nav-btn" onclick="switchTab('payments', this)"><span>üí∞</span>Pay</button>
</nav>

<script>
const VV_CUT = 0.15;
const NET = (g) => Math.round(Number(g || 0) * 0.85);
let sbClient, clients = [], sessions = [];

// INIT
window.addEventListener('load', () => {
  sbClient = window.supabase.createClient('https://fxpaacqnsbnbzbcabpvi.supabase.co', 'sb_publishable_JTb6iSLPvZVAYhQELImNfQ_4bvD4-Hy');
  document.getElementById('session-date').value = new Date().toISOString().split('T')[0];
  loadAll();
});

async function loadAll() {
  const { data: c } = await sbClient.from('clients').select('*').order('name');
  const { data: s } = await sbClient.from('sessions').select('*').order('date', { ascending: false });
  clients = c || [];
  sessions = s || [];
  renderDashboard();
  renderSessions();
  renderClients();
  populateDropdowns();
}

function switchTab(name, btn) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
}

function populateDropdowns() {
  const sel = document.getElementById('session-client');
  const active = clients.filter(c => c.status !== 'archived');
  sel.innerHTML = active.map(c => `<option value="${c.id}">${c.name} (‚Ç™${c.rate})</option>`).join('');
}

// DASHBOARD LOGIC
function renderDashboard() {
  const month = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
  document.getElementById('dash-month').innerText = month;
  
  const earned = sessions.filter(s => s.paid).reduce((acc, s) => {
      const c = clients.find(cl => cl.id === s.client_id);
      return acc + (c ? NET(c.rate) : 0);
  }, 0);

  const unpaid = sessions.filter(s => !s.paid && s.status === 'happened').reduce((acc, s) => {
      const c = clients.find(cl => cl.id === s.client_id);
      return acc + (c ? NET(c.rate) : 0);
  }, 0);

  document.getElementById('dash-earned').innerText = `‚Ç™${earned}`;
  document.getElementById('dash-unpaid').innerText = `‚Ç™${unpaid}`;
}

// CLIENT LOGIC
async function handleClientAdd() {
    const name = document.getElementById('client-name').value;
    const rate = document.getElementById('client-rate').value;
    const type = document.getElementById('client-type').value;
    if(!name || !rate) return showToast("Enter name and rate");

    await sbClient.from('clients').insert([{ name, rate, type, status: 'active' }]);
    showToast("Client added!");
    loadAll();
}

async function toggleArchive(id, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'archived' : 'active';
    await sbClient.from('clients').update({ status: newStatus }).eq('id', id);
    showToast(newStatus === 'archived' ? "Client archived" : "Client activated");
    loadAll();
}

async function deleteClient(id) {
    if(!confirm("Delete client? Past sessions remain but will lose client name info.")) return;
    await sbClient.from('clients').delete().eq('id', id);
    loadAll();
}

function renderClients() {
    const list = document.getElementById('clients-list');
    list.innerHTML = `<table>
        <thead><tr><th>Name</th><th>Rate</th><th>Status</th><th></th></tr></thead>
        <tbody>${clients.map(c => `
            <tr style="${c.status === 'archived' ? 'opacity: 0.5' : ''}">
                <td><strong>${c.name}</strong><br><span class="badge ${c.type === 'cash' ? 'badge-cash' : 'badge-bank'}">${c.type}</span></td>
                <td>‚Ç™${c.rate}</td>
                <td><button class="btn btn-outline" onclick="toggleArchive('${c.id}', '${c.status}')">${c.status === 'active' ? 'Archive' : 'Activate'}</button></td>
                <td><button class="btn btn-danger" onclick="deleteClient('${c.id}')">üóëÔ∏è</button></td>
            </tr>
        `).join('')}</tbody>
    </table>`;
}

// SESSION LOGIC
async function addSession() {
    const client_id = document.getElementById('session-client').value;
    const date = document.getElementById('session-date').value;
    const status = document.getElementById('session-status').value;
    
    await sbClient.from('sessions').insert([{ client_id, date, status, paid: false }]);
    showToast("Session logged!");
    loadAll();
}

function renderSessions() {
    const list = document.getElementById('sessions-list');
    list.innerHTML = `<div class="table-wrap"><table>
        <thead><tr><th>Client</th><th>Date</th><th>Status</th></tr></thead>
        <tbody>${sessions.slice(0, 15).map(s => {
            const c = clients.find(cl => cl.id === s.client_id);
            return `<tr>
                <td>${c ? c.name : 'Unknown'}</td>
                <td style="font-size: 0.8rem">${s.date}</td>
                <td><span class="badge" style="background: ${s.paid ? '#ebfbee' : '#fff4e6'}; color: ${s.paid ? 'var(--green)' : 'var(--amber)'}">${s.paid ? 'Paid' : (s.status === 'happened' ? 'Unpaid' : 'Scheduled')}</span></td>
            </tr>`;
        }).join('')}</tbody>
    </table></div>`;
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
